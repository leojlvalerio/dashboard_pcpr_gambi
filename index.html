<!DOCTYPE html>
<html lang="pt-br">
<head>
        <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PCPR Pro - Dashboard de Estudos V6.2</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pocketbase/0.21.1/pocketbase.umd.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="bg-slate-50">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;
        const pb = new PocketBase('https://db.iarepositorio.site');
        
        const Icon = ({ name, size = 20, className = "" }) => {
            const spanRef = useRef(null);
            useEffect(() => {
                if (spanRef.current) {
                    spanRef.current.innerHTML = `<i data-lucide="${name}" class="${className}" style="width:${size}px; height:${size}px"></i>`;
                    lucide.createIcons();
                }
            }, [name, className, size]);
            return <span ref={spanRef} style={{ display: 'contents' }}></span>;
        };

        const DEFAULT_TOPICS = {
          crim: [
            "Abolicionismo e direito penal mínimo",
            "Criminologia",
            "Criminologia positivista e ideologia da defesa social",
            "Criminologia: conceito",
            "Criminologia: método",
            "Criminologia: objeto (delito, delinquente, vítima e controle social)",
            "Discursos punitivos",
            "Discursos punitivos: Tolerância zero e Direito penal do inimigo",
            "Escola de Chicago e Teoria da Associação Diferencial",
            "Escolas da criminologia",
            "Escolas da criminologia: Escola liberal clássica",
            "Labelling Approach",
            "Nascimento da criminologia",
            "Nascimento da criminologia: Iluminismo",
            "Política criminal atuarial",
            "Política criminal de drogas",
            "Segurança pública, mídia e criminalidade",
            "Sistema de Justiça Criminal",
            "Sistema de Justiça Criminal: Polícia, Ministério Público e Poder Judiciário",
            "Temas especiais",
            "Temas especiais: White-collar crime",
            "Teoria crítica",
            "Teoria das subculturas criminais",
            "Teoria estrutural-funcionalista do desvio e da anomia",
            "Teorias psicanalíticas da criminalidade e da sociedade punitiva"
          ],
          adm: [
            "Administração Pública e Acesso à Informação",
            "Administração Pública e Acesso à Informação: Lei Geral de Proteção de Dados (Lei 13.709/2018)",
            "Administração Pública e Acesso à Informação: Lei de Acesso à Informação (Lei 12.527/2011)",
            "Agentes públicos",
            "Agentes públicos: cargo, emprego e função públicos",
            "Agentes públicos: espécies e classificação",
            "Agentes públicos: poderes, deveres e prerrogativas",
            "Ato administrativo",
            "Ato administrativo: atributos, extinção, desfazimento e sanatória",
            "Ato administrativo: classificação, espécies e exteriorização",
            "Ato administrativo: conceito, requisitos, perfeição, validade e eficácia",
            "Ato administrativo: vinculação e discricionariedade",
            "Controle e responsabilização da administração",
            "Controle e responsabilização da administração: controle administrativo, judicial e legislativo",
            "Controle e responsabilização da administração: responsabilidade civil do Estado",
            "Direito Administrativo",
            "Direito Administrativo: conceito, fontes e princípios",
            "Direitos do Usuário de Serviços Públicos",
            "Direitos do Usuário de Serviços Públicos: Lei 13.460/2017",
            "Estado, governo e administração pública",
            "Estado, governo e administração pública: conceitos, elementos, poderes e organização",
            "Estado, governo e administração pública: natureza, fins e princípios",
            "Mandado de Segurança",
            "Mandado de Segurança: Individual e Coletivo (Lei 12.016/2009)",
            "Organização administrativa",
            "Organização administrativa da União",
            "Organização administrativa: administração direta e indireta",
            "Organização administrativa: centralização, descentralização, concentração e desconcentração",
            "Poderes administrativos",
            "Poderes administrativos: poder hierárquico e poder disciplinar",
            "Poderes administrativos: poder regulamentar e poder de polícia",
            "Poderes administrativos: poder vinculado e poder discricionário",
            "Probidade Administrativa",
            "Probidade Administrativa: Improbidade Administrativa (Lei 8.429/1992)",
            "Probidade Administrativa: Responsabilização de pessoas jurídicas (Lei 12.846/2013)",
            "Processo Administrativo (Lei 9.784/1999)",
            "Processo Administrativo (Lei 9.784/1999): Instância administrativa",
            "Processo Administrativo (Lei 9.784/1999): Objetivos, fases, espécies e princípios",
            "Processo Administrativo (Lei 9.784/1999): Pedido de reconsideração e recurso hierárquico",
            "Processo Administrativo (Lei 9.784/1999): Prescrição e decadência",
            "Processo Administrativo (Lei 9.784/1999): Processos disciplinares",
            "Processo Administrativo (Lei 9.784/1999): Recursos administrativos",
            "Processo Administrativo (Lei 9.784/1999): Representação e Reclamação",
            "Regime jurídico único",
            "Regime jurídico único: direitos e vantagens",
            "Regime jurídico único: provimento, vacância, remoção, redistribuição e substituição",
            "Regime jurídico único: regime disciplinar",
            "Regime jurídico único: responsabilidade civil, criminal e administrativa",
            "Serviços públicos",
            "Serviços públicos: conceito, classificação, regulamentação e controle",
            "Serviços públicos: delegação (concessão, permissão, autorização)",
            "Serviços públicos: forma, meios e requisitos"
          ],
          civil: [
            "Parte Especial",
            "Parte Especial: Livro III - Do Direito das Coisas",
            "Parte Especial: Livro III - Do Direito das Coisas: Anticrese",
            "Parte Especial: Livro III - Do Direito das Coisas: Direito do Promitente Comprador",
            "Parte Especial: Livro III - Do Direito das Coisas: Direitos Reais",
            "Parte Especial: Livro III - Do Direito das Coisas: Habitação",
            "Parte Especial: Livro III - Do Direito das Coisas: Hipoteca",
            "Parte Especial: Livro III - Do Direito das Coisas: Penhor",
            "Parte Especial: Livro III - Do Direito das Coisas: Posse",
            "Parte Especial: Livro III - Do Direito das Coisas: Propriedade",
            "Parte Especial: Livro III - Do Direito das Coisas: Servidões",
            "Parte Especial: Livro III - Do Direito das Coisas: Superfície",
            "Parte Especial: Livro III - Do Direito das Coisas: Uso",
            "Parte Especial: Livro III - Do Direito das Coisas: Usufruto",
            "Parte Geral",
            "Parte Geral: Livro I - Das Pessoas",
            "Parte Geral: Livro I - Das Pessoas: Domicílio",
            "Parte Geral: Livro I - Das Pessoas: Pessoas Jurídicas",
            "Parte Geral: Livro I - Das Pessoas: Pessoas Naturais",
            "Parte Geral: Livro II - Dos Bens",
            "Parte Geral: Livro II - Dos Bens: Diferentes Classes de Bens",
            "Parte Geral: Livro III - Dos Fatos Jurídicos",
            "Parte Geral: Livro III - Dos Fatos Jurídicos: Atos Ilícitos",
            "Parte Geral: Livro III - Dos Fatos Jurídicos: Atos Jurídicos Lícitos",
            "Parte Geral: Livro III - Dos Fatos Jurídicos: Decadência",
            "Parte Geral: Livro III - Dos Fatos Jurídicos: Negócio Jurídico",
            "Parte Geral: Livro III - Dos Fatos Jurídicos: Prescrição",
            "Parte Geral: Livro III - Dos Fatos Jurídicos: Prova"
          ],
          const: [
            "Classificações das Constituições",
            "Classificações das Constituições: garantia e dirigente",
            "Classificações das Constituições: material e formal",
            "Constituição",
            "Constituição: conceito, objetos e elementos",
            "Constituição: sentido sociológico, político e jurídico",
            "Controle de Constitucionalidade",
            "Controle de Constitucionalidade: Ações específicas: ADI, ADC, ADO, ADPF, Representação Interventiva",
            "Controle de Constitucionalidade: Controle difuso e concentrado",
            "Controle de Constitucionalidade: Evolução no direito comparado e brasileiro",
            "Controle de Constitucionalidade: Formas de inconstitucionalidade e de controle",
            "Controle de Constitucionalidade: Processo de Controle de Normas: natureza, espécies, legitimação, procedimentos, decisão e efeitos",
            "Controle de Constitucionalidade: Teoria geral",
            "Controle de constitucionalidade",
            "Controle de constitucionalidade: arguição de descumprimento de preceito fundamental",
            "Controle de constitucionalidade: conceito e sistemas",
            "Controle de constitucionalidade: inconstitucionalidade por ação e por omissão",
            "Controle de constitucionalidade: sistema brasileiro",
            "Defesa do Estado e das instituições",
            "Defesa do Estado e das instituições: estado de defesa e estado de sítio",
            "Defesa do Estado e das instituições: forças armadas e segurança pública",
            "Direito Constitucional",
            "Direito Constitucional: fontes formais e concepção positiva",
            "Direito Constitucional: natureza, conceito e objeto",
            "Direito Constitucional: perspectivas sociológica, política e jurídica",
            "Direitos e garantias fundamentais",
            "Direitos e garantias fundamentais: direitos políticos e partidos políticos",
            "Direitos e garantias fundamentais: direitos sociais e nacionalidade",
            "Direitos e garantias fundamentais: individuais e coletivos",
            "Direitos e garantias fundamentais: tutela constitucional das liberdades",
            "Emendas à Constituição",
            "Funções essenciais à justiça",
            "Normas constitucionais",
            "Ordem social",
            "Ordem social: base, objetivos e seguridade social",
            "Ordem social: ciência, tecnologia e comunicação social",
            "Ordem social: educação, cultura e desporto",
            "Ordem social: meio ambiente, família, criança, adolescente e idoso",
            "Organização da segurança pública",
            "Organização político-administrativa",
            "Organização político-administrativa: intervenção",
            "Organização político-administrativa: regras de organização e repartição de competências",
            "Poder Executivo",
            "Poder Executivo: atribuições e responsabilidades do Presidente da República",
            "Poder Executivo: chefia de Estado e chefia de governo",
            "Poder Executivo: forma e sistema de governo",
            "Poder Judiciário",
            "Poder Judiciário: Superior Tribunal de Justiça e Tribunais Regionais Federais",
            "Poder Judiciário: Tribunais e juízes dos Estados",
            "Poder Judiciário: disposições gerais e Supremo Tribunal Federal",
            "Poder Legislativo",
            "Poder Legislativo: fundamento, atribuições e garantias de independência",
            "Poder constituinte",
            "Poder constituinte: fundamentos",
            "Poder constituinte: originário e derivado",
            "Processo Legislativo",
            "Processo Legislativo: conceito, objetos e atos",
            "Processo Legislativo: espécies normativas e procedimentos",
            "Reforma e revisão constitucionais",
            "Reforma e revisão constitucionais: limitação do poder de revisão"
          ],
          penal: [
            "A Lei Penal",
            "A Lei Penal: Características, fontes, interpretação, vigência, classificação e aplicação",
            "A Lei Penal: Concurso aparente de normas",
            "A Lei Penal: Condições de punibilidade",
            "A Lei Penal: Contagem de prazo",
            "A Lei Penal: Eficácia da sentença estrangeira",
            "A Lei Penal: Imunidade",
            "A Lei Penal: Lei penal no tempo e no espaço",
            "Concurso de Agentes",
            "Concurso de Agentes: Autoria, coautoria e participação",
            "Concurso de Agentes: Circunstâncias incomunicáveis",
            "Concurso de Agentes: Cooperação dolosamente distinta",
            "Concurso de Agentes: Imputação",
            "Concurso de Agentes: Punibilidade no concurso de pessoas",
            "Concurso de Agentes: Relação de causalidade",
            "Concurso de Agentes: Requisitos",
            "Concurso de Agentes: Resultado",
            "Crimes",
            "Crimes: Crimes contra a administração pública",
            "Crimes: Crimes contra a dignidade sexual",
            "Crimes: Crimes contra a família",
            "Crimes: Crimes contra a fé pública",
            "Crimes: Crimes contra a incolumidade pública",
            "Crimes: Crimes contra a organização do trabalho",
            "Crimes: Crimes contra a paz pública",
            "Crimes: Crimes contra a pessoa",
            "Crimes: Crimes contra a propriedade imaterial",
            "Crimes: Crimes contra o Estado Democrático de Direito",
            "Crimes: Crimes contra o patrimônio",
            "Crimes: Crimes contra o sentimento religioso e contra o respeito aos mortos",
            "Culpabilidade",
            "Culpabilidade: Causas de exclusão da culpabilidade",
            "Culpabilidade: Culpabilidade e pena",
            "Culpabilidade: Erro de proibição",
            "Culpabilidade: Exigibilidade de conduta diversa",
            "Culpabilidade: Fundamentos, conceito, evolução, elementos e conteúdo",
            "Culpabilidade: Imputabilidade",
            "Culpabilidade: Potencial consciência da ilicitude",
            "Culpabilidade: Princípio de culpabilidade",
            "Extinção da Punibilidade",
            "Extinção da Punibilidade: Conceito, efeitos, causas gerais e específicas, momentos de ocorrência",
            "Extinção da Punibilidade: Prescrição: conceito, teorias, prazos, termos iniciais, causas suspensivas ou impeditivas, causas interruptivas",
            "Ilicitude",
            "Ilicitude: Causas de exclusão da ilicitude: causas supralegais",
            "Ilicitude: Causas de exclusão da ilicitude: estado de necessidade",
            "Ilicitude: Causas de exclusão da ilicitude: estrito cumprimento do dever legal",
            "Ilicitude: Causas de exclusão da ilicitude: exercício regular de direito",
            "Ilicitude: Causas de exclusão da ilicitude: legítima defesa",
            "Ilicitude: Fundamentos, conceito, evolução, elementos e conteúdo",
            "Lei de Introdução ao Código Penal",
            "Teoria Geral do Crime",
            "Teoria Geral do Crime: Bem jurídico",
            "Teoria Geral do Crime: Classificação de crimes",
            "Teoria Geral do Crime: Conceitos, objeto, sujeitos",
            "Teoria Geral do Crime: Concurso de crimes",
            "Teoria Geral do Crime: Punibilidade",
            "Teoria Geral do Crime: Tempo e lugar do crime",
            "Teoria do Tipo",
            "Teoria do Tipo: Arrependimento posterior",
            "Teoria do Tipo: Consumação e tentativa",
            "Teoria do Tipo: Crime doloso e crime culposo",
            "Teoria do Tipo: Crime impossível",
            "Teoria do Tipo: Crime qualificado pelo resultado e crime preterdoloso",
            "Teoria do Tipo: Crimes comissivos e omissivos",
            "Teoria do Tipo: Desistência voluntária e arrependimento eficaz",
            "Teoria do Tipo: Erro de tipo",
            "Teoria do Tipo: Fato típico",
            "Teoria do Tipo: Iter criminis",
            "Teoria do Tipo: Punibilidade: causas de extinção da punibilidade",
            "Teoria do Tipo: Teorias do tipo"
          ],
          'proc-penal': [
            "Ação civil",
            "Ação penal",
            "Citação e Intimação",
            "Execução: art. 684 do Código de Processo Penal",
            "Inquérito policial: Notitia criminis",
            "Inquérito policial: Termos Circunstanciados",
            "Inquérito policial: aplicação do princípio da insignificância",
            "Inquérito policial: contraditório, ampla defesa e valor probatório",
            "Inquérito policial: discussões doutrinárias e indispensabilidade",
            "Inquérito policial: função de filtro processual",
            "Inquérito policial: poder requisitório",
            "Jurisdição e competência",
            "Prisão e Liberdade Provisória",
            "Processo Comum",
            "Processos dos crimes de responsabilidade dos funcionários públicos",
            "Prova",
            "Questões e Processos Incidentes",
            "Recursos em geral",
            "Sentença",
            "Sujeitos processuais: Assistentes e Auxiliares da Justiça",
            "Sujeitos processuais: Juiz, MP, Acusado e Defensor"
          ],
          dh: [
            "Afirmação histórica dos direitos humanos",
            "Constituição Federal Brasileira (1988)",
            "Convenção contra a Tortura e outros Tratamentos ou Penas Cruéis (1984)",
            "Declaração Universal dos Direitos Humanos (ONU - 1948)",
            "Garantias processuais dos Direitos Humanos",
            "Interpretação e Aplicação dos Tratados Internacionais de Proteção",
            "Natureza Jurídica da incorporação de normas internacionais ao direito brasileiro",
            "Teoria Geral",
            "Teoria Geral: conceito, terminologia, structure e fundamentação"
          ],
          inf: [
            "Classificação de crimes cibernéticos",
            "Classificação de crimes cibernéticos: Crimes cibernéticos impróprios",
            "Classificação de crimes cibernéticos: Crimes cibernéticos próprios",
            "Conceitos básicos de operação com arquivos no sistema operacional Linux (Ubuntu versão 14 ou superior)",
            "Conceitos de web e conectividade",
            "Conceitos de web e conectividade: CGNAT: conceito e características",
            "Conceitos de web e conectividade: DarkWeb e DeepWeb: conceito, conteúdo navegável, formas de navegação, identificação de usuário e anonimato",
            "Conceitos de web e conectividade: Internet Protocol (IP): conceito e características",
            "Conceitos de web e conectividade: Porta lógica: conceito e características",
            "Conceitos de web e conectividade: Rede P2P: conceito e características",
            "Conceitos de web e conectividade: Sistema de Nome de Domínio (DNS): conceito e características",
            "Conceitos de web e conectividade: Virtual Private Network (VPN): conceito e características",
            "Noções de cálculo e organização de dados em planilhas eletrônicas utilizando o LibreOffice-Calc",
            "Noções de escrita e editoração de texto utilizando LibreOffice-Writer",
            "Noções de funcionamento de computadores",
            "Noções de funcionamento de periféricos (impressoras e digitalizadoras)",
            "Noções de trabalho com computadores em rede interna no sistema operacional Ubuntu",
            "Noções de uso de Internet",
            "Noções de uso de Internet: Navegador Firefox no sistema operacional Ubuntu",
            "Noções de uso de Internet: Navegador Google Chrome no sistema operacional Ubuntu",
            "Noções de uso de correio eletrônico no sistema operacional Ubuntu",
            "Noções do sistema operacional Linux (Ubuntu versão 14 ou superior)"
          ],
          'leg-especial': [
            "Abuso de Autoridade (Lei nº 13.869/2019)",
            "Contravenções Penais (Decreto-Lei nº 3688/1941)",
            "Crimes contra a Economia Popular (Lei nº 1.521/1951)",
            "Crimes contra a ordem tributária, econômica e relações de consumo (Lei nº 8.137/1990)",
            "Crimes contra o meio ambiente (Lei nº 9.605/1998)",
            "Crimes de tortura (Lei nº 9.455/1997)",
            "Crimes eleitorais (Lei nº 4.737/1965)",
            "Crimes hediondos (Lei nº 8.072/1990)",
            "Crimes previstos no Código de Trânsito Brasileiro (Lei nº 9.503/1997)",
            "Crimes resultantes de preconceitos de raça ou de cor (Lei nº 7.716/1989)",
            "Código de proteção e defesa do consumidor (Lei nº 8.078/1990)",
            "Estatuto da Criança e do Adolescente (Lei nº 8.069/1990)",
            "Estatuto do Idoso (Lei nº 10.741/2003)",
            "Estatuto do desarmamento (Lei nº 10.826/2003)",
            "Execução Penal (Lei nº 7.210/1984)",
            "Identificação Criminal (Lei nº 12.037/2009)",
            "Interceptação telefônica (Lei nº 9.296/1996)",
            "Juizados especiais (Lei nº 9.099/1995 e Lei nº 10.259/2001)",
            "Lavagem de dinheiro (Lei nº 9.613/1998)",
            "Lei 14.133/2021 (Crimes em licitações e contratos administrativos)",
            "Lei 14.597/2023 (Lei Geral do Esporte)",
            "Lei nº 12.830/2013 Pacote Anticrime",
            "Organização criminosa (Lei nº 12.850/2013)",
            "Prisão Temporária (Lei nº 7.960/89)",
            "Tráfico ilícito e uso indevido de drogas (Lei nº 11.343/2006)",
            "Violência doméstica e familiar contra a mulher (Lei nº 11.340/2006)"
          ],
          port: [
            "Compreensão e interpretação de textos de gêneros variados",
            "Correspondência oficial (conforme Manual de Redação da Presidência da República)",
            "Correspondência oficial (conforme Manual de Redação da Presidência da República): Adequação da linguagem ao tipo de documento",
            "Correspondência oficial (conforme Manual de Redação da Presidência da República): Adequação do formato do texto ao gênero",
            "Correspondência oficial (conforme Manual de Redação da Presidência da República): Aspectos gerais da redação oficial",
            "Correspondência oficial (conforme Manual de Redação da Presidência da República): Finalidade dos expedientes oficiais",
            "Domínio da estrutura morfossintática do período",
            "Domínio da estrutura morfossintática do período: Colocação dos pronomes átonos",
            "Domínio da estrutura morfossintática do período: Concordância verbal e nominal",
            "Domínio da estrutura morfossintática do período: Emprego das classes de palavras",
            "Domínio da estrutura morfossintática do período: Emprego do sinal indicativo de crase",
            "Domínio da estrutura morfossintática do período: Emprego dos sinais de pontuação",
            "Domínio da estrutura morfossintática do período: Regência verbal e nominal",
            "Domínio da estrutura morfossintática do período: Relações de coordenação entre orações e entre termos da oração",
            "Domínio da structure morfossintática do período: Relações de subordinação entre orações e entre termos da oração",
            "Domínio da ortografia oficial",
            "Domínio dos mecanismos de coesão textual",
            "Domínio dos mecanismos de coesão textual: Emprego de elementos de referenciação, substituição e repetição, de conectores e de outros elementos de sequenciação textual",
            "Domínio dos mecanismos de coesão textual: Emprego de tempos e modos verbais",
            "Reconhecimento de tipos e gêneros textuais",
            "Reescrita de frases e parágrafos do texto",
            "Reescrita de frases e parágrafos do texto: Reescrita de textos de diferentes gêneros e níveis de formalidade",
            "Reescrita de frases e parágrafos do texto: Reorganização da structure de orações e de períodos do texto",
            "Reescrita de frases e parágrafos do texto: Significação das palavras",
            "Reescrita de frases e parágrafos do texto: Substituição de palavras ou de trechos de texto"
          ],
          med: [
            "Aspectos médico-legais",
            "Aspectos médico-legais das toxicomanias e da embriaguez",
            "Aspectos médico-legais do aborto, infanticídio e abandono de recém-nascido",
            "Aspectos médico-legais do testemunho, da confissão e da acareação",
            "Aspectos médico-legais dos crimes contra a liberdade sexual",
            "Aspectos médico-legais: sedução, corrupção de menores e ultraje ao pudor",
            "Asfixias",
            "Asfixias: constrição cervical e sufocação",
            "Asfixias: restrição aos movimentos do tórax e modificações do meio ambiente",
            "Avaliação pericial da imputabilidade penal e capacidade civil",
            "Causa jurídica da morte",
            "Causa jurídica da morte: morte súbita e morte suspeita",
            "Conceitos de identidade, identificação e reconhecimento",
            "Corpo de Delito, perícia e peritos",
            "Documentos médico-legais",
            "Doença mental, desenvolvimento incompleto ou retardado e perturbação mental",
            "Exame de locais de crime",
            "Lesões e morte por ação térmica e ação elétrica",
            "Lesões e morte por baropatias e ação química",
            "Medicina Legal",
            "Medicina Legal: conceito, importância e divisões",
            "Principais métodos de identificação",
            "Tanatologia",
            "Tanatologia: comoriência, promoriência e exumação",
            "Tanatologia: conceito e diagnóstico da morte",
            "Tanatologia: fenômenos cadavéricos e cronotanatognose",
            "Traumatologia",
            "Traumatologia: lesões e mortes por ação contundente e armas brancas",
            "Traumatologia: projéteis de arma de fogo comuns e de alta energia"
          ]
        };

        const INITIAL_SUBJECTS = [
          { id: 'crim', name: 'Criminologia', weight: 5, notes: '', logs: [], history: [], topics: DEFAULT_TOPICS['crim'], topicStatuses: {} },
          { id: 'adm', name: 'Direito Administrativo', weight: 15, notes: '', logs: [], history: [], topics: DEFAULT_TOPICS['adm'], topicStatuses: {} },
          { id: 'civil', name: 'Direito Civil', weight: 5, notes: '', logs: [], history: [], topics: DEFAULT_TOPICS['civil'], topicStatuses: {} },
          { id: 'const', name: 'Direito Constitucional', weight: 15, notes: '', logs: [], history: [], topics: DEFAULT_TOPICS['const'], topicStatuses: {} },
          { id: 'penal', name: 'Direito Penal', weight: 15, notes: '', logs: [], history: [], topics: DEFAULT_TOPICS['penal'], topicStatuses: {} },
          { id: 'proc-penal', name: 'Direito Processual Penal', weight: 15, notes: '', logs: [], history: [], topics: DEFAULT_TOPICS['proc-penal'], topicStatuses: {} },
          { id: 'dh', name: 'Direitos Humanos', weight: 5, notes: '', logs: [], history: [], topics: DEFAULT_TOPICS['dh'], topicStatuses: {} },
          { id: 'inf', name: 'Informática', weight: 5, notes: '', logs: [], history: [], topics: DEFAULT_TOPICS['inf'], topicStatuses: {} },
          { id: 'leg-especial', name: 'Legislação Penal Especial', weight: 15, notes: '', logs: [], history: [], topics: DEFAULT_TOPICS['leg-especial'], topicStatuses: {} },
          { id: 'med', name: 'Medicina Legal', weight: 5, notes: '', logs: [], history: [], topics: DEFAULT_TOPICS['med'], topicStatuses: {} },
          { id: 'port', name: 'Português', weight: 10, notes: '', logs: [], history: [], topics: DEFAULT_TOPICS['port'], topicStatuses: {} }
        ];
        
        const getSafeId = (item) => {
            if (item === null || item === undefined) return null;
            if (typeof item === 'object') return String(item.id || item.value || '');
            return String(item);
        };

        function App() {
          const [subjects, setSubjects] = useState(INITIAL_SUBJECTS);
          const [cycleSequence, setCycleSequence] = useState([]);
          const [currentCycleIndex, setCurrentCycleIndex] = useState(0);
          const [goalData, setGoalData] = useState({ totalHours: 100, targetDate: '', startDate: new Date().toISOString() });
          const [activeTab, setActiveTab] = useState('painel');
          const [selectedSubId, setSelectedSubId] = useState(null);
          const [activeModal, setActiveModal] = useState(null);
          const [showFutureRevisions, setShowFutureRevisions] = useState(false);
          const [revFilterType, setRevFilterType] = useState('all');
          
          const defaultRev = { date: '', type: 'completa' };
          const [form, setForm] = useState({ topic: '', time: 0, q: 0, h: 0, studyDate: new Date().toISOString().split('T')[0] });
          const [formRevs, setFormRevs] = useState([{...defaultRev}]);
          
          // ESTADO NOVO: Controle da caixinha de avanço de ciclo
          const [autoAdvance, setAutoAdvance] = useState(true);
          
          const [inlineRevForms, setInlineRevForms] = useState({});

          const [editingTopicIdx, setEditingTopicIdx] = useState(null);
          const [editTopicValue, setEditTopicValue] = useState('');
          const [newTopicValue, setNewTopicValue] = useState('');
          const [selectedToCycle, setSelectedToCycle] = useState({});
          const [cycleBuilderSessions, setCycleBuilderSessions] = useState(20);
          
          useEffect(() => {
            async function loadData() {
              try {
                const record = await pb.collection('estudos').getFirstListItem('');
                if (record) {
                  if (record.subjects && Array.isArray(record.subjects)) {
                      const migrated = record.subjects.map(s => {
                          if (s.id === 'civil' && String(s.name).toLowerCase() === 'civil') {
                              s.name = 'Direito Civil';
                          }
                          if (!s.topics || s.topics.length === 0) {
                              const baseTopics = DEFAULT_TOPICS[s.id] || [];
                              const custom = s.customTopics || [];
                              return { ...s, topics: [...new Set([...baseTopics, ...custom])] };
                          }
                          return s;
                      });
                      setSubjects(migrated);
                  }
                  if (record.cycleSequence && Array.isArray(record.cycleSequence)) {
                      setCycleSequence(record.cycleSequence.map(item => getSafeId(item)).filter(Boolean));
                  }
                  if (record.currentCycleIndex !== undefined) setCurrentCycleIndex(Number(record.currentCycleIndex) || 0);
                  if (record.goalData) setGoalData(record.goalData);
                  else if (record.availableTime) setGoalData(prev => ({...prev, totalHours: Number(record.availableTime)}));
                }
              } catch (e) { console.log("Sem dados na VPS ainda."); }
            }
            loadData();
          }, []);

          useEffect(() => {
            const saveData = async () => {
              try {
                const data = { subjects, cycleSequence, currentCycleIndex, goalData };
                let record;
                try { record = await pb.collection('estudos').getFirstListItem(''); } catch (err) {}

                if (record && record.id) await pb.collection('estudos').update(record.id, data);
                else await pb.collection('estudos').create(data);
              } catch (e) { console.error("Erro ao salvar:", e); }
            };
            const timer = setTimeout(saveData, 800);
            return () => clearTimeout(timer);
          }, [subjects, cycleSequence, currentCycleIndex, goalData]);

          const stats = useMemo(() => {
            let qTotal = 0, hTotal = 0, totalHoursEver = 0, totalHoursGoal = 0;
            const goalStart = new Date(goalData.startDate || 0).getTime();

            (subjects || []).forEach(s => {
              (s.logs || []).forEach(l => {
                const logTimeH = (Number(l.time) || 0) / 60;
                qTotal += (Number(l.q) || 0); hTotal += (Number(l.h) || 0); 
                totalHoursEver += logTimeH;
                if (l.timestamp >= goalStart) totalHoursGoal += logTimeH;
              });
            });
            const weightSum = (subjects || []).reduce((acc, s) => acc + (Number(s.weight) || 0), 0);
            return { accuracy: qTotal > 0 ? (hTotal / qTotal) * 100 : 0, totalHoursEver, totalHoursGoal, weightSum, hTotal, qTotal };
          }, [subjects, goalData]);

          const metrics = useMemo(() => {
            return (subjects || []).map(s => {
              const sSuggested = stats.weightSum > 0 ? (Number(s.weight || 0) / stats.weightSum) * goalData.totalHours : 0;
              let q = 0, h = 0, totalStudyHoursGoal = 0;
              const goalStart = new Date(goalData.startDate || 0).getTime();

              (s.logs || []).forEach(l => {
                  q += Number(l.q) || 0; h += Number(l.h) || 0;
                  if (l.timestamp >= goalStart) totalStudyHoursGoal += (Number(l.time) || 0) / 60;
              });

              const timeRemaining = Math.max(0, sSuggested - totalStudyHoursGoal);
              const statuses = s.topicStatuses || {};
              const unstudiedCount = (s.topics || []).filter(t => statuses[t] !== 'Finalizado' && statuses[t] !== 'Não Estudar').length;

              return { ...s, suggested: sSuggested, perf: q > 0 ? Math.round((h/q)*100) : 0, totalQ: q, totalH: h, totalStudyHoursGoal, timeRemaining, unstudiedCount };
            });
          }, [subjects, stats.weightSum, goalData]);

          const revisionList = useMemo(() => {
            const list = [];
            const today = new Date(); today.setHours(0, 0, 0, 0);

            (subjects || []).forEach(s => {
              (s.logs || []).forEach(l => {
                const revsToProcess = l.revisions && l.revisions.length > 0 ? l.revisions : [];
                if (!l.revisions && l.nextRev) revsToProcess.push({ date: l.nextRev, type: l.nextRevType || 'completa' });

                revsToProcess.forEach(revData => {
                    if (!revData.date) return;
                    const [year, month, day] = revData.date.split('-').map(Number);
                    if (!year) return;
                    const nextRevDate = new Date(year, month - 1, day);
                    const diffDays = Math.ceil((nextRevDate.getTime() - today.getTime()) / (1000 * 60 * 60 * 24));
                    const matchesType = revFilterType === 'all' || revData.type === revFilterType;

                    if ((showFutureRevisions || diffDays <= 0) && matchesType) {
                      list.push({ logId: l.id, subjectId: s.id, subjectName: s.name, topic: l.topic, daysLeft: diffDays, type: revData.type, revDateOrig: revData.date });
                    }
                });
              });
            });
            
            const uniqueRevs = {};
            list.forEach(r => {
                const key = `${r.subjectId}-${r.topic}-${r.type}`;
                if (!uniqueRevs[key] || r.daysLeft < uniqueRevs[key].daysLeft) uniqueRevs[key] = r;
            });

            return Object.values(uniqueRevs).sort((a, b) => a.daysLeft - b.daysLeft);
          }, [subjects, showFutureRevisions, revFilterType]);

          const topicStats = useMemo(() => {
            if (!selectedSubId) return [];
            const sub = (subjects || []).find(s => s.id === selectedSubId);
            if (!sub) return [];
            
            const statsMap = {};
            const statuses = sub.topicStatuses || {};
            
            (sub.topics || []).forEach(t => { 
                statsMap[String(t)] = { topic: String(t), time: 0, q: 0, h: 0, status: statuses[String(t)] || 'Estudar', lastStudyDateObj: null, lastStudyDateStr: '-' }; 
            });

            (sub.logs || []).forEach(log => {
              if (statsMap[String(log.topic)]) {
                statsMap[String(log.topic)].time += Number(log.time) || 0;
                statsMap[String(log.topic)].q += Number(log.q) || 0;
                statsMap[String(log.topic)].h += Number(log.h) || 0;
                
                const dateStr = log.date || '';
                const logDate = dateStr.includes('/') ? new Date(dateStr.split('/').reverse().join('-')) : new Date(log.timestamp || 0);
                
                if (!statsMap[String(log.topic)].lastStudyDateObj || logDate > statsMap[String(log.topic)].lastStudyDateObj) {
                    statsMap[String(log.topic)].lastStudyDateObj = logDate;
                    statsMap[String(log.topic)].lastStudyDateStr = dateStr;
                }
              }
            });
            return Object.values(statsMap).sort((a, b) => String(a.topic).localeCompare(String(b.topic)));
          }, [subjects, selectedSubId]);

          const handleAddSubject = (name) => {
            if (!name?.trim()) return;
            setSubjects([...(subjects || []), { id: `custom-${Date.now()}`, name: name.trim(), weight: 5, notes: '', logs: [], history: [], topics: [], topicStatuses: {} }]);
            setActiveModal(null);
          };

          const handleDeleteSubject = (id) => {
            setSubjects((subjects || []).filter(s => String(s.id) !== String(id))); 
            setCycleSequence((cycleSequence || []).filter(sid => getSafeId(sid) !== String(id)));
          };

          const updateSubject = (id, field, value) => setSubjects((subjects || []).map(s => s.id === id ? { ...s, [field]: value } : s));

          const generateProportionalCycle = () => {
             const selectedIds = Object.keys(selectedToCycle).filter(id => selectedToCycle[id]);
             if(selectedIds.length === 0) return alert("Selecione ao menos uma matéria!");
             
             let totalWeight = 0;
             const selectedSubs = subjects.filter(s => selectedIds.includes(s.id));
             selectedSubs.forEach(s => totalWeight += Number(s.weight));
             
             let newCycle = [];
             
             selectedSubs.forEach(s => {
                 newCycle.push(s.id);
             });

             let remainingSlots = cycleBuilderSessions - newCycle.length;
             if (remainingSlots > 0) {
                 let fractionalParts = selectedSubs.map(s => ({
                     id: s.id,
                     exact: (Number(s.weight) / totalWeight) * remainingSlots
                 }));
                 
                 fractionalParts.forEach(f => {
                     const intPart = Math.floor(f.exact);
                     for(let i=0; i<intPart; i++) newCycle.push(f.id);
                     f.remainder = f.exact - intPart;
                 });
                 
                 let currentLen = newCycle.length;
                 fractionalParts.sort((a, b) => b.remainder - a.remainder);
                 for (let i = 0; i < cycleBuilderSessions - currentLen; i++) {
                     if (fractionalParts[i % fractionalParts.length]) {
                         newCycle.push(fractionalParts[i % fractionalParts.length].id);
                     }
                 }
             } else if (remainingSlots < 0) {
                 newCycle = newCycle.slice(0, cycleBuilderSessions);
             }

             const shuffleAndFix = (arr) => {
                 for (let i = arr.length - 1; i > 0; i--) {
                     const j = Math.floor(Math.random() * (i + 1));
                     [arr[i], arr[j]] = [arr[j], arr[i]];
                 }
                 
                 let maxAttempts = 15;
                 while (maxAttempts > 0) {
                     let hasConsecutive = false;
                     for (let i = 1; i < arr.length; i++) {
                         if (arr[i] === arr[i - 1]) {
                             hasConsecutive = true;
                             let swapIdx = -1;
                             for (let j = 0; j < arr.length; j++) {
                                 if (j !== i && j !== i - 1 && arr[j] !== arr[i] &&
                                    (j === 0 || arr[j-1] !== arr[i]) &&
                                    (j === arr.length - 1 || arr[j+1] !== arr[i])) {
                                     swapIdx = j;
                                     break;
                                 }
                             }
                             if (swapIdx !== -1) [arr[i], arr[swapIdx]] = [arr[swapIdx], arr[i]];
                             else {
                                 const rand = Math.floor(Math.random() * arr.length);
                                 [arr[i], arr[rand]] = [arr[rand], arr[i]];
                             }
                         }
                     }
                     if (!hasConsecutive) break;
                     maxAttempts--;
                 }
                 
                 if (arr.length > 1 && arr[0] === arr[arr.length - 1]) {
                     for (let j = 1; j < arr.length - 1; j++) {
                         if (arr[j] !== arr[0] && arr[j-1] !== arr[0] && arr[j+1] !== arr[0]) {
                             [arr[arr.length - 1], arr[j]] = [arr[j], arr[arr.length - 1]];
                             break;
                         }
                     }
                 }
                 return arr;
             };
             
             setCycleSequence(shuffleAndFix(newCycle));
             setCurrentCycleIndex(0);
          };

          const handleResetGoal = () => {
              setGoalData({...goalData, startDate: new Date().toISOString()});
              alert("Nova meta iniciada! O tempo pendente foi zerado.");
          };

          const handleTopicManage = (action, oldTopic = null, newTopic = null) => {
              setSubjects(prev => prev.map(s => {
                  if (s.id !== selectedSubId) return s;
                  let updatedTopics = [...(s.topics || [])];
                  let updatedStatuses = {...(s.topicStatuses || {})};
                  
                  if (action === 'add' && newTopic) {
                      if (!updatedTopics.includes(newTopic)) updatedTopics.push(newTopic);
                  } else if (action === 'edit' && oldTopic && newTopic) {
                      const idx = updatedTopics.indexOf(oldTopic);
                      if (idx > -1) updatedTopics[idx] = newTopic;
                      if (updatedStatuses[oldTopic]) {
                          updatedStatuses[newTopic] = updatedStatuses[oldTopic];
                          delete updatedStatuses[oldTopic];
                      }
                  } else if (action === 'delete' && oldTopic) {
                      updatedTopics = updatedTopics.filter(t => t !== oldTopic);
                      delete updatedStatuses[oldTopic];
                  }
                  return { ...s, topics: updatedTopics, topicStatuses: updatedStatuses };
              }));
          };

          const updateTopicStatus = (subjectId, topicName, status) => {
            setSubjects(prev => prev.map(s => {
              if (s.id === subjectId) return { ...s, topicStatuses: { ...(s.topicStatuses || {}), [topicName]: status } };
              return s;
            }));
          };

          const advanceCycle = () => {
             if(!cycleSequence || cycleSequence.length === 0) return;
             setCurrentCycleIndex((currentCycleIndex + 1) % cycleSequence.length);
          };

          const registerSession = (id) => {
            if (!form.topic) return alert("Selecione o tópico!");
            const validRevs = formRevs.filter(r => r.date !== '');

            setSubjects(prev => (prev || []).map(s => {
              if (s.id === id) {
                const dateStr = form.studyDate || new Date().toISOString().split('T')[0];
                const studyDateObj = new Date(dateStr + 'T12:00:00');
                
                const newLog = {
                  id: Date.now(), 
                  topic: form.topic, 
                  time: Number(form.time) || 0, 
                  q: Number(form.q) || 0,
                  h: Number(form.h) || 0, 
                  timestamp: Date.now(), 
                  date: studyDateObj.toLocaleDateString('pt-BR'), 
                  revisions: validRevs
                };
                return { ...s, logs: [newLog, ...(s.logs || [])] };
              }
              return s;
            }));

            // VERIFICA SE DEVE AVANÇAR A CATRACA
            if (autoAdvance && cycleSequence && cycleSequence.length > 0) {
                const currentCycleActiveId = getSafeId(cycleSequence[currentCycleIndex]);
                if (String(id) === String(currentCycleActiveId)) {
                    advanceCycle();
                }
            }

            setForm({ topic: '', time: 0, q: 0, h: 0, studyDate: new Date().toISOString().split('T')[0] });
            setFormRevs([{...defaultRev}]);
            setAutoAdvance(true); // Reseta o checkbox para o padrão (marcado)
          };

          const handleInlineRevisionSave = (rev) => {
              const formData = inlineRevForms[rev.logId + rev.revDateOrig] || {};
              
              setSubjects(prev => prev.map(s => {
                  if (s.id === rev.subjectId) {
                      const newLog = {
                          id: Date.now(),
                          topic: rev.topic,
                          time: Number(formData.time) || 0,
                          q: Number(formData.q) || 0,
                          h: Number(formData.h) || 0,
                          timestamp: Date.now(),
                          date: new Date().toLocaleDateString('pt-BR'),
                          isRevision: true, 
                          executedRevType: rev.type,
                          nextRevType: formData.nextType || 'completa',
                          revisions: formData.nextDate ? [{ date: formData.nextDate, type: formData.nextType || 'completa' }] : []
                      };

                      const updatedLogs = (s.logs || []).map(l => {
                          if (l.id === rev.logId && l.revisions) {
                              return { ...l, revisions: l.revisions.filter(r => r.date !== rev.revDateOrig) };
                          }
                          if (l.id === rev.logId && l.nextRev === rev.revDateOrig) {
                              return { ...l, nextRev: '' };
                          }
                          return l;
                      });
                      return { ...s, logs: [newLog, ...updatedLogs] };
                  }
                  return s;
              }));
              setInlineRevForms(prev => { const next = {...prev}; delete next[rev.logId + rev.revDateOrig]; return next; });
          };

          const updateInlineForm = (revKey, field, value) => {
              setInlineRevForms(prev => ({
                  ...prev,
                  [revKey]: { ...(prev[revKey] || { time: '', q: '', h: '', nextDate: '', nextType: 'completa' }), [field]: value }
              }));
          };

          const handleDeleteLog = (subjectId, logId) => {
            setSubjects(prev => prev.map(s => {
              if (s.id === subjectId) return { ...s, logs: (s.logs || []).filter(l => l.id !== logId) }; return s;
            }));
          };

          const backupData = () => {
            const data = { subjects, cycleSequence, currentCycleIndex, goalData, exportDate: new Date().toISOString() };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a'); link.href = url; link.download = `backup_pcpr_v3.3.json`; link.click();
            URL.revokeObjectURL(url);
          };

          const handleRestoreBackup = (e) => {
              const file = e.target.files[0];
              if(!file) return;
              const reader = new FileReader();
              reader.onload = (event) => {
                  try {
                      const data = JSON.parse(event.target.result);
                      if (data.subjects) setSubjects(data.subjects);
                      if (data.cycleSequence) setCycleSequence(data.cycleSequence);
                      if (data.currentCycleIndex !== undefined) setCurrentCycleIndex(data.currentCycleIndex);
                      if (data.goalData) setGoalData(data.goalData);
                      alert("Backup restaurado com sucesso!");
                  } catch(err) { alert("Erro ao ler o arquivo JSON."); }
              };
              reader.readAsText(file);
          };

          const handleReset = () => {
            setSubjects(JSON.parse(JSON.stringify(INITIAL_SUBJECTS)));
            setCycleSequence([]); setCurrentCycleIndex(0); 
            setGoalData({ totalHours: 100, targetDate: '', startDate: new Date().toISOString() });
            setActiveModal(null); 
          };

          const sortedSubjects = useMemo(() => {
              return [...(subjects || [])].sort((a, b) => String(a.name).localeCompare(String(b.name)));
          }, [subjects]);

          const safeCycleArr = cycleSequence || [];
          const cycleActiveId = getSafeId(safeCycleArr[currentCycleIndex]);
          const currentSubInCycle = (subjects || []).find(s => String(s.id) === cycleActiveId);
          const currentSubject = (subjects || []).find(s => String(s.id) === String(selectedSubId));

          return (
            <div className="min-h-screen bg-slate-50 text-slate-900 flex flex-col md:flex-row font-sans relative overflow-x-hidden">
              
              {/* MODAIS */}
              {activeModal === 'add' && (
                <div className="fixed inset-0 z-[100] flex items-center justify-center bg-slate-950/60 backdrop-blur-sm p-4">
                  <div className="bg-white rounded-[32px] p-10 w-full max-w-md shadow-2xl animate-in zoom-in duration-200">
                    <h3 className="text-2xl font-black uppercase tracking-tighter mb-6">Nova Disciplina</h3>
                    <input autoFocus type="text" id="subInput" placeholder="Ex: Medicina Legal" className="w-full bg-slate-100 p-5 rounded-2xl text-sm font-bold border-none outline-none focus:ring-2 ring-blue-500 mb-8" onKeyDown={(e) => { if(e.key === 'Enter') handleAddSubject(e.target.value); }} />
                    <div className="flex gap-4">
                      <button onClick={() => handleAddSubject(document.getElementById('subInput').value)} className="flex-1 bg-blue-600 text-white py-4 rounded-2xl font-black uppercase tracking-widest text-xs cursor-pointer">Adicionar</button>
                      <button onClick={() => setActiveModal(null)} className="flex-1 bg-slate-100 text-slate-500 py-4 rounded-2xl font-black uppercase tracking-widest text-xs cursor-pointer">Cancelar</button>
                    </div>
                  </div>
                </div>
              )}
              {activeModal === 'reset' && (
                <div className="fixed inset-0 z-[100] flex items-center justify-center bg-slate-950/60 backdrop-blur-sm p-4">
                  <div className="bg-white rounded-[32px] p-10 w-full max-w-md shadow-2xl animate-in zoom-in duration-200 text-center">
                    <div className="bg-red-50 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-6"><Icon name="alert-triangle" className="text-red-600" size={40} /></div>
                    <h3 className="text-2xl font-black uppercase tracking-tighter mb-4">Zerar Tudo?</h3>
                    <div className="flex gap-4">
                      <button onClick={handleReset} className="flex-1 bg-red-600 text-white py-4 rounded-2xl font-black uppercase tracking-widest text-xs cursor-pointer">Sim, Limpar</button>
                      <button onClick={() => setActiveModal(null)} className="flex-1 bg-slate-100 text-slate-500 py-4 rounded-2xl font-black uppercase tracking-widest text-xs cursor-pointer">Cancelar</button>
                    </div>
                  </div>
                </div>
              )}

              {/* BARRA LATERAL (MENU) */}
              <aside className="fixed bottom-0 left-0 w-full bg-white border-t border-slate-200 flex flex-row justify-around items-center z-50 h-20 md:static md:w-72 md:h-screen md:flex-col md:justify-start md:border-t-0 md:border-r md:shrink-0 overflow-y-auto shadow-[0_-10px_40px_rgba(0,0,0,0.05)] md:shadow-none">
                  <div className="hidden md:flex p-8 border-b border-slate-100 items-center gap-4 w-full">
                      <div className="bg-blue-600 p-2.5 rounded-xl text-white shadow-lg"><Icon name="target" size={24} /></div>
                      <div><h1 className="font-black text-xl text-blue-600 uppercase leading-none tracking-tighter">PCPR Pro</h1><p className="text-[10px] font-bold text-slate-400 uppercase tracking-widest mt-1">Delegado V6.2</p></div>
                  </div>
                  <nav className="flex flex-row md:flex-col p-2 md:p-4 gap-2 md:space-y-2 w-full justify-around md:justify-start">
                      <button onClick={() => setActiveTab('painel')} className={`flex flex-col md:flex-row items-center gap-1 md:gap-3 p-2 md:px-5 md:py-4 rounded-2xl transition-all cursor-pointer ${activeTab === 'painel' ? 'text-blue-600 md:bg-blue-600 md:text-white md:shadow-xl font-bold' : 'text-slate-500 hover:bg-slate-50'}`}><Icon name="play-circle" size={24} className="md:w-5 md:h-5" /> <span className="text-[10px] md:text-sm font-bold uppercase md:capitalize tracking-widest mt-1 md:mt-0">Painel</span></button>
                      <button onClick={() => setActiveTab('planejamento')} className={`flex flex-col md:flex-row items-center gap-1 md:gap-3 p-2 md:px-5 md:py-4 rounded-2xl transition-all cursor-pointer ${activeTab === 'planejamento' ? 'text-indigo-600 md:bg-indigo-600 md:text-white md:shadow-xl font-bold' : 'text-slate-500 hover:bg-slate-50'}`}><Icon name="compass" size={24} className="md:w-5 md:h-5" /> <span className="text-[10px] md:text-sm font-bold uppercase md:capitalize tracking-widest mt-1 md:mt-0">Estratégia</span></button>
                      <button onClick={() => setActiveTab('revisoes')} className={`flex flex-col md:flex-row items-center gap-1 md:gap-3 p-2 md:px-5 md:py-4 rounded-2xl transition-all cursor-pointer relative ${activeTab === 'revisoes' ? 'text-amber-500 md:bg-amber-500 md:text-white md:shadow-xl font-bold' : 'text-slate-500 hover:bg-slate-50'}`}>
                          <Icon name="clock" size={24} className="md:w-5 md:h-5" /> <span className="text-[10px] md:text-sm font-bold uppercase md:capitalize tracking-widest mt-1 md:mt-0">Revisões</span>
                      </button>

                      <div className="hidden md:block pt-6 pb-2 px-5 text-[10px] font-black text-slate-400 uppercase tracking-widest">Matérias</div>
                      {sortedSubjects.map(s => (
                          <button key={s.id} onClick={() => { setSelectedSubId(s.id); setActiveTab('materia'); }} className={`hidden md:flex w-full text-left px-5 py-3 rounded-xl text-xs font-bold transition-all items-center justify-between cursor-pointer ${selectedSubId === s.id && activeTab === 'materia' ? 'bg-slate-100 text-slate-800 border-l-4 border-slate-600' : 'text-slate-500 hover:bg-slate-50 border-l-4 border-transparent'}`}>
                              <span className="truncate pr-2">{String(s.name)}</span>{cycleActiveId === String(s.id) && <Icon name="zap" size={12} className="text-amber-500" />}
                          </button>
                      ))}
                  </nav>
              </aside>

              <main className="flex-1 p-4 md:p-8 overflow-y-auto bg-slate-50 pb-28 md:pb-8">
                
                {/* ABA PAINEL (EXECUÇÃO) */}
                {activeTab === 'painel' && (
                  <div className="max-w-5xl mx-auto space-y-8 animate-in fade-in duration-500">
                    {cycleSequence.length > 0 ? (
                        <div className="bg-white rounded-[32px] md:rounded-[40px] border border-slate-200 shadow-xl shadow-slate-200/40 overflow-hidden">
                            <div className="bg-gradient-to-br from-blue-700 to-indigo-900 p-8 md:p-12 text-white relative">
                                <Icon name="zap" className="absolute -right-4 -bottom-4 opacity-10 text-white" size={180} />
                                <div className="relative z-10 flex flex-col md:flex-row md:items-center justify-between gap-6">
                                    <div>
                                        <div className="flex items-center gap-3 mb-4">
                                            <span className="bg-white/20 px-3 py-1 rounded-full text-[10px] font-black uppercase tracking-widest">Sessão {currentCycleIndex + 1} de {cycleSequence.length}</span>
                                            <span className="text-blue-200 text-xs font-bold">Ciclo Ativo</span>
                                        </div>
                                        <h2 className="text-4xl md:text-5xl font-black uppercase tracking-tighter leading-none">{currentSubInCycle?.name || 'Matéria Excluída'}</h2>
                                    </div>
                                    <div className="flex flex-col sm:flex-row gap-3 w-full md:w-auto shrink-0 mt-4 md:mt-0">
                                        <button onClick={() => { setSelectedSubId(currentSubInCycle.id); setActiveTab('materia'); }} className="bg-white text-blue-700 px-8 py-4 rounded-2xl font-black uppercase tracking-widest text-xs shadow-lg hover:scale-105 active:scale-95 transition-all flex items-center justify-center gap-2 cursor-pointer"><Icon name="play" size={16}/> Ir para Matéria</button>
                                        <button onClick={advanceCycle} className="bg-blue-800/50 hover:bg-blue-900 text-white px-6 py-4 rounded-2xl font-black uppercase tracking-widest text-xs border border-blue-600/50 hover:border-blue-500 transition-all flex items-center justify-center gap-2 cursor-pointer"><Icon name="skip-forward" size={16}/> Avançar</button>
                                    </div>
                                </div>
                            </div>
                            
                            <div className="p-4 md:p-6 bg-white flex gap-4 overflow-x-auto hide-scrollbar items-center">
                                <span className="text-[10px] font-black text-slate-400 uppercase tracking-widest shrink-0 ml-2">A seguir:</span>
                                {[1, 2, 3, 4].map(offset => {
                                    const nextIdx = (currentCycleIndex + offset) % cycleSequence.length;
                                    const nextId = cycleSequence[nextIdx];
                                    const nextSub = subjects.find(s => s.id === nextId);
                                    if(!nextSub) return null;
                                    return (
                                        <div key={offset} className="shrink-0 flex items-center gap-2 bg-slate-50 border border-slate-100 px-4 py-2.5 rounded-xl opacity-70">
                                            <span className="text-[9px] font-black text-slate-400">{(nextIdx + 1)}</span>
                                            <span className="text-[11px] font-bold text-slate-700 truncate max-w-[120px]">{nextSub.name}</span>
                                        </div>
                                    )
                                })}
                            </div>
                        </div>
                    ) : (
                        <div className="bg-blue-50 border border-blue-100 rounded-[32px] p-10 text-center">
                            <Icon name="compass" size={40} className="text-blue-500 mx-auto mb-4" />
                            <h3 className="text-xl font-black text-blue-900 uppercase tracking-tighter mb-2">Nenhum Ciclo Ativo</h3>
                            <p className="text-blue-600/70 text-sm font-bold mb-6">Vá até a aba Estratégia para montar o seu gerenciador de estudos.</p>
                            <button onClick={() => setActiveTab('planejamento')} className="bg-blue-600 text-white px-6 py-3 rounded-xl font-black uppercase text-xs tracking-widest shadow-lg cursor-pointer">Montar Estratégia</button>
                        </div>
                    )}

                    <div className="grid grid-cols-1 sm:grid-cols-3 gap-4 md:gap-6">
                      <div className="bg-white p-6 rounded-3xl border border-slate-200 shadow-sm flex flex-col justify-between">
                        <div><p className="text-[10px] font-black text-slate-400 uppercase tracking-widest">Estudado (Nova Meta)</p><p className="text-4xl font-black mt-1 text-slate-800">{stats.totalHoursGoal.toFixed(1)}h</p></div>
                        <div className="w-full h-2 bg-slate-100 rounded-full mt-4 overflow-hidden"><div className="h-full bg-blue-500" style={{ width: `${Math.min((stats.totalHoursGoal / (goalData.totalHours || 1)) * 100, 100)}%` }} /></div>
                      </div>
                      <div className="bg-white p-6 rounded-3xl border border-slate-200 shadow-sm flex flex-col justify-between">
                        <div><p className="text-[10px] font-black text-slate-400 uppercase tracking-widest">Total Histórico</p><p className="text-4xl font-black mt-1 text-slate-800">{stats.totalHoursEver.toFixed(1)}h</p></div>
                        <p className="text-[10px] font-bold text-slate-400 mt-2">Todas as horas já registradas</p>
                      </div>
                      <div className="bg-white p-6 rounded-3xl border border-slate-200 shadow-sm flex flex-col justify-center text-center">
                        <p className="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">Aproveitamento Global</p><p className="text-4xl font-black text-green-600 tracking-tighter">{Math.round(stats.accuracy)}%</p><p className="text-[9px] font-bold text-slate-400 mt-2 uppercase tracking-widest">{stats.hTotal} / {stats.qTotal} questões</p>
                      </div>
                    </div>

                    <section className="bg-white p-6 md:p-8 rounded-[32px] border border-slate-200 shadow-sm overflow-hidden">
                      <h3 className="text-xl font-black uppercase tracking-tighter mb-6 flex items-center gap-3"><Icon name="bar-chart-3" className="text-blue-600" size={24} /> Raio-X por Matéria</h3>
                      <div className="overflow-x-auto">
                        <table className="w-full text-left min-w-[700px]">
                          <thead className="text-[9px] font-black text-slate-400 uppercase border-b border-slate-100">
                            <tr>
                                <th className="pb-4 pr-4">Disciplinas</th>
                                <th className="pb-4 text-center">Questões Totais</th>
                                <th className="pb-4 text-center">Acertos</th>
                                <th className="pb-4 text-center">Tempo para Bater a Meta</th>
                                <th className="pb-4 text-right">Pendências</th>
                            </tr>
                          </thead>
                          <tbody className="divide-y divide-slate-50">
                            {(metrics || []).map(m => {
                              return (
                              <tr key={m.id} className="text-sm hover:bg-slate-50/50 transition-all">
                                <td className="py-4 uppercase tracking-tighter text-slate-700 font-black pr-4 text-xs">{String(m.name)}</td>
                                <td className="py-4 text-center text-slate-800 font-bold text-xs">{m.totalQ}</td>
                                <td className="py-4 text-center text-slate-800 font-bold text-xs">{m.totalH}</td>
                                <td className="py-4 text-center text-slate-800 font-bold text-xs">{m.timeRemaining > 0 ? `${m.timeRemaining.toFixed(1)}h` : 'Meta Batida!'}</td>
                                <td className="py-4 text-right"><div className="flex flex-col items-end"><span className="text-[10px] text-slate-500 uppercase tracking-widest font-black">{m.unstudiedCount} tópicos faltam</span></div></td>
                              </tr>
                            )})}
                          </tbody>
                        </table>
                      </div>
                    </section>
                  </div>
                )}

                {/* ABA ESTRATÉGIA / PLANEJAMENTO */}
                {activeTab === 'planejamento' && (
                   <div className="max-w-5xl mx-auto space-y-12 animate-in fade-in duration-500">
                      <section className="bg-white p-8 rounded-[32px] border border-slate-200 shadow-sm flex flex-col md:flex-row gap-8 items-center">
                          <div className="flex-1 space-y-2">
                              <h3 className="text-2xl font-black uppercase tracking-tighter flex items-center gap-2"><Icon name="flag" className="text-indigo-600"/> O Alvo (Meta)</h3>
                              <p className="text-xs font-bold text-slate-400 leading-relaxed">Defina a meta de horas e clique em iniciar. Isso zera o tempo pendente sem apagar seu histórico global.</p>
                          </div>
                          <div className="flex flex-col sm:flex-row items-end gap-3 w-full md:w-auto">
                              <div className="space-y-1 w-full sm:w-24">
                                  <label className="text-[9px] font-black uppercase text-slate-400 tracking-widest ml-1">Meta (h)</label>
                                  <input type="number" value={goalData.totalHours} onChange={e => setGoalData({...goalData, totalHours: Number(e.target.value)})} className="w-full bg-slate-50 h-10 px-3 rounded-xl text-sm font-black border border-slate-200 text-center outline-none focus:ring-2 ring-indigo-500" />
                              </div>
                              <div className="space-y-1 w-full sm:w-36">
                                  <label className="text-[9px] font-black uppercase text-slate-400 tracking-widest ml-1">Data Final da Meta</label>
                                  <input type="date" value={goalData.targetDate} onChange={e => setGoalData({...goalData, targetDate: e.target.value})} className="w-full bg-slate-50 h-10 px-3 rounded-xl text-xs font-bold border border-slate-200 outline-none focus:ring-2 ring-indigo-500" />
                              </div>
                              <button onClick={handleResetGoal} className="w-full sm:w-auto bg-indigo-600 text-white h-10 px-6 rounded-xl font-black uppercase tracking-widest text-[10px] shadow-lg hover:bg-indigo-700 transition-all cursor-pointer">Iniciar Nova Meta</button>
                          </div>
                      </section>

                      <section className="bg-white p-8 rounded-[32px] border border-slate-200 shadow-sm">
                          <h3 className="text-2xl font-black uppercase tracking-tighter mb-8 flex items-center gap-2"><Icon name="refresh-cw" className="text-blue-600"/> Gerenciador do Ciclo</h3>
                          <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
                              <div className="lg:col-span-1 space-y-6 bg-slate-50 p-6 rounded-2xl border border-slate-100 flex flex-col justify-between">
                                  <div>
                                      <div className="flex gap-4 mb-4">
                                          <div className="flex-1 space-y-1"><label className="text-[9px] font-black uppercase text-slate-400 tracking-widest">Sessões</label><input type="number" value={cycleBuilderSessions} onChange={e=>setCycleBuilderSessions(Number(e.target.value))} className="w-full p-3 rounded-lg text-sm font-bold border border-slate-200 text-center outline-none" /></div>
                                          <div className="flex-1 space-y-1"><label className="text-[9px] font-black uppercase text-slate-400 tracking-widest">Tempo/médio</label><input type="number" defaultValue={45} className="w-full p-3 rounded-lg text-sm font-bold border border-slate-200 text-center outline-none" /></div>
                                      </div>
                                      <div className="space-y-2 max-h-[250px] overflow-y-auto pr-2 custom-scroll">
                                          {sortedSubjects.map(s => (
                                              <label key={s.id} className="flex items-center gap-3 p-2 hover:bg-white rounded-lg cursor-pointer transition-colors border border-transparent hover:border-slate-200">
                                                  <input type="checkbox" checked={!!selectedToCycle[s.id]} onChange={(e) => setSelectedToCycle({...selectedToCycle, [s.id]: e.target.checked})} className="w-4 h-4 text-blue-600 rounded border-slate-300 focus:ring-blue-500" />
                                                  <span className="text-xs font-bold text-slate-700 truncate">{s.name} <span className="text-[9px] text-slate-400">(P: {s.weight})</span></span>
                                              </label>
                                          ))}
                                      </div>
                                  </div>
                                  <button onClick={generateProportionalCycle} className="w-full bg-blue-600 text-white py-4 mt-2 rounded-xl font-black uppercase tracking-widest text-[10px] hover:bg-blue-700 transition-all cursor-pointer shadow-lg">⚡ Gerar Fila</button>
                              </div>

                              <div className="lg:col-span-2 bg-slate-900 p-6 rounded-2xl text-white relative flex flex-col">
                                  <div className="flex justify-between items-end mb-6 border-b border-slate-800 pb-4">
                                      <div><p className="text-[10px] font-black text-slate-500 uppercase tracking-widest">A Sequência da Catraca</p><p className="text-sm font-bold mt-1">Total: {cycleSequence.length} sessões</p></div>
                                      <button onClick={()=> {setCycleSequence([]); setCurrentCycleIndex(0);}} className="text-[10px] font-black text-red-400 uppercase tracking-widest hover:text-red-300 cursor-pointer flex items-center gap-1"><Icon name="trash-2" size={12}/> Limpar</button>
                                  </div>
                                  <div className="grid grid-cols-1 sm:grid-cols-2 gap-3 max-h-[350px] overflow-y-auto pr-2 custom-scroll flex-1">
                                      {cycleSequence.map((sid, idx) => {
                                          const sub = subjects.find(s=> s.id === sid);
                                          return (
                                          <div key={`${sid}-${idx}-${Math.random()}`} className="flex items-center justify-between bg-slate-800 px-3 h-12 rounded-xl border border-slate-700">
                                              <div className="flex items-center gap-3 overflow-hidden">
                                                  <span className="bg-slate-900 text-slate-500 w-6 h-6 rounded flex items-center justify-center text-[10px] font-black shrink-0">{idx+1}</span>
                                                  <span className="text-xs font-bold truncate max-w-[130px]">{sub?.name || '---'}</span>
                                              </div>
                                              <div className="flex gap-1 shrink-0 ml-2">
                                                  <button onClick={() => { const n=[...cycleSequence]; if(idx>0){ n[idx]=n[idx-1]; n[idx-1]=sid; setCycleSequence(n); } }} className="text-slate-500 hover:text-white cursor-pointer"><Icon name="arrow-up" size={14}/></button>
                                                  <button onClick={() => { const n=[...cycleSequence]; if(idx<n.length-1){ n[idx]=n[idx+1]; n[idx+1]=sid; setCycleSequence(n); } }} className="text-slate-500 hover:text-white cursor-pointer"><Icon name="arrow-down" size={14}/></button>
                                                  <button onClick={() => { setCycleSequence(cycleSequence.filter((_, i) => i !== idx)); }} className="text-slate-500 hover:text-red-400 ml-1 cursor-pointer"><Icon name="x" size={14}/></button>
                                              </div>
                                          </div>
                                      )})}
                                  </div>

                                  <div className="mt-4 pt-4 border-t border-slate-800 flex flex-col sm:flex-row justify-between sm:items-center gap-3">
                                      <span className="text-[9px] text-slate-400 font-bold uppercase tracking-widest">+ Adicionar sessão na fila:</span>
                                      <select onChange={(e) => { if(e.target.value) { setCycleSequence([...cycleSequence, e.target.value]); e.target.value=""; } }} className="bg-slate-800 border border-slate-700 text-white text-xs font-bold px-3 py-2.5 rounded-xl outline-none w-full sm:w-64 cursor-pointer">
                                          <option value="">Selecione a matéria avulsa...</option>
                                          {sortedSubjects.map(s => <option key={s.id} value={s.id}>{s.name}</option>)}
                                      </select>
                                  </div>
                              </div>
                          </div>
                      </section>

                      <section className="bg-white p-8 rounded-[32px] border border-slate-200 shadow-sm">
                        <div className="flex flex-col md:flex-row justify-between items-center gap-6 mb-8">
                            <h3 className="text-xl font-black uppercase tracking-tighter flex items-center gap-2">
                                <Icon name="database" className="text-slate-400" /> 
                                Matérias do Edital
                                <span className="ml-2 bg-slate-100 text-slate-500 px-3 py-1.5 rounded-lg text-[10px] font-black tracking-widest border border-slate-200">
                                    Total: {stats.weightSum} Questões
                                </span>
                            </h3>
                            <div className="flex flex-wrap gap-2 justify-center w-full md:w-auto">
                                <button onClick={() => setActiveModal('add')} className="flex-1 md:flex-none justify-center bg-slate-800 text-white px-5 py-2.5 rounded-lg text-[10px] font-black uppercase tracking-widest flex items-center gap-2 cursor-pointer hover:bg-slate-900"><Icon name="plus" size={14} /> Nova</button>
                                <button onClick={backupData} className="flex-1 md:flex-none justify-center bg-blue-100 text-blue-700 px-5 py-2.5 rounded-lg text-[10px] font-black uppercase tracking-widest flex items-center gap-2 cursor-pointer hover:bg-blue-200"><Icon name="download" size={14} /> Backup</button>
                                <label className="flex-1 md:flex-none justify-center bg-green-100 text-green-700 px-5 py-2.5 rounded-lg text-[10px] font-black uppercase tracking-widest flex items-center gap-2 cursor-pointer hover:bg-green-200"><Icon name="upload" size={14} /> Restaurar<input type="file" accept=".json" className="hidden" onChange={handleRestoreBackup} /></label>
                                <button onClick={() => setActiveModal('reset')} className="flex-1 md:flex-none justify-center bg-red-50 text-red-600 px-5 py-2.5 rounded-lg text-[10px] font-black uppercase tracking-widest flex items-center gap-2 cursor-pointer hover:bg-red-100"><Icon name="trash-2" size={14} /> Zerar Sistema</button>
                            </div>
                        </div>
                        <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                            {sortedSubjects.map(s => (
                                <div key={s.id} className="p-4 rounded-2xl bg-slate-50 border border-slate-100 group transition-all relative">
                                    <div className="space-y-3">
                                        <div className="flex items-center gap-2"><Icon name="edit-3" size={12} className="text-slate-300" /><input type="text" value={s.name} onChange={(e) => updateSubject(s.id, 'name', e.target.value)} className="bg-transparent border-none text-xs font-black uppercase outline-none focus:text-blue-600 w-full tracking-tight" /></div>
                                        <div className="flex items-center justify-between pt-2 border-t border-slate-200/50">
                                            <div className="flex items-center gap-2"><span className="text-[9px] font-black text-slate-400 uppercase tracking-widest">Peso:</span><input type="number" value={s.weight} onChange={(e) => updateSubject(s.id, 'weight', Number(e.target.value))} className="w-12 bg-white border border-slate-200 rounded p-1 text-center font-black text-xs outline-none" /></div>
                                            <button onClick={() => handleDeleteSubject(s.id)} className="text-slate-300 hover:text-red-500 cursor-pointer"><Icon name="trash-2" size={14}/></button>
                                        </div>
                                    </div>
                                </div>
                            ))}
                        </div>
                      </section>
                   </div>
                )}

                {/* ABA MATÉRIA */}
                {activeTab === 'materia' && currentSubject && (
                  <div className="max-w-5xl mx-auto space-y-8 animate-in slide-in-from-right duration-300">
                    <header className="flex flex-col md:flex-row md:items-end justify-between gap-6 pb-6 border-b border-slate-200">
                      <div>
                          <button onClick={() => setActiveTab('painel')} className="text-[10px] font-black text-slate-400 hover:text-blue-600 uppercase tracking-widest mb-4 flex items-center gap-2 cursor-pointer"><Icon name="arrow-left" size={14} /> Voltar ao Painel</button>
                          <h2 className="text-4xl md:text-5xl font-black uppercase tracking-tighter text-slate-800 leading-none">{String(currentSubject.name)}</h2>
                      </div>
                    </header>

                    <div className="p-6 md:p-8 rounded-[32px] border border-slate-200 bg-white shadow-sm relative">
                      <h3 className="text-[10px] font-black uppercase text-slate-400 tracking-widest flex items-center gap-2 mb-6"><Icon name="check-circle" size={16}/> Registrar Sessão de Estudo</h3>
                      <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div className="space-y-1"><label className="text-[9px] font-black uppercase text-slate-500 ml-1 tracking-widest">Tópico</label>
                          <select value={form.topic} onChange={e => setForm({...form, topic: e.target.value})} className="w-full bg-slate-50 p-3 rounded-xl text-xs font-bold border border-slate-200 outline-none">
                            <option value="">Selecione o tema...</option>
                            {(currentSubject.topics || []).sort((a, b) => String(a).localeCompare(String(b))).map(t => <option key={t} value={t}>{String(t)}</option>)}
                          </select>
                        </div>
                        <div className="grid grid-cols-2 gap-4">
                            <div className="space-y-1"><label className="text-[9px] font-black uppercase text-slate-500 ml-1 tracking-widest">Data</label><input type="date" value={form.studyDate} onChange={e => setForm({...form, studyDate: e.target.value})} className="w-full bg-slate-50 p-3 rounded-xl text-xs font-bold border border-slate-200 outline-none" /></div>
                            <div className="space-y-1"><label className="text-[9px] font-black uppercase text-slate-500 ml-1 tracking-widest">Tempo (m)</label><input type="number" value={form.time} onChange={e => setForm({...form, time: e.target.value})} className="w-full bg-slate-50 p-3 rounded-xl text-xs font-bold border border-slate-200 outline-none text-center" /></div>
                        </div>
                        <div className="grid grid-cols-2 gap-4">
                          <div className="space-y-1"><label className="text-[9px] font-black uppercase text-slate-500 ml-1 tracking-widest">Questões</label><input type="number" value={form.q} onChange={e => setForm({...form, q: e.target.value})} className="w-full bg-slate-50 p-3 rounded-xl text-xs font-bold border border-slate-200 text-center outline-none" /></div>
                          <div className="space-y-1"><label className="text-[9px] font-black uppercase text-slate-500 ml-1 tracking-widest">Acertos</label><input type="number" value={form.h} onChange={e => setForm({...form, h: e.target.value})} className="w-full bg-slate-50 p-3 rounded-xl text-xs font-bold border border-slate-200 text-center outline-none" /></div>
                        </div>
                        <div className="bg-amber-50/50 p-4 rounded-2xl border border-amber-100/50">
                           <div className="flex justify-between items-center mb-2">
                               <label className="text-[9px] font-black uppercase text-amber-600 ml-1 tracking-widest">Agendar Revisões</label>
                               <button onClick={()=> setFormRevs([...formRevs, {...defaultRev}])} className="text-amber-600 hover:text-amber-800 bg-amber-100 p-1 rounded cursor-pointer flex items-center gap-1 text-[9px] font-black uppercase"><Icon name="plus" size={12}/> Adicionar</button>
                           </div>
                           <div className="space-y-2 max-h-[140px] overflow-y-auto pr-1">
                               {formRevs.map((rev, idx) => (
                                   <div key={idx} className="flex gap-2 items-center">
                                       <input type="date" value={rev.date} onChange={e => { const n=[...formRevs]; n[idx].date=e.target.value; setFormRevs(n); }} className="flex-1 bg-white p-2.5 rounded-lg text-xs font-bold border border-amber-200 outline-none" />
                                       <select value={rev.type} onChange={e => { const n=[...formRevs]; n[idx].type=e.target.value; setFormRevs(n); }} className="w-24 bg-white p-2.5 rounded-lg text-[10px] font-bold border border-amber-200 outline-none">
                                           <option value="completa">Completa</option><option value="breve">Breve</option>
                                       </select>
                                       {idx > 0 && <button onClick={() => setFormRevs(formRevs.filter((_, i) => i !== idx))} className="text-red-400 hover:text-red-600 p-2 cursor-pointer"><Icon name="x" size={14}/></button>}
                                   </div>
                               ))}
                           </div>
                        </div>
                      </div>

                      {/* CHECKBOX INTELIGENTE - APARECE APENAS SE A MATÉRIA FOR A VEZ DO CICLO */}
                      {cycleActiveId === String(currentSubject.id) && (
                          <div className="flex items-center gap-3 mt-4 bg-blue-50/50 p-3 rounded-xl border border-blue-100/50">
                              <input type="checkbox" id="autoAdvanceCheck" checked={autoAdvance} onChange={e => setAutoAdvance(e.target.checked)} className="w-4 h-4 text-blue-600 rounded cursor-pointer border-blue-300 focus:ring-blue-500" />
                              <label htmlFor="autoAdvanceCheck" className="text-[10px] font-black uppercase text-blue-800 tracking-widest cursor-pointer select-none">
                                  É estudo da meta? (Avançar catraca após salvar)
                              </label>
                          </div>
                      )}

                      <button onClick={() => registerSession(currentSubject.id)} className="w-full bg-blue-600 text-white py-4 rounded-xl text-[10px] font-black uppercase tracking-widest shadow-lg shadow-blue-500/20 hover:bg-blue-700 transition-all mt-6 cursor-pointer">Salvar no Diário de Bordo</button>
                    </div>

                    <div className="bg-white p-6 md:p-8 rounded-[32px] border border-slate-200 shadow-sm overflow-hidden">
                       <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-8">
                           <div className="flex items-center gap-2"><Icon name="list" size={18} className="text-slate-400" /><h3 className="text-[10px] font-black uppercase text-slate-400 tracking-widest">Tópicos do Edital</h3></div>
                           <div className="flex items-center gap-2 w-full md:w-auto">
                               <input type="text" placeholder="Novo Assunto..." value={newTopicValue} onChange={e => setNewTopicValue(e.target.value)} onKeyDown={e => {if(e.key === 'Enter'){ handleTopicManage('add', null, newTopicValue); setNewTopicValue('');}}} className="flex-1 md:w-48 bg-slate-50 border border-slate-200 p-2 rounded-lg text-[10px] font-bold outline-none" />
                               <button onClick={()=>{ handleTopicManage('add', null, newTopicValue); setNewTopicValue('');}} className="bg-slate-800 text-white p-2 rounded-lg cursor-pointer hover:bg-slate-900"><Icon name="plus" size={14}/></button>
                           </div>
                       </div>
                       
                       <div className="overflow-x-auto pb-4">
                           <div className="min-w-[800px]">
                                <div className="grid grid-cols-12 gap-2 px-4 pb-4 border-b border-slate-100 text-[9px] font-black text-slate-400 uppercase tracking-widest mb-4">
                                    <div className="col-span-4">Assunto / Tópico (Editável)</div>
                                    <div className="col-span-2 text-center">Status</div>
                                    <div className="col-span-2 text-center">Último Estudo</div>
                                    <div className="col-span-1 text-center">Tempo</div>
                                    <div className="col-span-1 text-center">Q / A</div>
                                    <div className="col-span-1 text-right">Aprov.</div>
                                    <div className="col-span-1"></div>
                                </div>
                               
                               <div className="space-y-1 max-h-[400px] overflow-y-auto pr-2 custom-scroll">
                                 {(topicStats || []).map((ts, idx) => {
                                   const perc = ts.q > 0 ? Math.round((ts.h / ts.q) * 100) : 0;
                                   const isEditing = editingTopicIdx === idx;
                                   let dateColorClass = "text-slate-400";
                                   if (ts.lastStudyDateObj) {
                                       const today = new Date(); today.setHours(0,0,0,0);
                                       const studyDate = new Date(ts.lastStudyDateObj); studyDate.setHours(0,0,0,0);
                                       const diffDays = Math.floor((today.getTime() - studyDate.getTime()) / (1000 * 60 * 60 * 24));
                                       
                                       if (diffDays > 25) dateColorClass = "text-red-700 font-black bg-red-50 border border-red-100 px-2 py-0.5 rounded";
                                       else if (diffDays > 15) dateColorClass = "text-amber-600 font-black bg-amber-50 border border-amber-100 px-2 py-0.5 rounded";
                                       else dateColorClass = "text-slate-600 font-bold";
                                   }

                                   return (
                                     <div key={idx} className="grid grid-cols-12 items-center gap-2 px-4 py-3 rounded-xl border border-slate-50 hover:bg-slate-50 transition-all">
                                       <div className="col-span-4 flex items-center gap-2">
                                           {isEditing ? (
                                             <input type="text" autoFocus value={editTopicValue} onChange={e=>setEditTopicValue(e.target.value)} onBlur={()=>{handleTopicManage('edit', ts.topic, editTopicValue); setEditingTopicIdx(null);}} onKeyDown={e=>{if(e.key==='Enter') e.target.blur()}} className="w-full text-[10px] font-black uppercase border-b border-blue-400 outline-none bg-transparent" />
                                           ) : (
                                             <span onDoubleClick={()=>{setEditingTopicIdx(idx); setEditTopicValue(ts.topic);}} className="text-[10px] font-black uppercase text-slate-700 block whitespace-normal break-words leading-tight cursor-text" title={String(ts.topic)}>{String(ts.topic)}</span>
                                           )}
                                       </div>
                                       <div className="col-span-2 flex justify-center">
                                            <select value={ts.status} onChange={(e) => updateTopicStatus(currentSubject.id, ts.topic, e.target.value)} className={`text-[9px] font-black uppercase px-2 py-1.5 rounded outline-none cursor-pointer border ${ts.status === 'Finalizado' ? 'bg-green-50 text-green-700 border-green-200' : ts.status === 'Priorizar' ? 'bg-amber-50 text-amber-700 border-amber-200' : ts.status === 'Estudando' ? 'bg-blue-50 text-blue-700 border-blue-200' : ts.status === 'Não Estudar' ? 'bg-slate-200 text-slate-500 border-slate-300' : 'bg-white text-slate-600 border-slate-200'}`}>
                                                <option value="Estudar">Estudar</option>
                                                <option value="Estudando">Estudando</option>
                                                <option value="Priorizar">Priorizar</option>
                                                <option value="Finalizado">Finalizado</option>
                                                <option value="Não Estudar">Não Estudar</option>
                                            </select>
                                       </div>
                                       <div className="col-span-2 flex justify-center items-center"><span className={`text-[9px] tracking-widest ${dateColorClass}`}>{ts.lastStudyDateStr !== '-' ? ts.lastStudyDateStr : '---'}</span></div>
                                       <div className="col-span-1 text-center"><span className="text-[10px] font-bold text-blue-600">{Number(ts.time)} <span className="text-[8px] opacity-60">m</span></span></div>
                                       <div className="col-span-1 text-center text-[10px] font-black text-slate-500">{Number(ts.h)}/{Number(ts.q)}</div>
                                       <div className="col-span-1 text-right"><span className={`text-[10px] font-black px-1.5 py-0.5 rounded ${ts.q === 0 ? 'text-slate-400' : perc >= 80 ? 'text-green-600' : 'text-red-600'}`}>{perc}%</span></div>
                                       <div className="col-span-1 flex justify-end gap-1">
                                           <button onClick={()=>{setEditingTopicIdx(idx); setEditTopicValue(ts.topic);}} className="text-slate-300 hover:text-blue-500 p-1 cursor-pointer"><Icon name="edit-2" size={12}/></button>
                                           <button onClick={()=>{if(confirm('Excluir este assunto permanentemente?')) handleTopicManage('delete', ts.topic);}} className="text-slate-300 hover:text-red-500 p-1 cursor-pointer"><Icon name="trash-2" size={12}/></button>
                                       </div>
                                     </div>
                                   );
                                 })}
                               </div>
                           </div>
                       </div>
                    </div>

                    {/* BLOCO DE OBSERVAÇÕES E HISTÓRICO EMPILHADO */}
                    <div className="flex flex-col gap-6">
                        {/* Observações Em Cima */}
                        <div className="bg-white p-6 rounded-3xl border border-slate-200 shadow-sm flex flex-col min-h-[160px]">
                           <h3 className="text-[10px] font-black uppercase text-slate-400 tracking-widest mb-4 flex items-center gap-2"><Icon name="file-text" size={16}/> Observações</h3>
                           <textarea className="flex-1 bg-slate-50 border border-slate-100 rounded-xl p-4 text-xs outline-none resize-none font-medium leading-relaxed" placeholder="Lembrete de onde parou, dar ênfase no assunto X e pontos de atenção..." value={String(currentSubject.notes || '')} onChange={(e) => updateSubject(currentSubject.id, 'notes', e.target.value)} />
                        </div>

                        {/* Histórico Embaixo */}
                        <div className="bg-white p-6 rounded-3xl border border-slate-200 shadow-sm overflow-hidden flex flex-col max-h-[400px]">
                           <h3 className="text-[10px] font-black uppercase text-slate-400 tracking-widest mb-4 flex items-center gap-2 shrink-0"><Icon name="history" size={16}/> Histórico de Registros</h3>
                           <div className="overflow-y-auto pr-2 custom-scroll flex-1">
                               <div className="space-y-2">
                                 {(currentSubject.logs || []).map(l => (
                                   <div key={l.id} className="flex flex-col sm:flex-row sm:items-center justify-between gap-2 p-3 bg-slate-50 rounded-xl border border-slate-100 hover:bg-white transition-all">
                                     <div className="flex-1 min-w-0">
                                        <div className="flex gap-2 items-center mb-1">
                                            <p className="text-[9px] font-black text-slate-400 uppercase">{String(l.date)}</p>
                                            
                                            {/* NOVA TAG DE REVISÃO INTELIGENTE */}
                                            {l.isRevision && (
                                              <span className={`text-[8px] text-white px-1.5 py-0.5 rounded font-black uppercase tracking-widest flex items-center gap-1 ${l.executedRevType === 'breve' ? 'bg-indigo-500' : 'bg-amber-500'}`}>
                                                <Icon name="rotate-ccw" size={8}/> 
                                                {l.executedRevType === 'breve' ? 'Rev. Breve' : 'Rev. Completa'}
                                              </span>
                                            )}
                                            
                                        </div>
                                        <h4 className="text-[11px] font-black uppercase text-slate-700 truncate">{String(l.topic)}</h4>
                                     </div>
                                     <div className="flex items-center gap-4 shrink-0">
                                         <p className="text-[10px] font-black text-blue-600">{Number(l.time)}m</p>
                                         <p className="text-[10px] font-black text-slate-500 w-8 text-center">{Number(l.h)}/{Number(l.q)}</p>
                                         <button onClick={() => {if(confirm('Apagar registro?')) handleDeleteLog(currentSubject.id, l.id);}} className="text-slate-300 hover:text-red-500 p-1 cursor-pointer"><Icon name="x" size={14}/></button>
                                     </div>
                                   </div>
                                 ))}
                               </div>
                           </div>
                        </div>
                    </div>
                  </div>
                )}

                {/* ABA REVISÕES (NOVO FORMATO INLINE) */}
                {activeTab === 'revisoes' && (
                  <div className="max-w-4xl mx-auto space-y-8 animate-in fade-in duration-500">
                    <header className="flex flex-col md:flex-row md:items-end justify-between gap-6 border-b border-slate-200 pb-8">
                      <div>
                          <h2 className="text-4xl md:text-5xl font-black uppercase tracking-tighter text-slate-800">Controle de Revisões</h2>
                          <p className="text-xs font-bold text-slate-400 mt-2">Estudos agendados independentes do ciclo</p>
                      </div>
                      <div className="flex items-center gap-3">
                        <select value={revFilterType} onChange={e => setRevFilterType(e.target.value)} className="bg-white border border-slate-200 px-4 py-2.5 rounded-xl text-[10px] font-black uppercase tracking-widest outline-none shadow-sm">
                          <option value="all">Todas</option><option value="completa">Completa</option><option value="breve">Breve</option>
                        </select>
                        <button onClick={() => setShowFutureRevisions(!showFutureRevisions)} className={`px-4 py-2.5 rounded-xl text-[10px] font-black uppercase tracking-widest transition-all cursor-pointer ${showFutureRevisions ? 'bg-amber-500 text-white shadow-md' : 'bg-slate-200 text-slate-600'}`}>{showFutureRevisions ? 'Focar Vencidas' : 'Ver Tudo'}</button>
                      </div>
                    </header>
                    
                    <div className="flex flex-col gap-3">
                      {(revisionList || []).length === 0 && <div className="p-16 text-center bg-transparent border-2 border-dashed border-slate-200 rounded-3xl text-slate-400 font-bold uppercase tracking-widest">Esteira Limpa</div>}
                      
                      {(revisionList || []).map((rev, i) => {
                        const revKey = rev.logId + rev.revDateOrig;
                        const formData = inlineRevForms[revKey] || { time: '', q: '', h: '', nextDate: '', nextType: 'completa' };
                        
                        return (
                        <div key={revKey} className="bg-white p-5 rounded-2xl border border-slate-200 shadow-sm flex flex-col gap-4 group">
                          
                          {/* CABEÇALHO DA REVISÃO */}
                          <div className="flex-1 min-w-0">
                            <div className="flex items-center gap-2 mb-1">
                               <span className={`text-[9px] font-black px-2 py-0.5 rounded uppercase tracking-widest ${rev.daysLeft <= 0 ? 'bg-red-100 text-red-700' : 'bg-amber-100 text-amber-700'}`}>{rev.daysLeft <= 0 ? 'Vencida' : `Em ${rev.daysLeft} d`}</span>
                               <span className="text-[9px] font-black text-slate-400 uppercase tracking-widest">{String(rev.subjectName)}</span>
                               <span className="text-[9px] font-black text-slate-300 uppercase">| {rev.type}</span>
                            </div>
                            <h4 className="font-black text-sm text-slate-800 truncate">{String(rev.topic)}</h4>
                          </div>

                          {/* CAMPOS DE EXECUÇÃO INLINE (Tudo Opcional) */}
                          <div className="flex flex-wrap items-end gap-2 bg-slate-50 p-4 rounded-xl border border-slate-100">
                             <div className="flex-1 min-w-[70px] space-y-1"><label className="text-[8px] font-black uppercase text-slate-400 ml-1">Tempo(m)</label><input type="number" placeholder="0" value={formData.time} onChange={(e) => updateInlineForm(revKey, 'time', e.target.value)} className="w-full text-xs font-bold p-2.5 rounded-lg border border-slate-200 outline-none text-center"/></div>
                             <div className="flex-1 min-w-[70px] space-y-1"><label className="text-[8px] font-black uppercase text-slate-400 ml-1">Questões</label><input type="number" placeholder="0" value={formData.q} onChange={(e) => updateInlineForm(revKey, 'q', e.target.value)} className="w-full text-xs font-bold p-2.5 rounded-lg border border-slate-200 outline-none text-center"/></div>
                             <div className="flex-1 min-w-[70px] space-y-1"><label className="text-[8px] font-black uppercase text-slate-400 ml-1">Acertos</label><input type="number" placeholder="0" value={formData.h} onChange={(e) => updateInlineForm(revKey, 'h', e.target.value)} className="w-full text-xs font-bold p-2.5 rounded-lg border border-slate-200 outline-none text-center"/></div>
                             <div className="flex-1 min-w-[120px] space-y-1"><label className="text-[8px] font-black uppercase text-amber-500 ml-1">Agendar Nova Rev.</label><input type="date" value={formData.nextDate} onChange={(e) => updateInlineForm(revKey, 'nextDate', e.target.value)} className="w-full text-[10px] font-bold p-2.5 rounded-lg border border-amber-200 outline-none"/></div>
                             
                             <button onClick={() => handleInlineRevisionSave(rev)} className="w-full sm:w-auto mt-2 sm:mt-0 bg-green-600 hover:bg-green-700 text-white px-6 py-2.5 rounded-lg text-[10px] font-black uppercase tracking-widest flex items-center justify-center gap-2 cursor-pointer shadow-md transition-all">
                                <Icon name="check" size={14} /> Concluir
                             </button>
                          </div>
                        </div>
                      )})}
                    </div>
                  </div>
                )}
              </main>
            </div>
          );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>

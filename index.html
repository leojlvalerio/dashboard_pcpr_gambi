<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PCPR Pro - Dashboard de Estudos V3</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pocketbase/0.21.1/pocketbase.umd.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="bg-slate-50">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;
        const pb = new PocketBase('https://dashboard-pcpr-pocketbase.kgmk5k.easypanel.host');
        
        const Icon = ({ name, size = 20, className = "" }) => {
            const spanRef = useRef(null);
            useEffect(() => {
                if (spanRef.current) {
                    spanRef.current.innerHTML = `<i data-lucide="${name}" class="${className}" style="width:${size}px; height:${size}px"></i>`;
                    lucide.createIcons();
                }
            }, [name, className, size]);
            return <span ref={spanRef} style={{ display: 'contents' }}></span>;
        };

        // BASE NATIVA (SÓ SERVE PARA INICIALIZAR MATÉRIAS NOVAS AGORA)
        const DEFAULT_TOPICS = {
          penal: ["Teoria Geral: Aplicação da Lei Penal", "Teoria Geral: Teoria Geral do Crime", "Teoria Geral: Conduta (ação e omissão)", "Teoria Geral: Nexo Causal", "Teoria Geral: Tipicidade", "Teoria Geral: Antijuridicidade e Excludentes", "Teoria Geral: Culpabilidade", "Teoria Geral: Erro de Tipo e Erro de Proibição", "Teoria Geral: Inimputabilidade", "Teoria Geral: Princípio da Insignificância", "Teoria Geral: Concurso de Pessoas", "Teoria Geral: Teorias de Autoria", "Teoria Geral: Iter Criminis", "Teoria Geral: Tentativa", "Teoria Geral: Desistência Voluntária e Arrependimento eficaz", "Teoria Geral: Arrependimento Posterior", "Penas: Teoria da Pena", "Penas: Espécies de Penas", "Penas: Regimes e Substituição", "Penas: Concurso de Crimes", "Penas: Prescrição", "Crimes contra a Pessoa: Homicídio", "Crimes contra a Pessoa: Lesões Corporais", "Crimes contra a Pessoa: Crimes contra a Honra", "Crimes contra a Pessoa: Aborto", "Crimes contra a Pessoa: Omissão de Socorro", "Crimes contra o Patrimônio: Furto", "Crimes contra o Patrimônio: Roubo", "Crimes contra o Patrimônio: Extorsão", "Crimes contra o Patrimônio: Estelionato", "Crimes contra o Patrimônio: Receptação", "Crimes contra o Patrimônio: Dano", "Crimes contra a Dignidade Sexual: Estupro", "Crimes contra a Dignidade Sexual: Assédio Sexual", "Crimes contra a Administração: Peculato", "Crimes contra a Administração: Corrupção Passiva", "Crimes contra a Administração: Concussão", "Crimes contra a Administração: Prevaricação", "Crimes contra a Administração: Resistência e Desobediência"],
          'proc-penal': ["Inquérito Policial", "Notitia Criminis", "Instauração do Inquérito", "Relatório e Arquivamento", "BO, TCO e IP", "Ação Penal", "Decadência e Perempção", "Pedido de Explicações", "Competência", "Conexão e Continência", "Provas", "Motivação per relationem", "Prisões", "Medidas Cautelares", "Liberdade Provisória", "Procedimento Comum", "Ritos Processuais", "Fases do Processo", "Nulidades", "Incidente de Insanidade Mental", "Recursos", "Juiz das Garantias", "ANPP e Justiça Penal Consensual"],
          const: ["Direitos Fundamentais", "Direitos dos Presos", "Mandados de Criminalização", "Dignidade da Pessoa Humana", "Organização do Estado", "Competências Federativas", "Segurança Pública", "Processo Legislativo", "Controle de Constitucionalidade", "Controle por Omissão", "Poder Constituinte", "Imunidades Parlamentares", "Crime de Responsabilidade", "Intervenção Federal", "Competências STF e STJ"],
          adm: ["Atos Administrativos", "Anulação e Revogação", "Controle Judicial", "Agentes Públicos", "Regime Jurídico", "Estabilidade", "Provimento e Vacância", "Direitos e Vantagens", "Responsabilidade Civil do Estado", "Risco Administrativo", "Organização Administrativa", "Administração Direta e Indireta", "Autarquias", "Licitações", "Lei 14.133", "Improbidade Administrativa", "Poder Hierárquico", "Poder Disciplinar", "Poder de Polícia", "Serviços Públicos", "Concessões", "Empresas Estatais", "PAD", "Nepotismo"],
          'leg-especial': ["Lei Maria da Penha", "Medidas Protetivas", "Lei de Drogas", "Tráfico e Uso", "Lei de Organizações Criminosas", "Colaboração Premiada", "Infiltração de Agentes", "Lei de Abuso de Autoridade", "Pacote Anticrime", "Cadeia de Custódia", "ANPP", "Prisão Temporária", "Estatuto do Desarmamento", "Crimes Ambientais", "Interceptação Telefônica", "Juizados Especiais Criminais", "Lavagem de Dinheiro", "Crimes Tributários", "Lei de Racismo", "Embriaguez ao Volante"],
          civil: ["LINDB", "Pessoas", "Capacidade Civil", "Emancipação", "Bens", "Classificação de Bens", "Posse", "Propriedade", "Desforço Imediato", "Fatos Jurídicos", "Negócio Jurídico", "Autonomia da Vontade", "Disposição do Corpo"],
          dh: ["Teoria Geral dos Direitos Humanos", "Declaração Universal", "Pactos Internacionais", "Convenção contra a Tortura", "Princípios Estruturantes", "Status dos Tratados", "Sistema Interamericano", "Responsabilidade Internacional do Estado"],
          crim: ["Escolas Criminológicas", "Escola Clássica", "Escola Positivista", "Teorias Sociológicas", "Anomia", "Subculturas Criminais", "Técnicas de Neutralização", "Labelling Approach", "Direito Penal do Inimigo", "Janelas Quebradas", "Atuarialismo", "Discursos Punitivos", "Vitimologia", "Prevenção Criminal"],
          med: ["Medicina Legal — Conceito", "Perícia e Laudos", "Tanatologia", "Sinais Cadavéricos", "Estimativa do Tempo de Morte", "Traumatologia", "Lesões Corporais", "Balística Médico-Legal", "Docimásias", "Identificação Humana", "Dactiloscopia"],
          inf: ["Sistemas Operativos", "Linux (Ubuntu)", "Gestão de Arquivos", "Redes", "SMB e Compartilhamento", "LibreOffice Writer", "LibreOffice Calc", "Funções Básicas", "Navegadores", "Navegação Privada", "Segurança Básica"]
        };

        const INITIAL_SUBJECTS = [
          { id: 'penal', name: 'Direito Penal', weight: 15, notes: '', logs: [], history: [], topics: DEFAULT_TOPICS['penal'], topicStatuses: {} },
          { id: 'proc-penal', name: 'Direito Processual Penal', weight: 15, notes: '', logs: [], history: [], topics: DEFAULT_TOPICS['proc-penal'], topicStatuses: {} },
          { id: 'const', name: 'Constitucional', weight: 15, notes: '', logs: [], history: [], topics: DEFAULT_TOPICS['const'], topicStatuses: {} },
          { id: 'adm', name: 'Administrativo', weight: 15, notes: '', logs: [], history: [], topics: DEFAULT_TOPICS['adm'], topicStatuses: {} },
          { id: 'leg-especial', name: 'Legislação Especial', weight: 15, notes: '', logs: [], history: [], topics: DEFAULT_TOPICS['leg-especial'], topicStatuses: {} },
          { id: 'civil', name: 'Civil', weight: 5, notes: '', logs: [], history: [], topics: DEFAULT_TOPICS['civil'], topicStatuses: {} },
          { id: 'dh', name: 'Direitos Humanos', weight: 5, notes: '', logs: [], history: [], topics: DEFAULT_TOPICS['dh'], topicStatuses: {} },
          { id: 'crim', name: 'Criminologia', weight: 5, notes: '', logs: [], history: [], topics: DEFAULT_TOPICS['crim'], topicStatuses: {} },
          { id: 'med', name: 'Medicina Legal', weight: 5, notes: '', logs: [], history: [], topics: DEFAULT_TOPICS['med'], topicStatuses: {} },
          { id: 'inf', name: 'Informática', weight: 5, notes: '', logs: [], history: [], topics: DEFAULT_TOPICS['inf'], topicStatuses: {} }
        ];

        const getSafeId = (item) => {
            if (item === null || item === undefined) return null;
            if (typeof item === 'object') return String(item.id || item.value || '');
            return String(item);
        };

        function App() {
          const [subjects, setSubjects] = useState(INITIAL_SUBJECTS);
          const [cycleSequence, setCycleSequence] = useState([]);
          const [currentCycleIndex, setCurrentCycleIndex] = useState(0);
          
          // METAS (O MARCO ZERO)
          const [goalData, setGoalData] = useState({ totalHours: 100, targetDate: '', startDate: new Date().toISOString() });

          const [activeTab, setActiveTab] = useState('painel');
          const [selectedSubId, setSelectedSubId] = useState(null);
          const [activeModal, setActiveModal] = useState(null);
          
          const [showFutureRevisions, setShowFutureRevisions] = useState(false);
          const [revFilterType, setRevFilterType] = useState('all');
          
          // FORMS E ESTADOS TEMPORÁRIOS
          const [logToDeleteId, setLogToDeleteId] = useState(null);
          const [confirmModalData, setConfirmModalData] = useState(null);
          
          const defaultRev = { date: '', type: 'completa' };
          const [form, setForm] = useState({ topic: '', time: 0, q: 0, h: 0, studyDate: new Date().toISOString().split('T')[0] });
          const [formRevs, setFormRevs] = useState([{...defaultRev}]); // Multiplas revisoes

          // Gerenciador de Tópicos
          const [editingTopicIdx, setEditingTopicIdx] = useState(null);
          const [editTopicValue, setEditTopicValue] = useState('');
          const [newTopicValue, setNewTopicValue] = useState('');
          const [selectedToCycle, setSelectedToCycle] = useState({});
          const [cycleBuilderSessions, setCycleBuilderSessions] = useState(20);
          
          // CARREGAMENTO DEFENSIVO (COM MIGRAÇÃO DE TÓPICOS)
          useEffect(() => {
            async function loadData() {
              try {
                const record = await pb.collection('estudos').getFirstListItem('');
                if (record) {
                  if (record.subjects && Array.isArray(record.subjects)) {
                      // Migração: Garante que matérias antigas tenham o array 'topics' populado
                      const migrated = record.subjects.map(s => {
                          if (!s.topics || s.topics.length === 0) {
                              const baseTopics = DEFAULT_TOPICS[s.id] || [];
                              const custom = s.customTopics || [];
                              return { ...s, topics: [...new Set([...baseTopics, ...custom])] };
                          }
                          return s;
                      });
                      setSubjects(migrated);
                  }
                  if (record.cycleSequence && Array.isArray(record.cycleSequence)) {
                      setCycleSequence(record.cycleSequence.map(item => getSafeId(item)).filter(Boolean));
                  }
                  if (record.currentCycleIndex !== undefined) setCurrentCycleIndex(Number(record.currentCycleIndex) || 0);
                  if (record.goalData) setGoalData(record.goalData);
                  else if (record.availableTime) setGoalData(prev => ({...prev, totalHours: Number(record.availableTime)}));
                }
              } catch (e) { console.log("Sem dados na VPS ainda."); }
            }
            loadData();
          }, []);

          // SALVAMENTO AUTOMÁTICO
          useEffect(() => {
            const saveData = async () => {
              try {
                const data = { subjects, cycleSequence, currentCycleIndex, goalData };
                let record;
                try { record = await pb.collection('estudos').getFirstListItem(''); } catch (err) {}

                if (record && record.id) await pb.collection('estudos').update(record.id, data);
                else await pb.collection('estudos').create(data);
              } catch (e) { console.error("Erro ao salvar:", e); }
            };
            const timer = setTimeout(saveData, 800);
            return () => clearTimeout(timer);
          }, [subjects, cycleSequence, currentCycleIndex, goalData]);

          // CÁLCULOS GLOBAIS
          const stats = useMemo(() => {
            let qTotal = 0, hTotal = 0, totalHoursEver = 0, totalHoursGoal = 0;
            const goalStart = new Date(goalData.startDate || 0).getTime();

            (subjects || []).forEach(s => {
              (s.logs || []).forEach(l => {
                const logTimeH = (Number(l.time) || 0) / 60;
                qTotal += (Number(l.q) || 0); hTotal += (Number(l.h) || 0); 
                totalHoursEver += logTimeH;
                
                // Só soma na Meta se o log for mais novo que a data do Marco Zero
                if (l.timestamp >= goalStart) totalHoursGoal += logTimeH;
              });
            });
            const weightSum = (subjects || []).reduce((acc, s) => acc + (Number(s.weight) || 0), 0);
            return { accuracy: qTotal > 0 ? (hTotal / qTotal) * 100 : 0, totalHoursEver, totalHoursGoal, weightSum, hTotal, qTotal };
          }, [subjects, goalData]);

          // CÁLCULOS POR MATÉRIA (META PROPORCIONAL)
          const metrics = useMemo(() => {
            return (subjects || []).map(s => {
              const sSuggested = stats.weightSum > 0 ? (Number(s.weight || 0) / stats.weightSum) * goalData.totalHours : 0;
              let q = 0, h = 0, totalStudyHoursGoal = 0;
              const goalStart = new Date(goalData.startDate || 0).getTime();

              (s.logs || []).forEach(l => {
                  q += Number(l.q) || 0; h += Number(l.h) || 0;
                  if (l.timestamp >= goalStart) totalStudyHoursGoal += (Number(l.time) || 0) / 60;
              });

              const timeRemaining = Math.max(0, sSuggested - totalStudyHoursGoal);
              
              const statuses = s.topicStatuses || {};
              // Desconta os que estão Finalizados ou Não Estudar
              const unstudiedCount = (s.topics || []).filter(t => statuses[t] !== 'Finalizado' && statuses[t] !== 'Não Estudar').length;

              return { ...s, suggested: sSuggested, perf: q > 0 ? Math.round((h/q)*100) : 0, totalQ: q, totalH: h, totalStudyHoursGoal, timeRemaining, unstudiedCount };
            });
          }, [subjects, stats.weightSum, goalData]);

          // MOTOR DE REVISÕES MÚLTIPLAS
          const revisionList = useMemo(() => {
            const list = [];
            const today = new Date(); today.setHours(0, 0, 0, 0);

            (subjects || []).forEach(s => {
              (s.logs || []).forEach(l => {
                // Suporte legado para log.nextRev + novo array log.revisions
                const revsToProcess = l.revisions && l.revisions.length > 0 ? l.revisions : [];
                if (!l.revisions && l.nextRev) revsToProcess.push({ date: l.nextRev, type: l.nextRevType || 'completa' });

                revsToProcess.forEach(revData => {
                    if (!revData.date) return;
                    const [year, month, day] = revData.date.split('-').map(Number);
                    if (!year) return;
                    const nextRevDate = new Date(year, month - 1, day);
                    const diffDays = Math.ceil((nextRevDate.getTime() - today.getTime()) / (1000 * 60 * 60 * 24));
                    const matchesType = revFilterType === 'all' || revData.type === revFilterType;

                    if ((showFutureRevisions || diffDays <= 0) && matchesType) {
                      list.push({ logId: l.id, subjectId: s.id, subjectName: s.name, topic: l.topic, daysLeft: diffDays, type: revData.type, revDateOrig: revData.date });
                    }
                });
              });
            });
            
            // Agrupar e pegar a revisão mais urgente por tópico
            const uniqueRevs = {};
            list.forEach(r => {
                const key = `${r.subjectId}-${r.topic}-${r.type}`;
                if (!uniqueRevs[key] || r.daysLeft < uniqueRevs[key].daysLeft) uniqueRevs[key] = r;
            });

            return Object.values(uniqueRevs).sort((a, b) => a.daysLeft - b.daysLeft);
          }, [subjects, showFutureRevisions, revFilterType]);

          // ESTATÍSTICAS DOS TÓPICOS DENTRO DA MATÉRIA
          const topicStats = useMemo(() => {
            if (!selectedSubId) return [];
            const sub = (subjects || []).find(s => s.id === selectedSubId);
            if (!sub) return [];
            
            const statsMap = {};
            const statuses = sub.topicStatuses || {};
            
            (sub.topics || []).forEach(t => { 
                statsMap[String(t)] = { topic: String(t), time: 0, q: 0, h: 0, status: statuses[String(t)] || 'Estudar', lastStudyDateObj: null, lastStudyDateStr: '-' }; 
            });

            (sub.logs || []).forEach(log => {
              if (statsMap[String(log.topic)]) {
                statsMap[String(log.topic)].time += Number(log.time) || 0;
                statsMap[String(log.topic)].q += Number(log.q) || 0;
                statsMap[String(log.topic)].h += Number(log.h) || 0;
                
                const dateStr = log.date || '';
                const logDate = dateStr.includes('/') ? new Date(dateStr.split('/').reverse().join('-')) : new Date(log.timestamp || 0);
                
                if (!statsMap[String(log.topic)].lastStudyDateObj || logDate > statsMap[String(log.topic)].lastStudyDateObj) {
                    statsMap[String(log.topic)].lastStudyDateObj = logDate;
                    statsMap[String(log.topic)].lastStudyDateStr = dateStr;
                }
              }
            });
            return Object.values(statsMap).sort((a, b) => String(a.topic).localeCompare(String(b.topic)));
          }, [subjects, selectedSubId]);

          // FUNÇÕES DE PLANEJAMENTO E GESTÃO
          const handleAddSubject = (name) => {
            if (!name?.trim()) return;
            setSubjects([...(subjects || []), { id: `custom-${Date.now()}`, name: name.trim(), weight: 5, notes: '', logs: [], history: [], topics: [], topicStatuses: {} }]);
            setActiveModal(null);
          };

          const handleDeleteSubject = (id) => {
            setSubjects((subjects || []).filter(s => String(s.id) !== String(id))); 
            setCycleSequence((cycleSequence || []).filter(sid => getSafeId(sid) !== String(id)));
          };

          const updateSubject = (id, field, value) => setSubjects((subjects || []).map(s => s.id === id ? { ...s, [field]: value } : s));

          // GERAR FILA PROPORCIONAL
          const generateProportionalCycle = () => {
             const selectedIds = Object.keys(selectedToCycle).filter(id => selectedToCycle[id]);
             if(selectedIds.length === 0) return alert("Selecione ao menos uma matéria!");
             
             let totalWeight = 0;
             const selectedSubs = subjects.filter(s => selectedIds.includes(s.id));
             selectedSubs.forEach(s => totalWeight += Number(s.weight));
             
             let newCycle = [];
             selectedSubs.forEach(s => {
                 const count = Math.round((Number(s.weight) / totalWeight) * cycleBuilderSessions);
                 for(let i=0; i<count; i++) newCycle.push(s.id);
             });
             
             // Shuffle simples ou apenas ajusta pro tamanho exato
             while(newCycle.length > cycleBuilderSessions) newCycle.pop();
             while(newCycle.length < cycleBuilderSessions) newCycle.push(selectedIds[0]);
             
             setCycleSequence(newCycle.sort(() => Math.random() - 0.5)); // Embaralha a distribuição
             setCurrentCycleIndex(0);
          };

          // FUNÇÕES DE REGISTRO E EXECUÇÃO
          const handleResetGoal = () => {
              setGoalData({...goalData, startDate: new Date().toISOString()});
              alert("Nova meta iniciada! O tempo pendente foi zerado.");
          };

          const handleTopicManage = (action, oldTopic = null, newTopic = null) => {
              setSubjects(prev => prev.map(s => {
                  if (s.id !== selectedSubId) return s;
                  let updatedTopics = [...(s.topics || [])];
                  let updatedStatuses = {...(s.topicStatuses || {})};
                  
                  if (action === 'add' && newTopic) {
                      if (!updatedTopics.includes(newTopic)) updatedTopics.push(newTopic);
                  } else if (action === 'edit' && oldTopic && newTopic) {
                      const idx = updatedTopics.indexOf(oldTopic);
                      if (idx > -1) updatedTopics[idx] = newTopic;
                      if (updatedStatuses[oldTopic]) {
                          updatedStatuses[newTopic] = updatedStatuses[oldTopic];
                          delete updatedStatuses[oldTopic];
                      }
                  } else if (action === 'delete' && oldTopic) {
                      updatedTopics = updatedTopics.filter(t => t !== oldTopic);
                      delete updatedStatuses[oldTopic];
                  }
                  return { ...s, topics: updatedTopics, topicStatuses: updatedStatuses };
              }));
          };

          const updateTopicStatus = (subjectId, topicName, status) => {
            setSubjects(prev => prev.map(s => {
              if (s.id === subjectId) return { ...s, topicStatuses: { ...(s.topicStatuses || {}), [topicName]: status } };
              return s;
            }));
          };

          const advanceCycle = () => {
             if(!cycleSequence || cycleSequence.length === 0) return;
             setCurrentCycleIndex((currentCycleIndex + 1) % cycleSequence.length);
          };

          const registerSession = (id, bypass = false) => {
            if (!form.topic) return alert("Selecione o tópico!");

            const isMissingData = !form.time || (!form.q && form.q !== 0);
            if (!bypass && isMissingData) { 
              setConfirmModalData({ id }); return; 
            }

            // Filtra revisões válidas
            const validRevs = formRevs.filter(r => r.date !== '');

            setSubjects(prev => (prev || []).map(s => {
              if (s.id === id) {
                const dateStr = form.studyDate || new Date().toISOString().split('T')[0];
                const studyDateObj = new Date(dateStr + 'T12:00:00');
                
                const newLog = {
                  id: Date.now(), 
                  topic: form.topic, 
                  time: Number(form.time) || 0, 
                  q: Number(form.q) || 0,
                  h: Number(form.h) || 0, 
                  timestamp: Date.now(), 
                  date: studyDateObj.toLocaleDateString('pt-BR'), 
                  revisions: validRevs
                };
                
                return { ...s, logs: [newLog, ...(s.logs || [])] };
              }
              return s;
            }));

            setForm({ topic: '', time: 0, q: 0, h: 0, studyDate: new Date().toISOString().split('T')[0] });
            setFormRevs([{...defaultRev}]);
            setConfirmModalData(null);
            
            // Opcional: Se quiser dar um mini feedback visual na tela da matéria
          };

          const handleDeleteLog = (subjectId, logId) => {
            setSubjects(prev => prev.map(s => {
              if (s.id === subjectId) return { ...s, logs: (s.logs || []).filter(l => l.id !== logId) }; return s;
            }));
            setLogToDeleteId(null);
          };

          // BACKUP E RESTAURAÇÃO
          const backupData = () => {
            const data = { subjects, cycleSequence, currentCycleIndex, goalData, exportDate: new Date().toISOString() };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a'); link.href = url; link.download = `backup_pcpr_v3.json`; link.click();
            URL.revokeObjectURL(url);
          };

          const handleRestoreBackup = (e) => {
              const file = e.target.files[0];
              if(!file) return;
              const reader = new FileReader();
              reader.onload = (event) => {
                  try {
                      const data = JSON.parse(event.target.result);
                      if (data.subjects) setSubjects(data.subjects);
                      if (data.cycleSequence) setCycleSequence(data.cycleSequence);
                      if (data.currentCycleIndex !== undefined) setCurrentCycleIndex(data.currentCycleIndex);
                      if (data.goalData) setGoalData(data.goalData);
                      alert("Backup restaurado com sucesso!");
                  } catch(err) { alert("Erro ao ler o arquivo JSON."); }
              };
              reader.readAsText(file);
          };

          const handleReset = () => {
            setSubjects(JSON.parse(JSON.stringify(INITIAL_SUBJECTS)));
            setCycleSequence([]); setCurrentCycleIndex(0); 
            setGoalData({ totalHours: 100, targetDate: '', startDate: new Date().toISOString() });
            setActiveModal(null); 
          };

          // VARIAVEIS DA TELA PRINCIPAL
          const safeCycleArr = cycleSequence || [];
          const cycleActiveId = getSafeId(safeCycleArr[currentCycleIndex]);
          const currentSubInCycle = (subjects || []).find(s => String(s.id) === cycleActiveId);
          const currentSubject = (subjects || []).find(s => String(s.id) === String(selectedSubId));

          return (
            <div className="min-h-screen bg-slate-50 text-slate-900 flex flex-col md:flex-row font-sans relative overflow-x-hidden">
              
              {/* MODAIS */}
              {activeModal === 'add' && (
                <div className="fixed inset-0 z-[100] flex items-center justify-center bg-slate-950/60 backdrop-blur-sm p-4">
                  <div className="bg-white rounded-[32px] p-10 w-full max-w-md shadow-2xl animate-in zoom-in duration-200">
                    <h3 className="text-2xl font-black uppercase tracking-tighter mb-6">Nova Disciplina</h3>
                    <input autoFocus type="text" id="subInput" placeholder="Ex: Medicina Legal" className="w-full bg-slate-100 p-5 rounded-2xl text-sm font-bold border-none outline-none focus:ring-2 ring-blue-500 mb-8" onKeyDown={(e) => { if(e.key === 'Enter') handleAddSubject(e.target.value); }} />
                    <div className="flex gap-4">
                      <button onClick={() => handleAddSubject(document.getElementById('subInput').value)} className="flex-1 bg-blue-600 text-white py-4 rounded-2xl font-black uppercase tracking-widest text-xs cursor-pointer">Adicionar</button>
                      <button onClick={() => setActiveModal(null)} className="flex-1 bg-slate-100 text-slate-500 py-4 rounded-2xl font-black uppercase tracking-widest text-xs cursor-pointer">Cancelar</button>
                    </div>
                  </div>
                </div>
              )}
              {activeModal === 'reset' && (
                <div className="fixed inset-0 z-[100] flex items-center justify-center bg-slate-950/60 backdrop-blur-sm p-4">
                  <div className="bg-white rounded-[32px] p-10 w-full max-w-md shadow-2xl animate-in zoom-in duration-200 text-center">
                    <div className="bg-red-50 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-6"><Icon name="alert-triangle" className="text-red-600" size={40} /></div>
                    <h3 className="text-2xl font-black uppercase tracking-tighter mb-4">Zerar Tudo?</h3>
                    <div className="flex gap-4">
                      <button onClick={handleReset} className="flex-1 bg-red-600 text-white py-4 rounded-2xl font-black uppercase tracking-widest text-xs cursor-pointer">Sim, Limpar</button>
                      <button onClick={() => setActiveModal(null)} className="flex-1 bg-slate-100 text-slate-500 py-4 rounded-2xl font-black uppercase tracking-widest text-xs cursor-pointer">Cancelar</button>
                    </div>
                  </div>
                </div>
              )}

              {/* BARRA LATERAL (MENU) */}
              <aside className="fixed bottom-0 left-0 w-full bg-white border-t border-slate-200 flex flex-row justify-around items-center z-50 h-20 md:static md:w-72 md:h-screen md:flex-col md:justify-start md:border-t-0 md:border-r md:shrink-0 overflow-y-auto shadow-[0_-10px_40px_rgba(0,0,0,0.05)] md:shadow-none">
                  <div className="hidden md:flex p-8 border-b border-slate-100 items-center gap-4 w-full">
                      <div className="bg-blue-600 p-2.5 rounded-xl text-white shadow-lg"><Icon name="target" size={24} /></div>
                      <div><h1 className="font-black text-xl text-blue-600 uppercase leading-none tracking-tighter">PCPR Pro</h1><p className="text-[10px] font-bold text-slate-400 uppercase tracking-widest mt-1">Delegado V3.0</p></div>
                  </div>
                  <nav className="flex flex-row md:flex-col p-2 md:p-4 gap-2 md:space-y-2 w-full justify-around md:justify-start">
                      <button onClick={() => setActiveTab('painel')} className={`flex flex-col md:flex-row items-center gap-1 md:gap-3 p-2 md:px-5 md:py-4 rounded-2xl transition-all cursor-pointer ${activeTab === 'painel' ? 'text-blue-600 md:bg-blue-600 md:text-white md:shadow-xl font-bold' : 'text-slate-500 hover:bg-slate-50'}`}><Icon name="play-circle" size={24} className="md:w-5 md:h-5" /> <span className="text-[10px] md:text-sm font-bold uppercase md:capitalize tracking-widest mt-1 md:mt-0">Painel</span></button>
                      <button onClick={() => setActiveTab('planejamento')} className={`flex flex-col md:flex-row items-center gap-1 md:gap-3 p-2 md:px-5 md:py-4 rounded-2xl transition-all cursor-pointer ${activeTab === 'planejamento' ? 'text-indigo-600 md:bg-indigo-600 md:text-white md:shadow-xl font-bold' : 'text-slate-500 hover:bg-slate-50'}`}><Icon name="compass" size={24} className="md:w-5 md:h-5" /> <span className="text-[10px] md:text-sm font-bold uppercase md:capitalize tracking-widest mt-1 md:mt-0">Estratégia</span></button>
                      <button onClick={() => setActiveTab('revisoes')} className={`flex flex-col md:flex-row items-center gap-1 md:gap-3 p-2 md:px-5 md:py-4 rounded-2xl transition-all cursor-pointer relative ${activeTab === 'revisoes' ? 'text-amber-500 md:bg-amber-500 md:text-white md:shadow-xl font-bold' : 'text-slate-500 hover:bg-slate-50'}`}>
                          <Icon name="clock" size={24} className="md:w-5 md:h-5" /> <span className="text-[10px] md:text-sm font-bold uppercase md:capitalize tracking-widest mt-1 md:mt-0">Revisões</span>
                      </button>

                      <div className="hidden md:block pt-6 pb-2 px-5 text-[10px] font-black text-slate-400 uppercase tracking-widest">Matérias</div>
                      {(subjects || []).map(s => (
                          <button key={s.id} onClick={() => { setSelectedSubId(s.id); setActiveTab('materia'); }} className={`hidden md:flex w-full text-left px-5 py-3 rounded-xl text-xs font-bold transition-all items-center justify-between cursor-pointer ${selectedSubId === s.id && activeTab === 'materia' ? 'bg-slate-100 text-slate-800 border-l-4 border-slate-600' : 'text-slate-500 hover:bg-slate-50 border-l-4 border-transparent'}`}>
                              <span className="truncate pr-2">{String(s.name)}</span>{cycleActiveId === String(s.id) && <Icon name="zap" size={12} className="text-amber-500" />}
                          </button>
                      ))}
                  </nav>
              </aside>

              <main className="flex-1 p-4 md:p-8 overflow-y-auto bg-slate-50 pb-28 md:pb-8">
                
                {/* ABA PAINEL (EXECUÇÃO) */}
                {activeTab === 'painel' && (
                  <div className="max-w-5xl mx-auto space-y-8 animate-in fade-in duration-500">
                    
                    {/* CARD GIGANTE DO CICLO */}
                    {cycleSequence.length > 0 ? (
                        <div className="bg-white rounded-[32px] md:rounded-[40px] border border-slate-200 shadow-xl shadow-slate-200/40 overflow-hidden">
                            <div className="bg-gradient-to-br from-blue-700 to-indigo-900 p-8 md:p-12 text-white relative">
                                <Icon name="zap" className="absolute -right-4 -bottom-4 opacity-10 text-white" size={180} />
                                <div className="relative z-10 flex flex-col md:flex-row md:items-center justify-between gap-6">
                                    <div>
                                        <div className="flex items-center gap-3 mb-4">
                                            <span className="bg-white/20 px-3 py-1 rounded-full text-[10px] font-black uppercase tracking-widest">Sessão {currentCycleIndex + 1} de {cycleSequence.length}</span>
                                            <span className="text-blue-200 text-xs font-bold">Ciclo Ativo</span>
                                        </div>
                                        <h2 className="text-4xl md:text-5xl font-black uppercase tracking-tighter leading-none">{currentSubInCycle?.name || 'Matéria Excluída'}</h2>
                                    </div>
                                    <div className="flex flex-col sm:flex-row gap-3 w-full md:w-auto shrink-0 mt-4 md:mt-0">
                                        <button onClick={() => { setSelectedSubId(currentSubInCycle.id); setActiveTab('materia'); }} className="bg-white text-blue-700 px-8 py-4 rounded-2xl font-black uppercase tracking-widest text-xs shadow-lg hover:scale-105 active:scale-95 transition-all flex items-center justify-center gap-2 cursor-pointer"><Icon name="play" size={16}/> Ir para Matéria</button>
                                        <button onClick={advanceCycle} className="bg-blue-800/50 hover:bg-blue-900 text-white px-6 py-4 rounded-2xl font-black uppercase tracking-widest text-xs border border-blue-600/50 hover:border-blue-500 transition-all flex items-center justify-center gap-2 cursor-pointer"><Icon name="skip-forward" size={16}/> Avançar</button>
                                    </div>
                                </div>
                            </div>
                            
                            {/* A ESTEIRA (PRÓXIMAS 4) */}
                            <div className="p-4 md:p-6 bg-white flex gap-4 overflow-x-auto hide-scrollbar items-center">
                                <span className="text-[10px] font-black text-slate-400 uppercase tracking-widest shrink-0 ml-2">A seguir:</span>
                                {[1, 2, 3, 4].map(offset => {
                                    const nextIdx = (currentCycleIndex + offset) % cycleSequence.length;
                                    const nextId = cycleSequence[nextIdx];
                                    const nextSub = subjects.find(s => s.id === nextId);
                                    if(!nextSub) return null;
                                    return (
                                        <div key={offset} className="shrink-0 flex items-center gap-2 bg-slate-50 border border-slate-100 px-4 py-2.5 rounded-xl opacity-70">
                                            <span className="text-[9px] font-black text-slate-400">{(nextIdx + 1)}</span>
                                            <span className="text-[11px] font-bold text-slate-700 truncate max-w-[120px]">{nextSub.name}</span>
                                        </div>
                                    )
                                })}
                            </div>
                        </div>
                    ) : (
                        <div className="bg-blue-50 border border-blue-100 rounded-[32px] p-10 text-center">
                            <Icon name="compass" size={40} className="text-blue-500 mx-auto mb-4" />
                            <h3 className="text-xl font-black text-blue-900 uppercase tracking-tighter mb-2">Nenhum Ciclo Ativo</h3>
                            <p className="text-blue-600/70 text-sm font-bold mb-6">Vá até a aba Estratégia para montar o seu carrossel de estudos.</p>
                            <button onClick={() => setActiveTab('planejamento')} className="bg-blue-600 text-white px-6 py-3 rounded-xl font-black uppercase text-xs tracking-widest shadow-lg cursor-pointer">Montar Estratégia</button>
                        </div>
                    )}

                    {/* GRÁFICOS E MÉTRICAS */}
                    <div className="grid grid-cols-1 sm:grid-cols-3 gap-4 md:gap-6">
                      <div className="bg-white p-6 rounded-3xl border border-slate-200 shadow-sm flex flex-col justify-between">
                        <div><p className="text-[10px] font-black text-slate-400 uppercase tracking-widest">Estudado (Nova Meta)</p><p className="text-4xl font-black mt-1 text-slate-800">{stats.totalHoursGoal.toFixed(1)}h</p></div>
                        <div className="w-full h-2 bg-slate-100 rounded-full mt-4 overflow-hidden"><div className="h-full bg-blue-500" style={{ width: `${Math.min((stats.totalHoursGoal / (goalData.totalHours || 1)) * 100, 100)}%` }} /></div>
                      </div>
                      <div className="bg-white p-6 rounded-3xl border border-slate-200 shadow-sm flex flex-col justify-between">
                        <div><p className="text-[10px] font-black text-slate-400 uppercase tracking-widest">Total Histórico (Vida)</p><p className="text-4xl font-black mt-1 text-slate-800">{stats.totalHoursEver.toFixed(1)}h</p></div>
                        <p className="text-[10px] font-bold text-slate-400 mt-2">Todas as horas já registradas</p>
                      </div>
                      <div className="bg-white p-6 rounded-3xl border border-slate-200 shadow-sm flex flex-col justify-center text-center">
                        <p className="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">Aproveitamento Global</p><p className="text-4xl font-black text-green-600 tracking-tighter">{Math.round(stats.accuracy)}%</p><p className="text-[9px] font-bold text-slate-400 mt-2 uppercase tracking-widest">{stats.hTotal} / {stats.qTotal} questões</p>
                      </div>
                    </div>

                    {/* TABELA RAIO-X COM CORES */}
                    <section className="bg-white p-6 md:p-8 rounded-[32px] border border-slate-200 shadow-sm overflow-hidden">
                      <h3 className="text-xl font-black uppercase tracking-tighter mb-6 flex items-center gap-3"><Icon name="bar-chart-3" className="text-blue-600" size={24} /> Raio-X por Matéria</h3>
                      <div className="overflow-x-auto">
                        <table className="w-full text-left min-w-[600px]">
                          <thead className="text-[9px] font-black text-slate-400 uppercase border-b border-slate-100">
                            <tr><th className="pb-4 pr-4">Disciplina</th><th className="pb-4 text-center">Aproveitamento</th><th className="pb-4 text-center">Tempo na Meta</th><th className="pb-4 text-center">Status</th><th className="pb-4 text-right">Pendências</th></tr>
                          </thead>
                          <tbody className="divide-y divide-slate-50">
                            {(metrics || []).map(m => {
                              // Acha o último estudo geral na matéria para a cor de alerta
                              let lastStudyObj = null;
                              (m.logs || []).forEach(l => {
                                  const d = new Date(l.timestamp);
                                  if(!lastStudyObj || d > lastStudyObj) lastStudyObj = d;
                              });
                              let alertBadge = <span className="text-[10px] font-bold text-slate-400">Em dia</span>;
                              if(lastStudyObj){
                                  const diffDays = Math.floor((new Date().getTime() - lastStudyObj.getTime()) / (1000 * 60 * 60 * 24));
                                  if(diffDays > 25) alertBadge = <span className="bg-red-100 text-red-700 px-2 py-1 rounded text-[9px] font-black uppercase">+25d sem estudo</span>;
                                  else if (diffDays > 15) alertBadge = <span className="bg-amber-100 text-amber-700 px-2 py-1 rounded text-[9px] font-black uppercase">+15d sem estudo</span>;
                              } else {
                                  alertBadge = <span className="text-[9px] font-bold text-slate-300">Nunca</span>;
                              }

                              return (
                              <tr key={m.id} className="text-sm hover:bg-slate-50/50 transition-all">
                                <td className="py-4 uppercase tracking-tighter text-slate-700 font-black pr-4 text-xs">{String(m.name)}</td>
                                <td className="py-4 text-center"><span className={`px-2 py-1 rounded-lg text-[10px] font-black ${m.perf >= 80 ? 'bg-green-100 text-green-700' : 'bg-blue-50 text-blue-600'}`}>{m.perf}%</span></td>
                                <td className="py-4 text-center text-slate-800 font-bold text-xs">{m.totalStudyHoursGoal.toFixed(1)}h <span className="text-[9px] text-slate-400">/ {m.suggested.toFixed(1)}h</span></td>
                                <td className="py-4 text-center">{alertBadge}</td>
                                <td className="py-4 text-right"><div className="flex flex-col items-end"><span className="text-[10px] text-slate-500 uppercase tracking-widest font-black">{m.unstudiedCount} tópicos faltam</span></div></td>
                              </tr>
                            )})}
                          </tbody>
                        </table>
                      </div>
                    </section>
                  </div>
                )}

                {/* ABA ESTRATÉGIA / PLANEJAMENTO (NOVA) */}
                {activeTab === 'planejamento' && (
                   <div className="max-w-5xl mx-auto space-y-12 animate-in fade-in duration-500">
                      
                      {/* NÍVEL 1: O ALVO (MARCO ZERO) */}
                      <section className="bg-white p-8 rounded-[32px] border border-slate-200 shadow-sm flex flex-col md:flex-row gap-8 items-center">
                          <div className="flex-1 space-y-2">
                              <h3 className="text-2xl font-black uppercase tracking-tighter flex items-center gap-2"><Icon name="flag" className="text-indigo-600"/> O Alvo (Meta)</h3>
                              <p className="text-xs font-bold text-slate-400 leading-relaxed">Defina a meta de horas e clique em iniciar. Isso zera o tempo pendente sem apagar seu histórico global.</p>
                          </div>
                          <div className="flex gap-4 w-full md:w-auto">
                              <div className="space-y-1"><label className="text-[9px] font-black uppercase text-slate-400 tracking-widest ml-1">Meta (h)</label><input type="number" value={goalData.totalHours} onChange={e => setGoalData({...goalData, totalHours: Number(e.target.value)})} className="w-24 bg-slate-50 p-4 rounded-xl text-lg font-black border border-slate-200 text-center outline-none focus:ring-2 ring-indigo-500" /></div>
                              <div className="space-y-1"><label className="text-[9px] font-black uppercase text-slate-400 tracking-widest ml-1">Data Prova</label><input type="date" value={goalData.targetDate} onChange={e => setGoalData({...goalData, targetDate: e.target.value})} className="w-full bg-slate-50 p-4 rounded-xl text-xs font-bold border border-slate-200 outline-none focus:ring-2 ring-indigo-500" /></div>
                          </div>
                          <button onClick={handleResetGoal} className="w-full md:w-auto bg-indigo-600 text-white px-8 py-5 rounded-xl font-black uppercase tracking-widest text-[10px] shadow-lg hover:bg-indigo-700 transition-all cursor-pointer">Iniciar Nova Meta</button>
                      </section>

                      {/* NÍVEL 2: O CONSTRUTOR DE CICLO */}
                      <section className="bg-white p-8 rounded-[32px] border border-slate-200 shadow-sm">
                          <h3 className="text-2xl font-black uppercase tracking-tighter mb-8 flex items-center gap-2"><Icon name="refresh-cw" className="text-blue-600"/> Carrossel do Ciclo</h3>
                          
                          <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
                              {/* PAINEL DE SELEÇÃO E GERAÇÃO */}
                              <div className="lg:col-span-1 space-y-6 bg-slate-50 p-6 rounded-2xl border border-slate-100">
                                  <div className="flex gap-4">
                                      <div className="flex-1 space-y-1"><label className="text-[9px] font-black uppercase text-slate-400 tracking-widest">Sessões</label><input type="number" value={cycleBuilderSessions} onChange={e=>setCycleBuilderSessions(Number(e.target.value))} className="w-full p-3 rounded-lg text-sm font-bold border border-slate-200 text-center outline-none" /></div>
                                      <div className="flex-1 space-y-1"><label className="text-[9px] font-black uppercase text-slate-400 tracking-widest">Tempo/médio</label><input type="number" defaultValue={45} className="w-full p-3 rounded-lg text-sm font-bold border border-slate-200 text-center outline-none" /></div>
                                  </div>
                                  <div className="space-y-2 max-h-[250px] overflow-y-auto pr-2">
                                      {subjects.map(s => (
                                          <label key={s.id} className="flex items-center gap-3 p-2 hover:bg-white rounded-lg cursor-pointer transition-colors border border-transparent hover:border-slate-200">
                                              <input type="checkbox" checked={!!selectedToCycle[s.id]} onChange={(e) => setSelectedToCycle({...selectedToCycle, [s.id]: e.target.checked})} className="w-4 h-4 text-blue-600 rounded border-slate-300 focus:ring-blue-500" />
                                              <span className="text-xs font-bold text-slate-700 truncate">{s.name} <span className="text-[9px] text-slate-400">(P: {s.weight})</span></span>
                                          </label>
                                      ))}
                                  </div>
                                  <button onClick={generateProportionalCycle} className="w-full bg-blue-600 text-white py-3 rounded-xl font-black uppercase tracking-widest text-[10px] hover:bg-blue-700 transition-all cursor-pointer">⚡ Gerar Fila Proporcional</button>
                              </div>

                              {/* A FILA RESULTANTE */}
                              <div className="lg:col-span-2 bg-slate-900 p-6 rounded-2xl text-white relative">
                                  <div className="flex justify-between items-end mb-6 border-b border-slate-800 pb-4">
                                      <div><p className="text-[10px] font-black text-slate-500 uppercase tracking-widest">A Sequência da Catraca</p><p className="text-sm font-bold mt-1">Total: {cycleSequence.length} sessões</p></div>
                                      <button onClick={()=> {setCycleSequence([]); setCurrentCycleIndex(0);}} className="text-[10px] font-black text-red-400 uppercase tracking-widest hover:text-red-300 cursor-pointer flex items-center gap-1"><Icon name="trash-2" size={12}/> Limpar</button>
                                  </div>
                                  
                                  <div className="grid grid-cols-1 sm:grid-cols-2 gap-3 max-h-[350px] overflow-y-auto pr-2 custom-scroll">
                                      {cycleSequence.map((sid, idx) => {
                                          const sub = subjects.find(s=> s.id === sid);
                                          return (
                                          <div key={`${sid}-${idx}`} className="flex items-center justify-between bg-slate-800 p-3 rounded-xl border border-slate-700">
                                              <div className="flex items-center gap-3 overflow-hidden">
                                                  <span className="bg-slate-900 text-slate-500 w-6 h-6 rounded flex items-center justify-center text-[10px] font-black shrink-0">{idx+1}</span>
                                                  <span className="text-xs font-bold truncate">{sub?.name || '---'}</span>
                                              </div>
                                              <div className="flex gap-1 shrink-0 ml-2">
                                                  <button onClick={() => { const n=[...cycleSequence]; if(idx>0){ n[idx]=n[idx-1]; n[idx-1]=sid; setCycleSequence(n); } }} className="text-slate-500 hover:text-white cursor-pointer"><Icon name="arrow-up" size={14}/></button>
                                                  <button onClick={() => { const n=[...cycleSequence]; if(idx<n.length-1){ n[idx]=n[idx+1]; n[idx+1]=sid; setCycleSequence(n); } }} className="text-slate-500 hover:text-white cursor-pointer"><Icon name="arrow-down" size={14}/></button>
                                                  <button onClick={() => { setCycleSequence(cycleSequence.filter((_, i) => i !== idx)); }} className="text-slate-500 hover:text-red-400 ml-1 cursor-pointer"><Icon name="x" size={14}/></button>
                                              </div>
                                          </div>
                                      )})}
                                  </div>
                              </div>
                          </div>
                      </section>

                      {/* NÍVEL 3: GESTÃO DO BANCO DE DADOS (MATÉRIAS E JSON) */}
                      <section className="bg-white p-8 rounded-[32px] border border-slate-200 shadow-sm">
                        <div className="flex flex-col md:flex-row justify-between items-center gap-6 mb-8">
                            <h3 className="text-xl font-black uppercase tracking-tighter flex items-center gap-2"><Icon name="database" className="text-slate-400" /> Matérias do Edital</h3>
                            <div className="flex flex-wrap gap-2 justify-center w-full md:w-auto">
                                <button onClick={() => setActiveModal('add')} className="flex-1 md:flex-none justify-center bg-slate-800 text-white px-5 py-2.5 rounded-lg text-[10px] font-black uppercase tracking-widest flex items-center gap-2 cursor-pointer hover:bg-slate-900"><Icon name="plus" size={14} /> Nova</button>
                                <button onClick={backupData} className="flex-1 md:flex-none justify-center bg-blue-100 text-blue-700 px-5 py-2.5 rounded-lg text-[10px] font-black uppercase tracking-widest flex items-center gap-2 cursor-pointer hover:bg-blue-200"><Icon name="download" size={14} /> Backup</button>
                                <label className="flex-1 md:flex-none justify-center bg-green-100 text-green-700 px-5 py-2.5 rounded-lg text-[10px] font-black uppercase tracking-widest flex items-center gap-2 cursor-pointer hover:bg-green-200"><Icon name="upload" size={14} /> Restaurar<input type="file" accept=".json" className="hidden" onChange={handleRestoreBackup} /></label>
                                <button onClick={() => setActiveModal('reset')} className="flex-1 md:flex-none justify-center bg-red-50 text-red-600 px-5 py-2.5 rounded-lg text-[10px] font-black uppercase tracking-widest flex items-center gap-2 cursor-pointer hover:bg-red-100"><Icon name="trash-2" size={14} /> Zerar Sistema</button>
                            </div>
                        </div>
                        <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                            {(subjects || []).map(s => (
                                <div key={s.id} className="p-4 rounded-2xl bg-slate-50 border border-slate-100 group transition-all relative">
                                    <div className="space-y-3">
                                        <div className="flex items-center gap-2"><Icon name="edit-3" size={12} className="text-slate-300" /><input type="text" value={s.name} onChange={(e) => updateSubject(s.id, 'name', e.target.value)} className="bg-transparent border-none text-xs font-black uppercase outline-none focus:text-blue-600 w-full tracking-tight" /></div>
                                        <div className="flex items-center justify-between pt-2 border-t border-slate-200/50">
                                            <div className="flex items-center gap-2"><span className="text-[9px] font-black text-slate-400 uppercase tracking-widest">Peso:</span><input type="number" value={s.weight} onChange={(e) => updateSubject(s.id, 'weight', Number(e.target.value))} className="w-12 bg-white border border-slate-200 rounded p-1 text-center font-black text-xs outline-none" /></div>
                                            <button onClick={() => handleDeleteSubject(s.id)} className="text-slate-300 hover:text-red-500 cursor-pointer"><Icon name="trash-2" size={14}/></button>
                                        </div>
                                    </div>
                                </div>
                            ))}
                        </div>
                      </section>
                   </div>
                )}

                {/* ABA MATÉRIA (REGISTRO E GESTÃO DE TÓPICOS) */}
                {activeTab === 'materia' && currentSubject && (
                  <div className="max-w-5xl mx-auto space-y-8 animate-in slide-in-from-right duration-300">
                    <header className="flex flex-col md:flex-row md:items-end justify-between gap-6 pb-6 border-b border-slate-200">
                      <div>
                          <button onClick={() => setActiveTab('painel')} className="text-[10px] font-black text-slate-400 hover:text-blue-600 uppercase tracking-widest mb-4 flex items-center gap-2 cursor-pointer"><Icon name="arrow-left" size={14} /> Voltar ao Painel</button>
                          <h2 className="text-4xl md:text-5xl font-black uppercase tracking-tighter text-slate-800 leading-none">{String(currentSubject.name)}</h2>
                      </div>
                    </header>

                    {/* REGISTRAR ESTUDO (COM MÚLTIPLAS REVISÕES) */}
                    <div className="p-6 md:p-8 rounded-[32px] border border-slate-200 bg-white shadow-sm relative">
                      <h3 className="text-[10px] font-black uppercase text-slate-400 tracking-widest flex items-center gap-2 mb-6"><Icon name="check-circle" size={16}/> Registrar Sessão de Estudo</h3>
                      
                      <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div className="space-y-1"><label className="text-[9px] font-black uppercase text-slate-500 ml-1 tracking-widest">Tópico</label>
                          <select value={form.topic} onChange={e => setForm({...form, topic: e.target.value})} className="w-full bg-slate-50 p-3 rounded-xl text-xs font-bold border border-slate-200 outline-none">
                            <option value="">Selecione o tema...</option>
                            {(currentSubject.topics || []).sort((a, b) => String(a).localeCompare(String(b))).map(t => <option key={t} value={t}>{String(t)}</option>)}
                          </select>
                        </div>
                        <div className="grid grid-cols-2 gap-4">
                            <div className="space-y-1"><label className="text-[9px] font-black uppercase text-slate-500 ml-1 tracking-widest">Data</label><input type="date" value={form.studyDate} onChange={e => setForm({...form, studyDate: e.target.value})} className="w-full bg-slate-50 p-3 rounded-xl text-xs font-bold border border-slate-200 outline-none" /></div>
                            <div className="space-y-1"><label className="text-[9px] font-black uppercase text-slate-500 ml-1 tracking-widest">Tempo (m)</label><input type="number" value={form.time} onChange={e => setForm({...form, time: e.target.value})} className="w-full bg-slate-50 p-3 rounded-xl text-xs font-bold border border-slate-200 outline-none text-center" /></div>
                        </div>
                        <div className="grid grid-cols-2 gap-4">
                          <div className="space-y-1"><label className="text-[9px] font-black uppercase text-slate-500 ml-1 tracking-widest">Questões</label><input type="number" value={form.q} onChange={e => setForm({...form, q: e.target.value})} className="w-full bg-slate-50 p-3 rounded-xl text-xs font-bold border border-slate-200 text-center outline-none" /></div>
                          <div className="space-y-1"><label className="text-[9px] font-black uppercase text-slate-500 ml-1 tracking-widest">Acertos</label><input type="number" value={form.h} onChange={e => setForm({...form, h: e.target.value})} className="w-full bg-slate-50 p-3 rounded-xl text-xs font-bold border border-slate-200 text-center outline-none" /></div>
                        </div>
                        
                        {/* BLOCO DE REVISÕES DINÂMICO */}
                        <div className="bg-amber-50/50 p-4 rounded-2xl border border-amber-100/50">
                           <div className="flex justify-between items-center mb-2">
                               <label className="text-[9px] font-black uppercase text-amber-600 ml-1 tracking-widest">Agendar Revisões</label>
                               <button onClick={()=> setFormRevs([...formRevs, {...defaultRev}])} className="text-amber-600 hover:text-amber-800 bg-amber-100 p-1 rounded cursor-pointer flex items-center gap-1 text-[9px] font-black uppercase"><Icon name="plus" size={12}/> Adicionar</button>
                           </div>
                           <div className="space-y-2 max-h-[140px] overflow-y-auto pr-1">
                               {formRevs.map((rev, idx) => (
                                   <div key={idx} className="flex gap-2 items-center">
                                       <input type="date" value={rev.date} onChange={e => { const n=[...formRevs]; n[idx].date=e.target.value; setFormRevs(n); }} className="flex-1 bg-white p-2.5 rounded-lg text-xs font-bold border border-amber-200 outline-none" />
                                       <select value={rev.type} onChange={e => { const n=[...formRevs]; n[idx].type=e.target.value; setFormRevs(n); }} className="w-24 bg-white p-2.5 rounded-lg text-[10px] font-bold border border-amber-200 outline-none">
                                           <option value="completa">Completa</option><option value="breve">Breve</option>
                                       </select>
                                       {idx > 0 && <button onClick={() => setFormRevs(formRevs.filter((_, i) => i !== idx))} className="text-red-400 hover:text-red-600 p-2 cursor-pointer"><Icon name="x" size={14}/></button>}
                                   </div>
                               ))}
                           </div>
                        </div>
                      </div>
                      <button onClick={() => registerSession(currentSubject.id)} className="w-full bg-blue-600 text-white py-4 rounded-xl text-[10px] font-black uppercase tracking-widest shadow-lg shadow-blue-500/20 hover:bg-blue-700 transition-all mt-6 cursor-pointer">Salvar no Diário de Bordo</button>
                    </div>

                    {/* GERENCIADOR DE TÓPICOS DA MATÉRIA E DESEMPENHO */}
                    <div className="bg-white p-6 md:p-8 rounded-[32px] border border-slate-200 shadow-sm overflow-hidden">
                       <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-8">
                           <div className="flex items-center gap-2"><Icon name="list" size={18} className="text-slate-400" /><h3 className="text-[10px] font-black uppercase text-slate-400 tracking-widest">Tópicos do Edital</h3></div>
                           
                           {/* Adicionar Novo Tópico Direto na Tabela */}
                           <div className="flex items-center gap-2 w-full md:w-auto">
                               <input type="text" placeholder="Novo Assunto..." value={newTopicValue} onChange={e => setNewTopicValue(e.target.value)} onKeyDown={e => {if(e.key === 'Enter'){ handleTopicManage('add', null, newTopicValue); setNewTopicValue('');}}} className="flex-1 md:w-48 bg-slate-50 border border-slate-200 p-2 rounded-lg text-[10px] font-bold outline-none" />
                               <button onClick={()=>{ handleTopicManage('add', null, newTopicValue); setNewTopicValue('');}} className="bg-slate-800 text-white p-2 rounded-lg cursor-pointer hover:bg-slate-900"><Icon name="plus" size={14}/></button>
                           </div>
                       </div>
                       
                       <div className="overflow-x-auto pb-4">
                           <div className="min-w-[800px]">
                               <div className="grid grid-cols-12 gap-2 px-4 pb-4 border-b border-slate-100 text-[9px] font-black text-slate-400 uppercase tracking-widest mb-4">
                                   <div className="col-span-4">Assunto / Tópico (Editável)</div>
                                   <div className="col-span-2 text-center">Status</div>
                                   <div className="col-span-2 text-center">Último Estudo</div>
                                   <div className="col-span-1 text-center">Tempo</div>
                                   <div className="col-span-1 text-center">Q / A</div>
                                   <div className="col-span-1 text-right">Aprov.</div>
                                   <div className="col-span-1"></div>
                               </div>
                               <div className="space-y-1 max-h-[400px] overflow-y-auto pr-2 custom-scroll">
                                 {(topicStats || []).map((ts, idx) => {
                                   const perc = ts.q > 0 ? Math.round((ts.h / ts.q) * 100) : 0;
                                   const isEditing = editingTopicIdx === idx;
                                   
                                   let dateColorClass = "text-slate-400";
                                   if (ts.lastStudyDateObj) {
                                       const today = new Date(); today.setHours(0,0,0,0);
                                       const studyDate = new Date(ts.lastStudyDateObj); studyDate.setHours(0,0,0,0);
                                       const diffDays = Math.floor((today.getTime() - studyDate.getTime()) / (1000 * 60 * 60 * 24));
                                       
                                       if (diffDays > 25) dateColorClass = "text-red-700 font-black bg-red-50 border border-red-100 px-2 py-0.5 rounded";
                                       else if (diffDays > 15) dateColorClass = "text-amber-600 font-black bg-amber-50 border border-amber-100 px-2 py-0.5 rounded";
                                       else dateColorClass = "text-slate-600 font-bold";
                                   }

                                   return (
                                     <div key={idx} className="grid grid-cols-12 items-center gap-2 px-4 py-2 rounded-xl border border-slate-50 hover:bg-slate-50 transition-all">
                                       
                                       {/* TÓPICO (Com Edição) */}
                                       <div className="col-span-4 flex items-center gap-2">
                                           {isEditing ? (
                                               <input type="text" autoFocus value={editTopicValue} onChange={e=>setEditTopicValue(e.target.value)} onBlur={()=>{handleTopicManage('edit', ts.topic, editTopicValue); setEditingTopicIdx(null);}} onKeyDown={e=>{if(e.key==='Enter') e.target.blur()}} className="w-full text-[10px] font-black uppercase border-b border-blue-400 outline-none bg-transparent" />
                                           ) : (
                                               <span onDoubleClick={()=>{setEditingTopicIdx(idx); setEditTopicValue(ts.topic);}} className="text-[10px] font-black uppercase text-slate-700 block truncate cursor-text" title={String(ts.topic)}>{String(ts.topic)}</span>
                                           )}
                                       </div>
                                       
                                       {/* STATUS (Incluindo Não Estudar) */}
                                       <div className="col-span-2 flex justify-center">
                                            <select value={ts.status} onChange={(e) => updateTopicStatus(currentSubject.id, ts.topic, e.target.value)} className={`text-[9px] font-black uppercase px-2 py-1.5 rounded outline-none cursor-pointer border ${ts.status === 'Finalizado' ? 'bg-green-50 text-green-700 border-green-200' : ts.status === 'Priorizar' ? 'bg-amber-50 text-amber-700 border-amber-200' : ts.status === 'Estudando' ? 'bg-blue-50 text-blue-700 border-blue-200' : ts.status === 'Não Estudar' ? 'bg-slate-200 text-slate-500 border-slate-300' : 'bg-white text-slate-600 border-slate-200'}`}>
                                                <option value="Estudar">Estudar</option>
                                                <option value="Estudando">Estudando</option>
                                                <option value="Priorizar">Priorizar</option>
                                                <option value="Finalizado">Finalizado</option>
                                                <option value="Não Estudar">Não Estudar</option>
                                            </select>
                                       </div>

                                       <div className="col-span-2 flex justify-center items-center"><span className={`text-[9px] tracking-widest ${dateColorClass}`}>{ts.lastStudyDateStr !== '-' ? ts.lastStudyDateStr : '---'}</span></div>
                                       <div className="col-span-1 text-center"><span className="text-[10px] font-bold text-blue-600">{Number(ts.time)} <span className="text-[8px] opacity-60">m</span></span></div>
                                       <div className="col-span-1 text-center text-[10px] font-black text-slate-500">{Number(ts.h)}/{Number(ts.q)}</div>
                                       <div className="col-span-1 text-right"><span className={`text-[10px] font-black px-1.5 py-0.5 rounded ${ts.q === 0 ? 'text-slate-400' : perc >= 80 ? 'text-green-600' : 'text-red-600'}`}>{perc}%</span></div>
                                       
                                       <div className="col-span-1 flex justify-end gap-1">
                                           <button onClick={()=>{setEditingTopicIdx(idx); setEditTopicValue(ts.topic);}} className="text-slate-300 hover:text-blue-500 p-1 cursor-pointer"><Icon name="edit-2" size={12}/></button>
                                           <button onClick={()=>{if(confirm('Excluir este assunto permanentemente?')) handleTopicManage('delete', ts.topic);}} className="text-slate-300 hover:text-red-500 p-1 cursor-pointer"><Icon name="trash-2" size={12}/></button>
                                       </div>
                                     </div>
                                   );
                                 })}
                               </div>
                           </div>
                       </div>
                    </div>

                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div className="bg-white p-6 rounded-3xl border border-slate-200 shadow-sm flex flex-col h-[300px]">
                           <h3 className="text-[10px] font-black uppercase text-slate-400 tracking-widest mb-4 flex items-center gap-2"><Icon name="file-text" size={16}/> Observações</h3>
                           <textarea className="flex-1 bg-slate-50 border border-slate-100 rounded-xl p-4 text-xs outline-none resize-none font-medium leading-relaxed" placeholder="Jurisprudência, mnemónicos e pontos de atenção..." value={String(currentSubject.notes || '')} onChange={(e) => updateSubject(currentSubject.id, 'notes', e.target.value)} />
                        </div>

                        <div className="lg:col-span-2 bg-white p-6 rounded-3xl border border-slate-200 shadow-sm h-[300px] overflow-hidden flex flex-col">
                           <h3 className="text-[10px] font-black uppercase text-slate-400 tracking-widest mb-4 flex items-center gap-2 shrink-0"><Icon name="history" size={16}/> Histórico de Registros</h3>
                           <div className="overflow-y-auto pr-2 custom-scroll flex-1">
                               <div className="space-y-2">
                                 {(currentSubject.logs || []).slice(0, 30).map(l => (
                                   <div key={l.id} className="flex flex-col sm:flex-row sm:items-center justify-between gap-2 p-3 bg-slate-50 rounded-xl border border-slate-100 hover:bg-white transition-all">
                                     <div className="flex-1 min-w-0">
                                        <p className="text-[9px] font-black text-slate-400 uppercase">{String(l.date)}</p>
                                        <h4 className="text-[11px] font-black uppercase text-slate-700 truncate">{String(l.topic)}</h4>
                                     </div>
                                     <div className="flex items-center gap-4 shrink-0">
                                         <p className="text-[10px] font-black text-blue-600">{Number(l.time)}m</p>
                                         <p className="text-[10px] font-black text-slate-500 w-8 text-center">{Number(l.h)}/{Number(l.q)}</p>
                                         <button onClick={() => {if(confirm('Apagar registro?')) handleDeleteLog(currentSubject.id, l.id);}} className="text-slate-300 hover:text-red-500 p-1 cursor-pointer"><Icon name="x" size={14}/></button>
                                     </div>
                                   </div>
                                 ))}
                               </div>
                           </div>
                        </div>
                    </div>
                  </div>
                )}

                {/* ABA REVISÕES (MULTIDATAS) */}
                {activeTab === 'revisoes' && (
                  <div className="max-w-4xl mx-auto space-y-8 animate-in fade-in duration-500">
                    <header className="flex flex-col md:flex-row md:items-end justify-between gap-6 border-b border-slate-200 pb-8">
                      <div>
                          <h2 className="text-4xl md:text-5xl font-black uppercase tracking-tighter text-slate-800">Esteira de Revisão</h2>
                          <p className="text-xs font-bold text-slate-400 mt-2">Estudos agendados independentes do ciclo</p>
                      </div>
                      <div className="flex items-center gap-3">
                        <select value={revFilterType} onChange={e => setRevFilterType(e.target.value)} className="bg-white border border-slate-200 px-4 py-2.5 rounded-xl text-[10px] font-black uppercase tracking-widest outline-none shadow-sm">
                          <option value="all">Todas</option><option value="completa">Completa</option><option value="breve">Breve</option>
                        </select>
                        <button onClick={() => setShowFutureRevisions(!showFutureRevisions)} className={`px-4 py-2.5 rounded-xl text-[10px] font-black uppercase tracking-widest transition-all cursor-pointer ${showFutureRevisions ? 'bg-amber-500 text-white shadow-md' : 'bg-slate-200 text-slate-600'}`}>{showFutureRevisions ? 'Focar Vencidas' : 'Ver Tudo'}</button>
                      </div>
                    </header>
                    
                    <div className="flex flex-col gap-3">
                      {(revisionList || []).length === 0 && <div className="p-16 text-center bg-transparent border-2 border-dashed border-slate-200 rounded-3xl text-slate-400 font-bold uppercase tracking-widest">Esteira Limpa</div>}
                      
                      {(revisionList || []).map((rev, i) => (
                        <div key={`${rev.logId}-${rev.revDateOrig}-${i}`} className="bg-white p-5 rounded-2xl border border-slate-200 shadow-sm flex flex-col sm:flex-row sm:items-center justify-between gap-4 group">
                          
                          <div className="flex-1 min-w-0">
                            <div className="flex items-center gap-2 mb-1">
                               <span className={`text-[9px] font-black px-2 py-0.5 rounded uppercase tracking-widest ${rev.daysLeft <= 0 ? 'bg-red-100 text-red-700' : 'bg-amber-100 text-amber-700'}`}>{rev.daysLeft <= 0 ? 'Vencida' : `Em ${rev.daysLeft} d`}</span>
                               <span className="text-[9px] font-black text-slate-400 uppercase tracking-widest">{String(rev.subjectName)}</span>
                               <span className="text-[9px] font-black text-slate-300 uppercase">| {rev.type}</span>
                            </div>
                            <h4 className="font-black text-sm text-slate-800 truncate">{String(rev.topic)}</h4>
                          </div>

                          <button onClick={() => { setSelectedSubId(rev.subjectId); setActiveTab('materia'); setForm({...form, topic: rev.topic}); }} className="shrink-0 px-6 py-3 bg-slate-50 border border-slate-200 text-slate-600 rounded-xl hover:bg-blue-600 hover:text-white hover:border-blue-600 transition-all text-[10px] font-black uppercase cursor-pointer">
                             Estudar Agora
                          </button>
                        </div>
                      ))}
                    </div>
                  </div>
                )}
              </main>
            </div>
          );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>

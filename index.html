<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PCPR Pro - Dashboard de Estudos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pocketbase/0.21.1/pocketbase.umd.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    </style>
</head>
<body class="bg-slate-50">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;
        const pb = new PocketBase('https://db.iarepositorio.site');
        
        // CÓDIGO DO ÍCONE BLINDADO CONTRA TELA BRANCA NO REACT
        const Icon = ({ name, size = 20, className = "" }) => {
            const spanRef = useRef(null);
            useEffect(() => {
                if (spanRef.current) {
                    spanRef.current.innerHTML = `<i data-lucide="${name}" class="${className}" style="width:${size}px; height:${size}px"></i>`;
                    lucide.createIcons();
                }
            }, [name, className, size]);
            return <span ref={spanRef} style={{ display: 'contents' }}></span>;
        };

        const DEFAULT_TOPICS = {
          penal: {
            fundamentos: ["Teoria Geral: Aplicação da Lei Penal", "Teoria Geral: Teoria Geral do Crime", "Teoria Geral: Conduta (ação e omissão)", "Teoria Geral: Nexo Causal", "Teoria Geral: Tipicidade", "Teoria Geral: Antijuridicidade e Excludentes", "Teoria Geral: Culpabilidade", "Teoria Geral: Erro de Tipo e Erro de Proibição", "Teoria Geral: Inimputabilidade", "Teoria Geral: Princípio da Insignificância"],
            concurso_e_iter: ["Teoria Geral: Concurso de Pessoas", "Teoria Geral: Teorias de Autoria", "Teoria Geral: Iter Criminis", "Teoria Geral: Tentativa", "Teoria Geral: Desistência Voluntária e Arrependimento eficaz", "Teoria Geral: Arrependimento Posterior"],
            pena_e_prescricao: ["Penas: Teoria da Pena", "Penas: Espécies de Penas", "Penas: Regimes e Substituição", "Penas: Concurso de Crimes", "Penas: Prescrição"],
            pessoa: ["Crimes contra a Pessoa: Homicídio", "Crimes contra a Pessoa: Lesões Corporais", "Crimes contra a Pessoa: Crimes contra a Honra", "Crimes contra a Pessoa: Aborto", "Crimes contra a Pessoa: Omissão de Socorro"],
            patrimonio: ["Crimes contra o Patrimônio: Furto", "Crimes contra o Patrimônio: Roubo", "Crimes contra o Patrimônio: Extorsão", "Crimes contra o Patrimônio: Estelionato", "Crimes contra o Patrimônio: Receptação", "Crimes contra o Patrimônio: Dano"],
            dignidade: ["Crimes contra a Dignidade Sexual: Estupro", "Crimes contra a Dignidade Sexual: Assédio Sexual"],
            administracao: ["Crimes contra a Administração: Peculato", "Crimes contra a Administração: Corrupção Passiva", "Crimes contra a Administração: Concussão", "Crimes contra a Administração: Prevaricação", "Crimes contra a Administração: Resistência e Desobediência"]
          },
          'proc-penal': { geral: ["Inquérito Policial", "Notitia Criminis", "Instauração do Inquérito", "Relatório e Arquivamento", "BO, TCO e IP", "Ação Penal", "Decadência e Perempção", "Pedido de Explicações", "Competência", "Conexão e Continência", "Provas", "Motivação per relationem", "Prisões", "Medidas Cautelares", "Liberdade Provisória", "Procedimento Comum", "Ritos Processuais", "Fases do Processo", "Nulidades", "Incidente de Insanidade Mental", "Recursos", "Juiz das Garantias", "ANPP e Justiça Penal Consensual"] },
          const: { geral: ["Direitos Fundamentais", "Direitos dos Presos", "Mandados de Criminalização", "Dignidade da Pessoa Humana", "Organização do Estado", "Competências Federativas", "Segurança Pública", "Processo Legislativo", "Controle de Constitucionalidade", "Controle por Omissão", "Poder Constituinte", "Imunidades Parlamentares", "Crime de Responsabilidade", "Intervenção Federal", "Competências STF e STJ"] },
          adm: { geral: ["Atos Administrativos", "Anulação e Revogação", "Controle Judicial", "Agentes Públicos", "Regime Jurídico", "Estabilidade", "Provimento e Vacância", "Direitos e Vantagens", "Responsabilidade Civil do Estado", "Risco Administrativo", "Organização Administrativa", "Administração Direta e Indireta", "Autarquias", "Licitações", "Lei 14.133", "Improbidade Administrativa", "Poder Hierárquico", "Poder Disciplinar", "Poder de Polícia", "Serviços Públicos", "Concessões", "Empresas Estatais", "PAD", "Nepotismo"] },
          'leg-especial': { geral: ["Lei Maria da Penha", "Medidas Protetivas", "Lei de Drogas", "Tráfico e Uso", "Lei de Organizações Criminosas", "Colaboração Premiada", "Infiltração de Agentes", "Lei de Abuso de Autoridade", "Pacote Anticrime", "Cadeia de Custódia", "ANPP", "Prisão Temporária", "Estatuto do Desarmamento", "Crimes Ambientais", "Interceptação Telefônica", "Juizados Especiais Criminais", "Lavagem de Dinheiro", "Crimes Tributários", "Lei de Racismo", "Embriaguez ao Volante"] },
          civil: { geral: ["LINDB", "Pessoas", "Capacidade Civil", "Emancipação", "Bens", "Classificação de Bens", "Posse", "Propriedade", "Desforço Imediato", "Fatos Jurídicos", "Negócio Jurídico", "Autonomia da Vontade", "Disposição do Corpo"] },
          dh: { geral: ["Teoria Geral dos Direitos Humanos", "Declaração Universal", "Pactos Internacionais", "Convenção contra a Tortura", "Princípios Estruturantes", "Status dos Tratados", "Sistema Interamericano", "Responsabilidade Internacional do Estado"] },
          crim: { geral: ["Escolas Criminológicas", "Escola Clássica", "Escola Positivista", "Teorias Sociológicas", "Anomia", "Subculturas Criminais", "Técnicas de Neutralização", "Labelling Approach", "Direito Penal do Inimigo", "Janelas Quebradas", "Atuarialismo", "Discursos Punitivos", "Vitimologia", "Prevenção Criminal"] },
          med: { geral: ["Medicina Legal — Conceito", "Perícia e Laudos", "Tanatologia", "Sinais Cadavéricos", "Estimativa do Tempo de Morte", "Traumatologia", "Lesões Corporais", "Balística Médico-Legal", "Docimásias", "Identificação Humana", "Dactiloscopia"] },
          inf: { geral: ["Sistemas Operativos", "Linux (Ubuntu)", "Gestão de Arquivos", "Redes", "SMB e Compartilhamento", "LibreOffice Writer", "LibreOffice Calc", "Funções Básicas", "Navegadores", "Navegação Privada", "Segurança Básica"] }
        };

        const INITIAL_SUBJECTS = [
          { id: 'penal', name: 'Direito Penal', weight: 15, notes: '', logs: [], history: [], customTopics: [] },
          { id: 'proc-penal', name: 'Direito Processual Penal', weight: 15, notes: '', logs: [], history: [], customTopics: [] },
          { id: 'const', name: 'Constitucional', weight: 15, notes: '', logs: [], history: [], customTopics: [] },
          { id: 'adm', name: 'Administrativo', weight: 15, notes: '', logs: [], history: [], customTopics: [] },
          { id: 'leg-especial', name: 'Legislação Especial', weight: 15, notes: '', logs: [], history: [], customTopics: [] },
          { id: 'civil', name: 'Civil', weight: 5, notes: '', logs: [], history: [], customTopics: [] },
          { id: 'dh', name: 'Direitos Humanos', weight: 5, notes: '', logs: [], history: [], customTopics: [] },
          { id: 'crim', name: 'Criminologia', weight: 5, notes: '', logs: [], history: [], customTopics: [] },
          { id: 'med', name: 'Medicina Legal', weight: 5, notes: '', logs: [], history: [], customTopics: [] },
          { id: 'inf', name: 'Informática', weight: 5, notes: '', logs: [], history: [], customTopics: [] }
        ];

        // FUNÇÃO ESCUDO
        const getSafeId = (item) => {
            if (item === null || item === undefined) return null;
            if (typeof item === 'object') return String(item.id || item.value || '');
            return String(item);
        };

        function App() {
          const [subjects, setSubjects] = useState(INITIAL_SUBJECTS);
          const [availableTime, setAvailableTime] = useState(100);
          const [cycleSequence, setCycleSequence] = useState([]);
          const [currentCycleIndex, setCurrentCycleIndex] = useState(0);

          const [activeTab, setActiveTab] = useState('geral');
          const [selectedSubId, setSelectedSubId] = useState(null);
          const [activeModal, setActiveModal] = useState(null);
          const [showFutureRevisions, setShowFutureRevisions] = useState(false);
          const [revFilterType, setRevFilterType] = useState('all');
          const [isAddingTopic, setIsAddingTopic] = useState(false);
          const [newTopicName, setNewTopicName] = useState('');
          const [logToDeleteId, setLogToDeleteId] = useState(null);
          const [confirmModalData, setConfirmModalData] = useState(null);
          const [revForms, setRevForms] = useState({});
          const [form, setForm] = useState({ topic: '', time: 0, q: 0, h: 0, nextRev: '', isRevision: false, nextRevType: 'completa', studyDate: new Date().toISOString().split('T')[0] });

          // CARREGAMENTO DEFENSIVO
          useEffect(() => {
            async function loadData() {
              try {
                const record = await pb.collection('estudos').getFirstListItem('');
                if (record) {
                  if (record.subjects && Array.isArray(record.subjects)) setSubjects(record.subjects);
                  if (record.availableTime) setAvailableTime(Number(record.availableTime) || 100);
                  if (record.cycleSequence && Array.isArray(record.cycleSequence)) {
                      const safeCycle = record.cycleSequence.map(item => getSafeId(item)).filter(Boolean);
                      setCycleSequence(safeCycle);
                  }
                  if (record.currentCycleIndex !== undefined) setCurrentCycleIndex(Number(record.currentCycleIndex) || 0);
                }
              } catch (e) { console.log("Sem dados na VPS ainda."); }
            }
            loadData();
          }, []);

          useEffect(() => {
            const saveData = async () => {
              try {
                const data = { subjects, availableTime, cycleSequence, currentCycleIndex };
                let record;
                try {
                  record = await pb.collection('estudos').getFirstListItem('');
                } catch (err) {}

                if (record && record.id) {
                  await pb.collection('estudos').update(record.id, data);
                } else {
                  await pb.collection('estudos').create(data);
                }
              } catch (e) {
                console.error("Erro crítico ao sincronizar:", e);
              }
            };
            const timer = setTimeout(saveData, 800);
            return () => clearTimeout(timer);
          }, [subjects, availableTime, cycleSequence, currentCycleIndex]);

          useEffect(() => {
            try {
              localStorage.setItem('pcpr_study_v27_data', JSON.stringify(subjects));
              localStorage.setItem('pcpr_study_v27_meta', availableTime.toString());
              localStorage.setItem('pcpr_study_v27_cycle', JSON.stringify(cycleSequence));
              localStorage.setItem('pcpr_study_v27_idx', currentCycleIndex.toString());
            } catch (e) { console.error("Erro ao guardar"); }
          }, [subjects, availableTime, cycleSequence, currentCycleIndex]);

          const flattenTopics = (subjectId) => {
            const data = DEFAULT_TOPICS[subjectId];
            if (!data) return [];
            if (Array.isArray(data)) return data;
            return Object.values(data).flat();
          };

          const stats = useMemo(() => {
            let qTotal = 0, hTotal = 0, totalHoursStudied = 0;
            (subjects || []).forEach(s => {
              (s.logs || []).forEach(l => {
                qTotal += (Number(l.q) || 0); hTotal += (Number(l.h) || 0); totalHoursStudied += ((Number(l.time) || 0) / 60);
              });
            });
            const weightSum = (subjects || []).reduce((acc, s) => acc + (Number(s.weight) || 0), 0);
            return { accuracy: qTotal > 0 ? (hTotal / qTotal) * 100 : 0, totalHoursStudied, weightSum, hTotal, qTotal };
          }, [subjects]);

          const metrics = useMemo(() => {
            return (subjects || []).map(s => {
              const sSuggested = stats.weightSum > 0 ? (Number(s.weight || 0) / stats.weightSum) * availableTime : 0;
              const q = (s.logs || []).reduce((acc, l) => acc + (Number(l.q) || 0), 0);
              const h = (s.logs || []).reduce((acc, l) => acc + (Number(l.h) || 0), 0);
              const totalStudyHours = (s.logs || []).reduce((acc, l) => acc + (Number(l.time) || 0), 0) / 60;
              const timeRemaining = Math.max(0, sSuggested - totalStudyHours);
              const allTopics = [...flattenTopics(s.id), ...(s.customTopics || [])];
              const studiedTopics = new Set((s.logs || []).map(l => l.topic));
              const unstudiedCount = allTopics.filter(t => !studiedTopics.has(t)).length;

              return { ...s, suggested: sSuggested, perf: q > 0 ? Math.round((h/q)*100) : 0, totalQ: q, totalH: h, totalStudyHours, timeRemaining, unstudiedCount };
            });
          }, [subjects, stats.weightSum, availableTime]);

          const revisionList = useMemo(() => {
            const list = [];
            const today = new Date(); today.setHours(0, 0, 0, 0);

            (subjects || []).forEach(s => {
              const latestPerTopic = {};
              (s.logs || []).forEach(l => {
                const dateStr = l.date || '';
                const logDate = dateStr.includes('/') ? new Date(dateStr.split('/').reverse().join('-')) : new Date();
                
                const existingDateStr = latestPerTopic[l.topic]?.date || '';
                const existingDate = existingDateStr.includes('/') ? new Date(existingDateStr.split('/').reverse().join('-')) : new Date(0);

                if (!latestPerTopic[l.topic] || logDate > existingDate) {
                  latestPerTopic[l.topic] = l;
                }
              });

              Object.values(latestPerTopic).forEach(l => {
                if (!l.nextRev) return;
                const [year, month, day] = l.nextRev.split('-').map(Number);
                const nextRevDate = new Date(year, month - 1, day);
                const diffDays = Math.ceil((nextRevDate.getTime() - today.getTime()) / (1000 * 60 * 60 * 24));
                const matchesType = revFilterType === 'all' || l.nextRevType === revFilterType;

                if ((showFutureRevisions || diffDays <= 0) && matchesType) {
                  list.push({ ...l, subjectId: s.id, subjectName: s.name, daysLeft: diffDays });
                }
              });
            });
            return list.sort((a, b) => a.daysLeft - b.daysLeft);
          }, [subjects, showFutureRevisions, revFilterType]);

          const topicStats = useMemo(() => {
            if (!selectedSubId) return [];
            const sub = (subjects || []).find(s => s.id === selectedSubId);
            if (!sub) return [];
            const allTopicNames = [...flattenTopics(selectedSubId), ...(sub.customTopics || [])];
            const statsMap = {};
            allTopicNames.forEach(t => { statsMap[String(t)] = { topic: String(t), time: 0, q: 0, h: 0 }; });

            (sub.logs || []).forEach(log => {
              if (statsMap[String(log.topic)]) {
                statsMap[String(log.topic)].time += Number(log.time) || 0;
                statsMap[String(log.topic)].q += Number(log.q) || 0;
                statsMap[String(log.topic)].h += Number(log.h) || 0;
              }
            });
            return Object.values(statsMap).sort((a, b) => String(a.topic).localeCompare(String(b.topic)));
          }, [subjects, selectedSubId]);

          const handleAddSubject = (name) => {
            if (!name?.trim()) return;
            const newId = `custom-${Date.now()}`;
            setSubjects([...(subjects || []), { id: newId, name: name.trim(), weight: 5, notes: '', logs: [], history: [], customTopics: [] }]);
            setActiveModal(null);
          };

          const handleReset = () => {
            try {
              // Recupera todas as disciplinas padrões limpas
              setSubjects(JSON.parse(JSON.stringify(INITIAL_SUBJECTS)));
              setAvailableTime(100); 
              setCycleSequence([]); 
              setCurrentCycleIndex(0); 
              setActiveModal(null); 
              setActiveTab('geral');
            } catch (e) {
              console.error("Erro ao zerar dados:", e);
            }
          };

          const handleDeleteSubject = (id) => {
            setSubjects((subjects || []).filter(s => String(s.id) !== String(id))); 
            setCycleSequence((cycleSequence || []).filter(sid => getSafeId(sid) !== String(id)));
            if (String(selectedSubId) === String(id)) setSelectedSubId(null);
          };

          const updateSubject = (id, field, value) => {
            setSubjects((subjects || []).map(s => s.id === id ? { ...s, [field]: value } : s));
          };

          const handleDeleteLog = (subjectId, logId) => {
            setSubjects(prev => prev.map(s => {
              if (s.id === subjectId) return { ...s, logs: (s.logs || []).filter(l => l.id !== logId) }; return s;
            }));
            setLogToDeleteId(null);
          };

          const handleSaveTopic = () => {
            if (!newTopicName?.trim()) { setIsAddingTopic(false); return; }
            setSubjects(prev => prev.map(s => {
              if (s.id === selectedSubId) return { ...s, customTopics: [...(s.customTopics || []), newTopicName.trim()] }; return s;
            }));
            setNewTopicName(''); setIsAddingTopic(false);
          };

          const handleRemoveTopic = () => {
            if (!form.topic) return;
            if (flattenTopics(selectedSubId).includes(form.topic)) return;
            setSubjects(prev => prev.map(s => {
              if (s.id === selectedSubId) return { ...s, customTopics: (s.customTopics || []).filter(t => t !== form.topic) }; return s;
            }));
            setForm({ ...form, topic: '' });
          };

          const moveCycleItem = (index, direction) => {
            const newSeq = [...(cycleSequence || [])]; 
            const target = index + direction;
            if (target < 0 || target >= newSeq.length) return;
            
            const temp = newSeq[index];
            newSeq[index] = newSeq[target];
            newSeq[target] = temp;
            
            setCycleSequence(newSeq);
          };

          const registerSession = (id, sessionData = null, bypass = false) => {
            const finalData = sessionData || form;
            
            if (!finalData || !finalData.topic) return; 

            const isMissingData = !finalData.time || !finalData.nextRev || (!finalData.q && finalData.q !== 0);
            if (!bypass && isMissingData) { 
              setConfirmModalData({ id, sessionData }); 
              return; 
            }

            setSubjects(prev => (prev || []).map(s => {
              if (s.id === id) {
                const dateStr = finalData.studyDate || new Date().toISOString().split('T')[0];
                const studyDateObj = new Date(dateStr + 'T12:00:00');
                
                const newLog = {
                  id: Date.now(), 
                  topic: finalData.topic, 
                  time: Number(finalData.time) || 0, 
                  q: Number(finalData.q) || 0,
                  h: Number(finalData.h) || 0, 
                  isRevision: !!finalData.isRevision, 
                  nextRevType: finalData.nextRevType || 'completa',
                  timestamp: Date.now(), 
                  date: studyDateObj.toLocaleDateString('pt-BR') || '01/01/2026', 
                  nextRev: finalData.nextRev || ''
                };
                
                const accuracy = newLog.q > 0 ? (newLog.h / newLog.q) * 100 : 0;
                return { 
                  ...s, 
                  logs: [newLog, ...(s.logs || [])], 
                  history: [...(s.history || []), { 
                      date: newLog.date, 
                      accuracy: Math.round(accuracy), 
                      topic: newLog.topic 
                  }].slice(-30) 
                };
              }
              return s;
            }));

            // Lógica estabilizada de avanço do ciclo
            const safeCycle = cycleSequence || [];
            const safeIndex = Number(currentCycleIndex) || 0;
            const actualSid = getSafeId(safeCycle[safeIndex]);

            if (actualSid && actualSid === String(id) && safeCycle.length > 0) {
              setCurrentCycleIndex((safeIndex + 1) % safeCycle.length);
            }
            
            if (!sessionData) {
              setForm({ 
                topic: '', time: 0, q: 0, h: 0, nextRev: '', 
                isRevision: false, nextRevType: 'completa', 
                studyDate: new Date().toISOString().split('T')[0] 
              });
            }
            setConfirmModalData(null);
          };

          const updateRevQuickForm = (revId, field, value) => {
            setRevForms(prev => ({ ...prev, [revId]: { ...(prev[revId] || { time: 0, q: 0, h: 0, nextRev: '', nextRevType: 'completa' }), [field]: value } }));
          };

          const handleQuickRevisionSave = (rev) => {
            const data = revForms[rev.id]; if (!data) return;
            registerSession(rev.subjectId, { topic: rev.topic, time: data.time || 0, q: data.q || 0, h: data.h || 0, isRevision: true, nextRev: data.nextRev || '', nextRevType: data.nextRevType || 'completa', studyDate: new Date().toISOString().split('T')[0] });
            setRevForms(prev => { const next = {...prev}; delete next[rev.id]; return next; });
          };

          const backupData = () => {
            const data = { subjects, availableTime, cycleSequence, currentCycleIndex, exportDate: new Date().toISOString() };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a'); link.href = url; link.download = `backup_pcpr_v27.json`; link.click();
            URL.revokeObjectURL(url);
          };

          const currentSubject = (subjects || []).find(s => String(s.id) === String(selectedSubId));
          
          // Verificação segura da matéria ativa do ciclo
          const safeCycleArr = cycleSequence || [];
          const safeCurrentIdx = Number(currentCycleIndex) || 0;
          const cycleActiveId = getSafeId(safeCycleArr[safeCurrentIdx]);
          const isCurrentCycleSubject = cycleActiveId === String(selectedSubId);

          return (
            <div className="min-h-screen bg-slate-50 text-slate-900 flex flex-col md:flex-row font-sans relative overflow-x-hidden">
              {activeModal === 'add' && (
                <div className="fixed inset-0 z-[100] flex items-center justify-center bg-slate-950/60 backdrop-blur-sm p-4">
                  <div className="bg-white rounded-[32px] p-10 w-full max-w-md shadow-2xl animate-in zoom-in duration-200">
                    <h3 className="text-2xl font-black uppercase tracking-tighter mb-6">Nova Disciplina</h3>
                    <input autoFocus type="text" id="subInput" placeholder="Ex: Medicina Legal" className="w-full bg-slate-100 p-5 rounded-2xl text-sm font-bold border-none outline-none focus:ring-2 ring-blue-500 mb-8" onKeyDown={(e) => { if(e.key === 'Enter') handleAddSubject(e.target.value); }} />
                    <div className="flex gap-4">
                      <button onClick={() => handleAddSubject(document.getElementById('subInput').value)} className="flex-1 bg-blue-600 text-white py-4 rounded-2xl font-black uppercase tracking-widest text-xs shadow-lg shadow-blue-500/20 cursor-pointer">Adicionar</button>
                      <button onClick={() => setActiveModal(null)} className="flex-1 bg-slate-100 text-slate-500 py-4 rounded-2xl font-black uppercase tracking-widest text-xs cursor-pointer">Cancelar</button>
                    </div>
                  </div>
                </div>
              )}

              {activeModal === 'reset' && (
                <div className="fixed inset-0 z-[100] flex items-center justify-center bg-slate-950/60 backdrop-blur-sm p-4">
                  <div className="bg-white rounded-[32px] p-10 w-full max-w-md shadow-2xl animate-in zoom-in duration-200">
                    <div className="bg-red-50 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-6"><Icon name="alert-triangle" className="text-red-600" size={40} /></div>
                    <h3 className="text-2xl font-black uppercase tracking-tighter mb-4 text-center">Zerar Tudo?</h3>
                    <p className="text-slate-500 text-center mb-10 font-medium text-sm leading-relaxed">Esta ação aplicará um Hard Reset, apagando o histórico e restaurando as disciplinas originais.</p>
                    <div className="flex gap-4">
                      <button onClick={handleReset} className="flex-1 bg-red-600 text-white py-4 rounded-2xl font-black uppercase tracking-widest text-xs shadow-lg shadow-red-500/20 cursor-pointer">Sim, Limpar</button>
                      <button onClick={() => setActiveModal(null)} className="flex-1 bg-slate-100 text-slate-500 py-4 rounded-2xl font-black uppercase tracking-widest text-xs cursor-pointer">Manter Dados</button>
                    </div>
                  </div>
                </div>
              )}

              {confirmModalData && (
                <div className="fixed inset-0 z-[110] flex items-center justify-center bg-slate-950/60 backdrop-blur-sm p-4">
                  <div className="bg-white rounded-[32px] p-10 w-full max-w-md shadow-2xl animate-in zoom-in duration-200 text-center">
                    <div className="bg-amber-50 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-4"><Icon name="info" className="text-amber-600" size={40} /></div>
                    <h3 className="text-2xl font-black uppercase tracking-tighter mb-4">Dados Incompletos</h3>
                    <p className="text-slate-500 mb-10 font-medium text-sm leading-relaxed">Alguns campos de tempo, questões ou revisão estão vazios. Deseja registrar mesmo assim?</p>
                    <div className="flex gap-4">
                      <button onClick={() => registerSession(confirmModalData.id, confirmModalData.sessionData, true)} className="flex-1 bg-blue-600 text-white py-4 rounded-2xl font-black uppercase tracking-widest text-xs shadow-lg shadow-blue-500/20 cursor-pointer">Sim, Registrar</button>
                      <button onClick={() => setConfirmModalData(null)} className="flex-1 bg-slate-100 text-slate-500 py-4 rounded-2xl font-black uppercase tracking-widest text-xs cursor-pointer">Voltar</button>
                    </div>
                  </div>
                </div>
              )}

              <aside className="fixed bottom-0 left-0 w-full bg-white border-t border-slate-200 flex flex-row justify-around items-center z-50 h-20 md:static md:w-72 md:h-screen md:flex-col md:justify-start md:border-t-0 md:border-r md:shrink-0 overflow-y-auto shadow-[0_-10px_40px_rgba(0,0,0,0.05)] md:shadow-none">
                  <div className="hidden md:flex p-8 border-b border-slate-100 items-center gap-4 w-full">
                      <div className="bg-blue-600 p-2.5 rounded-xl text-white shadow-lg"><Icon name="target" size={24} /></div>
                      <div><h1 className="font-black text-xl text-blue-600 uppercase leading-none tracking-tighter">PCPR Pro</h1><p className="text-[10px] font-bold text-slate-400 uppercase tracking-widest mt-1">Delegado V27</p></div>
                  </div>
                  <nav className="flex flex-row md:flex-col p-2 md:p-4 gap-2 md:space-y-2 w-full justify-around md:justify-start">
                      <button onClick={() => setActiveTab('geral')} className={`flex flex-col md:flex-row items-center gap-1 md:gap-3 p-2 md:px-5 md:py-4 rounded-2xl transition-all cursor-pointer ${activeTab === 'geral' ? 'text-blue-600 md:bg-blue-600 md:text-white md:shadow-xl font-bold' : 'text-slate-500 hover:bg-slate-50'}`}><Icon name="layout-dashboard" size={24} className="md:w-5 md:h-5" /> <span className="text-[10px] md:text-sm font-bold uppercase md:capitalize md:tracking-normal tracking-widest mt-1 md:mt-0">Painel</span></button>
                      
                      <button onClick={() => setActiveTab('revisoes')} className={`flex flex-col md:flex-row items-center gap-1 md:gap-3 p-2 md:px-5 md:py-4 rounded-2xl transition-all cursor-pointer relative ${activeTab === 'revisoes' ? 'text-amber-500 md:bg-amber-500 md:text-white md:shadow-xl font-bold' : 'text-slate-500 hover:bg-slate-50'}`}>
                          <Icon name="clock" size={24} className="md:w-5 md:h-5" /> <span className="text-[10px] md:text-sm font-bold uppercase md:capitalize md:tracking-normal tracking-widest mt-1 md:mt-0">Revisões</span>
                          {revisionList.filter(r => r.daysLeft <= 0).length > 0 && <span className="absolute top-1 right-2 md:static md:ml-auto bg-red-500 text-white text-[10px] px-2 py-0.5 rounded-full font-black animate-pulse">{revisionList.filter(r => r.daysLeft <= 0).length}</span>}
                      </button>

                      <div className="hidden md:block pt-6 pb-2 px-5 text-[10px] font-black text-slate-400 uppercase tracking-widest">Suas Disciplinas</div>
                      {(subjects || []).map(s => (
                          <button key={s.id} onClick={() => { setSelectedSubId(s.id); setActiveTab('materia'); }} className={`hidden md:flex w-full text-left px-5 py-3 rounded-xl text-xs font-bold transition-all items-center justify-between cursor-pointer ${selectedSubId === s.id && activeTab === 'materia' ? 'bg-blue-50 text-blue-700 border-l-4 border-blue-600' : 'text-slate-500 hover:bg-slate-50 border-l-4 border-transparent'}`}>
                              <span className="truncate pr-2">{String(s.name)}</span>{cycleActiveId === String(s.id) && <Icon name="zap" size={12} className="text-amber-500" />}
                          </button>
                      ))}
                  </nav>
              </aside>

              <main className="flex-1 p-6 md:p-12 overflow-y-auto bg-slate-50 pb-28 md:pb-12">
                {activeTab === 'geral' && (
                  <div className="max-w-6xl mx-auto space-y-12 animate-in fade-in duration-500">
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-8">
                      <div className="bg-blue-600 p-8 rounded-[40px] text-white shadow-2xl shadow-blue-500/20 relative overflow-hidden group min-h-[180px]">
                        <Icon name="history" className="absolute -right-6 -bottom-6 opacity-10 group-hover:scale-110 transition-transform z-0" size={160} />
                        <div className="relative z-10 h-full flex flex-col justify-center text-center md:text-left">
                          <p className="text-[10px] font-black uppercase tracking-widest opacity-60">Meta Total (Edital)</p>
                          <div className="flex items-center justify-center md:justify-start gap-4 mt-6">
                            <div className="flex items-baseline gap-1"><input type="number" value={availableTime || ''} onChange={e => setAvailableTime(Number(e.target.value))} className="bg-transparent text-5xl font-black w-32 text-center md:text-left outline-none border-b-2 border-blue-400/50 focus:border-white transition-colors" placeholder="0" /><span className="text-xl font-bold opacity-60 italic">h</span></div>
                          </div>
                        </div>
                      </div>
                      <div className="bg-white p-8 rounded-[40px] border border-slate-200 shadow-sm flex flex-col justify-between">
                        <div><p className="text-[10px] font-black text-slate-400 uppercase tracking-widest">Total Estudado</p><p className="text-5xl font-black mt-2 text-slate-800">{stats.totalHoursStudied.toFixed(1)}h</p></div>
                        <div className="w-full h-2.5 bg-slate-100 rounded-full mt-6 overflow-hidden"><div className="h-full bg-blue-500 transition-all duration-1000" style={{ width: `${Math.min((stats.totalHoursStudied / (availableTime || 1)) * 100, 100)}%` }} /></div>
                      </div>
                      <div className="bg-white p-8 rounded-[40px] border border-slate-200 shadow-sm flex flex-col justify-center text-center">
                        <p className="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">Aproveitamento Global</p><p className="text-5xl font-black text-green-600 tracking-tighter">{Math.round(stats.accuracy)}%</p><p className="text-[10px] font-bold text-slate-400 mt-3 uppercase tracking-widest">{stats.hTotal} / {stats.qTotal} questões</p>
                      </div>
                    </div>

                    <section className="bg-white p-10 rounded-[40px] border border-slate-200 shadow-sm">
                      <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-6 mb-12">
                        <div className="space-y-1"><h3 className="text-3xl font-black uppercase tracking-tighter flex items-center gap-3"><Icon name="refresh-cw" size={28} className="text-blue-600" /> Sequenciador do Ciclo</h3><p className="text-sm text-slate-400 font-bold uppercase tracking-widest">Sua fila estratégica de estudos</p></div>
                        <select className="bg-slate-100 p-5 rounded-2xl text-xs font-black uppercase outline-none focus:ring-2 ring-blue-500 w-full md:w-auto min-w-[200px]" onChange={e => { if(e.target.value) { setCycleSequence([...(cycleSequence || []), e.target.value]); e.target.value=""; } }}>
                          <option value="">+ Incluir na Fila</option>{(subjects || []).map(s => <option key={s.id} value={s.id}>{String(s.name)}</option>)}
                        </select>
                      </div>
                      <div className="flex flex-wrap gap-6">
                        {(cycleSequence || []).map((sid, idx) => {
                          const actualSid = getSafeId(sid);
                          if (!actualSid) return null;
                          
                          const sub = (subjects || []).find(s => String(s.id) === actualSid);
                          const active = Number(currentCycleIndex) === idx;
                          const mData = (metrics || []).find(m => String(m.id) === actualSid);
                          
                          if (!sub) return null; 
                          
                          const safePerc = (mData && mData.suggested > 0) ? Math.min(((mData.totalStudyHours || 0) / mData.suggested) * 100, 100) : 0;

                          return (
                            <div key={`${actualSid}-${idx}`} className={`relative flex items-center gap-6 p-7 rounded-[32px] border transition-all flex-1 min-w-[260px] max-w-[320px] ${active ? 'bg-gradient-to-br from-blue-600 to-indigo-800 border-blue-400 text-white shadow-2xl scale-105' : 'bg-white border-slate-100'}`}>
                              <div className="flex flex-col gap-2 opacity-60"><button onClick={() => moveCycleItem(idx, -1)} className="p-1 hover:bg-white/20 rounded cursor-pointer"><Icon name="arrow-up" size={14}/></button><button onClick={() => moveCycleItem(idx, 1)} className="p-1 hover:bg-white/20 rounded cursor-pointer"><Icon name="arrow-down" size={14}/></button></div>
                              <div className="flex-1 overflow-hidden">
                                <p className={`text-[9px] font-black uppercase mb-1.5 ${active ? 'text-blue-200' : 'text-slate-400'}`}>Etapa {idx + 1}</p>
                                <h4 className="text-base font-black truncate leading-tight mb-2">{String(sub.name || 'Desconhecida')}</h4>
                                <div className="w-full h-1.5 bg-slate-100/20 rounded-full overflow-hidden"><div className={`h-full ${active ? 'bg-white' : 'bg-blue-500'}`} style={{ width: `${safePerc}%` }} /></div>
                              </div>
                              <div className="flex gap-2">
                                <button onClick={() => { setSelectedSubId(actualSid); setActiveTab('materia'); }} className={`p-2.5 rounded-xl ${active ? 'bg-white/20 hover:bg-white/30' : 'bg-slate-50 text-slate-400 hover:text-blue-600'} cursor-pointer`}><Icon name="play-circle" size={22}/></button>
                                <button onClick={() => setCycleSequence((cycleSequence || []).filter((_, i) => i !== idx))} className={`p-2.5 ${active ? 'text-blue-200 hover:text-white' : 'text-slate-300 hover:text-red-500'} cursor-pointer`}><Icon name="x" size={22}/></button>
                              </div>
                            </div>
                          );
                        })}
                      </div>
                    </section>

                    <section className="bg-white p-10 rounded-[40px] border border-slate-200 shadow-sm overflow-hidden">
                      <h3 className="text-3xl font-black uppercase tracking-tighter mb-10 flex items-center gap-3"><Icon name="bar-chart-3" className="text-blue-600" size={28} /> Desempenho</h3>
                      <div className="overflow-x-auto">
                        <table className="w-full text-left min-w-[600px]">
                          <thead className="text-[10px] font-black text-slate-400 uppercase border-b border-slate-100">
                            <tr><th className="pb-6 pr-4">Disciplina</th><th className="pb-6 text-center">Aproveitamento</th><th className="pb-6 text-center">Meta Proporcional</th><th className="pb-6 text-center">Já Estudado</th><th className="pb-6 text-right">Tempo Pendente</th></tr>
                          </thead>
                          <tbody className="divide-y divide-slate-50">
                            {(metrics || []).map(m => (
                              <tr key={m.id} className="text-sm font-bold hover:bg-slate-50/50 transition-all group">
                                <td className="py-5 uppercase tracking-tighter text-slate-700 font-black pr-4">{String(m.name)}</td>
                                <td className="py-5 text-center"><div className="flex flex-col items-center"><span className={`px-3 py-1.5 rounded-xl text-[11px] font-black ${m.perf >= 80 ? 'bg-green-100 text-green-700' : 'bg-blue-50 text-blue-600'}`}>{m.perf}%</span><span className="text-[9px] text-slate-400 font-bold mt-1 uppercase tracking-widest">{m.totalH} / {m.totalQ}</span></div></td>
                                <td className="py-5 text-center text-blue-600/60 font-medium">{m.suggested.toFixed(1)}h</td>
                                <td className="py-5 text-center text-slate-800 font-black">{m.totalStudyHours.toFixed(1)}h</td>
                                <td className="py-5 text-right"><div className="flex flex-col items-end"><span className={`font-black tracking-tight ${m.timeRemaining > 0 ? 'text-amber-600' : 'text-green-600'}`}>{m.timeRemaining > 0 ? `${m.timeRemaining.toFixed(1)}h` : 'Concluído'}</span><span className="text-[9px] text-slate-400 uppercase tracking-widest font-black">{m.unstudiedCount} tópicos restantes</span></div></td>
                              </tr>
                            ))}
                          </tbody>
                        </table>
                      </div>
                    </section>

                    <section className="bg-white p-10 rounded-[40px] border border-slate-200 shadow-sm overflow-hidden">
                        <div className="flex flex-col md:flex-row justify-between items-center gap-6 mb-12">
                            <div className="flex items-center gap-3"><Icon name="settings" size={28} className="text-blue-600" /><div className="flex flex-col"><h3 className="text-2xl font-black uppercase tracking-tighter">Gestão do Plano</h3><span className="text-[10px] font-black text-slate-400 uppercase tracking-widest">Total do Edital: {stats.weightSum} questões</span></div></div>
                            <div className="flex flex-wrap gap-3 justify-center w-full md:w-auto">
                                <button onClick={() => setActiveModal('add')} className="w-full md:w-auto justify-center bg-blue-600 text-white px-7 py-3 rounded-2xl text-[11px] font-black uppercase tracking-widest flex items-center gap-2 hover:scale-105 transition-all cursor-pointer"><Icon name="plus" size={16} /> Adicionar Matéria</button>
                                <button onClick={backupData} className="flex-1 md:flex-none justify-center bg-slate-800 text-white px-7 py-3 rounded-2xl text-[11px] font-black uppercase tracking-widest flex items-center gap-2 hover:bg-slate-950 transition-all cursor-pointer"><Icon name="download" size={16} /> Backup .JSON</button>
                                <button onClick={() => setActiveModal('reset')} className="flex-1 md:flex-none justify-center bg-white text-red-600 border border-red-200 px-7 py-3 rounded-2xl text-[11px] font-black uppercase tracking-widest flex items-center gap-2 hover:bg-red-50 transition-all cursor-pointer"><Icon name="rotate-ccw" size={16} /> Zerar</button>
                            </div>
                        </div>
                        <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                            {(subjects || []).map(s => (
                                <div key={s.id} className="p-6 rounded-[32px] bg-slate-50 border border-slate-100 group transition-all hover:border-blue-200 relative">
                                    <div className="space-y-4">
                                        <div className="flex items-center gap-2"><Icon name="edit-3" size={14} className="text-slate-300" /><input type="text" value={s.name} onChange={(e) => updateSubject(s.id, 'name', e.target.value)} className="bg-transparent border-none text-xs font-black uppercase outline-none focus:text-blue-600 w-full tracking-tight" /></div>
                                        <div className="flex items-center justify-between pt-2 border-t border-slate-200/50"><div className="flex items-center gap-2"><span className="text-[10px] font-black text-slate-400 uppercase tracking-widest">Peso:</span><input type="number" value={s.weight} onChange={(e) => updateSubject(s.id, 'weight', Number(e.target.value))} className="w-14 bg-white border border-slate-200 rounded-lg p-1.5 text-center font-black text-xs text-blue-600 focus:ring-2 ring-blue-500 outline-none" /></div><button onClick={() => handleDeleteSubject(s.id)} className="p-2 text-slate-400 hover:text-red-500 cursor-pointer"><Icon name="trash-2" size={18}/></button></div>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </section>
                  </div>
                )}

                {activeTab === 'materia' && currentSubject && (
                  <div className="max-w-5xl mx-auto space-y-8 animate-in slide-in-from-right duration-300">
                    <header className="flex flex-col md:flex-row md:items-end justify-between gap-6 pb-6 border-b border-slate-200">
                      <div><button onClick={() => setActiveTab('geral')} className="text-[10px] font-black text-blue-600 uppercase tracking-widest mb-4 flex items-center gap-2 cursor-pointer"><Icon name="arrow-up" className="-rotate-90" size={14} /> Voltar ao Painel</button><h2 className="text-4xl md:text-6xl font-black uppercase tracking-tighter text-slate-800 leading-none">{String(currentSubject.name)}</h2></div>
                      {isCurrentCycleSubject && <div className="bg-blue-600 text-white px-6 py-3 rounded-2xl text-[10px] font-black uppercase tracking-widest animate-pulse flex items-center justify-center gap-2"><Icon name="zap" size={16}/> Estudo Ativo</div>}
                    </header>

                    <div className={`p-6 rounded-3xl border transition-all shadow-sm relative overflow-visible ${isCurrentCycleSubject ? 'bg-blue-50 border-blue-200' : 'bg-white border-slate-200'}`}>
                      <div className="flex flex-col md:flex-row md:items-center justify-between mb-4 gap-4">
                         <h3 className="text-[10px] font-black uppercase text-slate-400 tracking-widest flex items-center gap-2"><Icon name="plus" size={16}/> Registrar Estudo</h3>
                         <div className="flex items-center gap-2 relative z-50">
                            {isAddingTopic ? (
                              <div className="flex items-center gap-1 bg-white p-1 rounded-lg border border-blue-200 shadow-sm animate-in fade-in zoom-in w-full md:w-auto">
                                <input autoFocus type="text" placeholder="Novo assunto..." value={newTopicName} onChange={(e) => setNewTopicName(e.target.value)} className="text-[10px] font-bold px-2 py-2 outline-none w-full md:w-32" onKeyDown={(e) => e.key === 'Enter' && handleSaveTopic()}/>
                                <button onClick={handleSaveTopic} className="p-2 text-green-600 hover:bg-green-50 rounded cursor-pointer"><Icon name="save" size={14}/></button>
                                <button onClick={() => setIsAddingTopic(false)} className="p-2 text-red-400 hover:bg-red-50 rounded cursor-pointer"><Icon name="x" size={14}/></button>
                              </div>
                            ) : (
                              <><button onClick={() => setIsAddingTopic(true)} className="flex-1 md:flex-none justify-center flex p-3 md:p-2 bg-blue-100 text-blue-600 rounded-lg hover:bg-blue-600 hover:text-white transition-all cursor-pointer"><Icon name="plus" size={14}/></button><button onClick={handleRemoveTopic} className={`flex-1 md:flex-none justify-center flex p-3 md:p-2 rounded-lg transition-all cursor-pointer ${form.topic && !flattenTopics(selectedSubId).includes(form.topic) ? 'bg-red-50 text-red-500 hover:bg-red-500 hover:text-white' : 'bg-slate-100 text-slate-300'}`}><Icon name="trash-2" size={14}/></button></>
                            )}
                         </div>
                      </div>
                      <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <div className="space-y-1"><label className="text-[9px] font-black uppercase text-slate-500 ml-1 tracking-widest">Tópico</label>
                          <select value={form.topic} onChange={e => setForm({...form, topic: e.target.value})} className="w-full bg-white p-3 md:p-2.5 rounded-xl text-xs font-bold border border-slate-200 outline-none shadow-sm h-12 md:h-auto">
                            <option value="">Selecione o tema...</option>
                            {[...flattenTopics(currentSubject.id), ...(currentSubject.customTopics || [])].sort((a, b) => String(a).localeCompare(String(b))).map(t => <option key={t} value={t}>{String(t)}</option>)}
                          </select>
                        </div>
                        <div className="grid grid-cols-2 gap-3">
                            <div className="space-y-1"><label className="text-[9px] font-black uppercase text-slate-500 ml-1 tracking-widest">Data</label><input type="date" value={form.studyDate} onChange={e => setForm({...form, studyDate: e.target.value})} className="w-full bg-white p-3 md:p-2.5 rounded-xl text-xs font-bold border border-slate-200 outline-none shadow-sm h-12 md:h-auto" /></div>
                            <div className="space-y-1"><label className="text-[9px] font-black uppercase text-slate-500 ml-1 tracking-widest">Tempo (m)</label><input type="number" value={form.time} onChange={e => setForm({...form, time: e.target.value})} className="w-full bg-white p-3 md:p-2.5 rounded-xl text-xs font-bold border border-slate-200 outline-none shadow-sm h-12 md:h-auto text-center" /></div>
                        </div>
                        <div className="grid grid-cols-2 gap-3">
                          <div className="space-y-1"><label className="text-[9px] font-black uppercase text-slate-500 ml-1 tracking-widest">Questões</label><input type="number" value={form.q} onChange={e => setForm({...form, q: e.target.value})} className="w-full bg-white p-3 md:p-2.5 rounded-xl text-xs font-bold border border-slate-200 text-center outline-none shadow-sm h-12 md:h-auto" /></div>
                          <div className="space-y-1"><label className="text-[9px] font-black uppercase text-slate-500 ml-1 tracking-widest">Acertos</label><input type="number" value={form.h} onChange={e => setForm({...form, h: e.target.value})} className="w-full bg-white p-3 md:p-2.5 rounded-xl text-xs font-bold border border-slate-200 text-center outline-none shadow-sm h-12 md:h-auto" /></div>
                        </div>
                        <div className="flex gap-3">
                           <div className="flex-1 space-y-1"><label className="text-[9px] font-black uppercase text-slate-500 ml-1 tracking-widest">Próxima Revisão</label><input type="date" value={form.nextRev} onChange={e => setForm({...form, nextRev: e.target.value})} className="w-full bg-white p-3 md:p-2.5 rounded-xl text-xs font-bold border border-slate-200 outline-none shadow-sm h-12 md:h-auto" /></div>
                           <div className="w-24 md:w-32 space-y-1"><label className="text-[9px] font-black uppercase text-slate-500 ml-1 tracking-widest">Tipo</label>
                              <select value={form.nextRevType} onChange={e => setForm({...form, nextRevType: e.target.value})} className="w-full bg-white p-3 md:p-2.5 rounded-xl text-[10px] font-bold border border-slate-200 outline-none shadow-sm h-12 md:h-auto">
                                <option value="completa">Completa</option><option value="breve">Breve</option>
                              </select>
                           </div>
                        </div>
                      </div>
                      <button onClick={() => registerSession(currentSubject.id)} className="w-full bg-blue-600 text-white py-4 md:py-3.5 rounded-xl text-[10px] font-black uppercase tracking-widest shadow-lg shadow-blue-500/20 hover:bg-blue-700 transition-all mt-6 cursor-pointer">Confirmar e Atualizar Ciclo</button>
                    </div>

                    <div className="bg-white p-4 md:p-8 rounded-3xl border border-slate-200 shadow-sm overflow-hidden">
                       <div className="flex items-center gap-2 mb-8"><Icon name="bar-chart" size={18} className="text-blue-600" /><h3 className="text-[10px] font-black uppercase text-slate-400 tracking-widest">Desempenho de Assuntos</h3></div>
                       
                       <div className="overflow-x-auto pb-4">
                           <div className="min-w-[600px]">
                               <div className="grid grid-cols-12 gap-4 px-4 pb-4 border-b border-slate-100 text-[9px] font-black text-slate-400 uppercase tracking-widest mb-4"><div className="col-span-5">Assunto / Tópico</div><div className="col-span-2 text-center">Tempo</div><div className="col-span-2 text-center">Questões</div><div className="col-span-1 text-center">Acertos</div><div className="col-span-2 text-right">Aproveitamento</div></div>
                               <div className="space-y-1">
                                 {(topicStats || []).map((ts, idx) => {
                                   const perc = ts.q > 0 ? Math.round((ts.h / ts.q) * 100) : 0;
                                   const hasData = ts.q > 0 || ts.time > 0;
                                   return (
                                     <div key={idx} className={`grid grid-cols-12 items-center gap-4 px-4 py-3 rounded-xl border transition-all ${hasData ? 'bg-slate-50/50 border-slate-100 hover:border-blue-100 hover:bg-white' : 'bg-transparent border-transparent opacity-40'}`}>
                                       <div className="col-span-5"><span className="text-[10px] font-black uppercase text-slate-700 block truncate">{String(ts.topic)}</span></div>
                                       <div className="col-span-2 text-center"><span className="text-[10px] font-bold text-blue-600">{Number(ts.time)} <span className="text-[8px] opacity-60">min</span></span></div>
                                       <div className="col-span-2 text-center text-[10px] font-black text-slate-600">{Number(ts.q)}</div>
                                       <div className="col-span-1 text-center text-[10px] font-black text-green-600">{Number(ts.h)}</div>
                                       <div className="col-span-2 text-right"><span className={`text-[10px] font-black px-2.5 py-1 rounded-lg ring-1 ${ts.q === 0 ? 'bg-slate-100 text-slate-400 ring-slate-200' : perc >= 80 ? 'bg-green-100 text-green-700 ring-green-200' : 'bg-red-100 text-red-700 ring-red-200'}`}>{perc}%</span></div>
                                     </div>
                                   );
                                 })}
                               </div>
                           </div>
                       </div>
                    </div>

                    <div className="bg-white p-6 rounded-3xl border border-slate-200 shadow-sm flex flex-col h-[260px]">
                       <h3 className="text-[10px] font-black uppercase text-slate-400 tracking-widest mb-4 flex items-center gap-2"><Icon name="file-text" size={16}/> Observações</h3>
                       <textarea className="flex-1 bg-slate-50 border-none rounded-2xl p-6 text-xs outline-none resize-none font-medium leading-relaxed shadow-inner" placeholder="Jurisprudência, mnemónicos e pontos de atenção..." value={String(currentSubject.notes || '')} onChange={(e) => updateSubject(currentSubject.id, 'notes', e.target.value)} />
                    </div>

                    <div className="bg-white p-4 md:p-8 rounded-3xl border border-slate-200 shadow-sm min-h-[400px]">
                       <h3 className="text-[10px] font-black uppercase text-slate-400 tracking-widest mb-8 flex items-center gap-2"><Icon name="history" size={16}/> Registos Recentes</h3>
                       
                       <div className="overflow-x-auto pb-4">
                           <div className="min-w-[700px]">
                               <div className="grid grid-cols-12 gap-4 px-4 mb-4 text-[9px] font-black text-slate-400 uppercase tracking-widest"><div className="col-span-5">Tópico / Data</div><div className="col-span-2 text-center">Tempo</div><div className="col-span-2 text-center">Questões</div><div className="col-span-2 text-center">Desempenho</div><div className="col-span-1 text-right"></div></div>
                               <div className="space-y-3">
                                 {(currentSubject.logs || []).slice(0, 15).map(l => (
                                   <div key={l.id} className="grid grid-cols-12 items-center gap-4 p-4 bg-slate-50 rounded-2xl border border-slate-100 hover:bg-white hover:border-blue-200 transition-all">
                                     <div className="col-span-5 flex flex-col gap-1">
                                        <div className="flex items-center gap-2">
                                           <p className="text-[9px] font-black text-slate-400 uppercase">{String(l.date)}</p>
                                           {l.isRevision && <span className="text-[8px] bg-amber-500 text-white px-1.5 py-0.5 rounded font-black uppercase tracking-widest flex items-center gap-1"><Icon name="rotate-ccw" size={8}/> Revisão {l.nextRevType === 'breve' ? 'Breve' : 'Completa'}</span>}
                                        </div>
                                        <h4 className="text-[11px] font-black uppercase text-slate-700 truncate">{String(l.topic)}</h4>
                                     </div>
                                     <div className="col-span-2 text-center"><p className="text-[10px] font-black text-blue-600 uppercase">{Number(l.time)} min</p></div>
                                     <div className="col-span-2 text-center"><p className="text-[10px] font-black text-slate-700 leading-none">{Number(l.h)} / {Number(l.q)}</p></div>
                                     <div className="col-span-2 text-center"><span className={`inline-block px-3 py-1 rounded-xl text-[10px] font-black ${ (l.h/l.q) >= 0.8 ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`}>{l.q > 0 ? Math.round((l.h/l.q)*100) : 0}%</span></div>
                                     <div className="col-span-1 text-right flex justify-end">
                                       {logToDeleteId === l.id ? (<div className="flex gap-1"><button onClick={() => handleDeleteLog(currentSubject.id, l.id)} className="p-2 md:p-1 bg-red-600 text-white rounded cursor-pointer"><Icon name="check-circle" size={14}/></button><button onClick={() => setLogToDeleteId(null)} className="p-2 md:p-1 bg-slate-200 text-slate-600 rounded cursor-pointer"><Icon name="x" size={14}/></button></div>) : (<button onClick={() => setLogToDeleteId(l.id)} className="p-3 md:p-2 text-slate-300 hover:text-red-500 cursor-pointer"><Icon name="trash-2" size={18}/></button>)}
                                     </div>
                                   </div>
                                 ))}
                               </div>
                           </div>
                       </div>
                    </div>
                  </div>
                )}

                {activeTab === 'revisoes' && (
                  <div className="max-w-6xl mx-auto space-y-10 animate-in fade-in duration-500">
                    <header className="flex flex-col md:flex-row md:items-center justify-between gap-6 border-b border-slate-200 pb-10">
                      <h2 className="text-4xl md:text-5xl font-black uppercase tracking-tighter text-slate-800 text-center md:text-left">Pauta de Revisões</h2>
                      <div className="flex flex-wrap md:flex-nowrap items-center justify-center gap-4">
                        <select value={revFilterType} onChange={e => setRevFilterType(e.target.value)} className="w-full md:w-auto bg-white border border-slate-200 px-6 py-4 md:py-3 rounded-2xl text-[10px] font-black uppercase tracking-widest outline-none focus:ring-2 ring-blue-500 shadow-sm transition-all text-center">
                          <option value="all">Todos os Tipos</option><option value="completa">Completa</option><option value="breve">Breve</option>
                        </select>
                        <button onClick={() => setShowFutureRevisions(!showFutureRevisions)} className={`flex-1 md:flex-none px-6 py-4 md:py-3 rounded-2xl text-[10px] font-black uppercase tracking-widest transition-all cursor-pointer ${showFutureRevisions ? 'bg-blue-600 text-white shadow-lg' : 'bg-slate-200 text-slate-600'}`}>{showFutureRevisions ? 'Focar Vencidas' : 'Ver Tudo'}</button>
                        <div className="hidden md:flex bg-white px-6 py-3 rounded-full border border-slate-200 text-xs font-bold text-slate-500 items-center gap-2"><Icon name="calendar" size={16} /> {new Date().toLocaleDateString('pt-BR')}</div>
                      </div>
                    </header>
                    
                    <div className="flex flex-col gap-4">
                      {(revisionList || []).length === 0 && <div className="p-20 text-center bg-white rounded-[40px] border border-dashed border-slate-300 text-slate-400 font-bold uppercase tracking-widest shadow-sm">Nenhuma revisão pendente no momento</div>}
                      
                      {(revisionList || []).map(rev => (
                        <div key={rev.id} className="bg-white p-6 md:p-8 rounded-[40px] border border-slate-200 shadow-sm hover:shadow-xl transition-all group flex flex-col xl:flex-row xl:items-center gap-8 overflow-hidden">
                          
                          <div className="flex-1 min-w-0 w-full xl:min-w-[300px]">
                            <div className="flex items-center gap-3 mb-3 md:mb-2">
                               <span className={`text-[9px] font-black px-3 py-1 rounded-full uppercase tracking-widest ${rev.daysLeft <= 0 ? 'bg-red-500 text-white animate-pulse' : 'bg-blue-100 text-blue-600'}`}>{rev.daysLeft <= 0 ? 'Vencida' : `Em ${rev.daysLeft} dias`}</span>
                               <p className="text-[10px] font-black text-slate-400 uppercase tracking-widest">{String(rev.subjectName)}</p>
                               {rev.nextRevType === 'breve' && <span className="text-[9px] font-black text-amber-600 uppercase flex items-center gap-1 border border-amber-200 px-2 py-0.5 rounded-lg"><Icon name="activity" size={10}/> Breve</span>}
                            </div>
                            <h4 className="font-black text-2xl tracking-tighter leading-tight text-slate-800 whitespace-normal break-normal">
                              {String(rev.topic)}
                            </h4>
                          </div>

                          <div className="flex flex-wrap items-center gap-3 w-full xl:w-auto bg-slate-50 p-5 rounded-[32px] border border-slate-100">
                            <div className="flex-1 min-w-[70px] space-y-1"><label className="text-[8px] font-black uppercase text-slate-400 tracking-widest ml-1">Questões</label><input type="number" value={revForms[rev.id]?.q || ''} placeholder="0" onChange={(e) => updateRevQuickForm(rev.id, 'q', e.target.value)} className="w-full bg-white p-3 rounded-xl text-xs font-bold border border-slate-200 outline-none focus:ring-1 ring-blue-400 shadow-sm text-center h-12" /></div>
                            <div className="flex-1 min-w-[70px] space-y-1"><label className="text-[8px] font-black uppercase text-slate-400 tracking-widest ml-1">Acertos</label><input type="number" value={revForms[rev.id]?.h || ''} placeholder="0" onChange={(e) => updateRevQuickForm(rev.id, 'h', e.target.value)} className="w-full bg-white p-3 rounded-xl text-xs font-bold border border-slate-200 outline-none focus:ring-1 ring-blue-400 shadow-sm text-center h-12" /></div>
                            <div className="flex-1 min-w-[70px] space-y-1"><label className="text-[8px] font-black uppercase text-slate-400 tracking-widest ml-1">Tempo(m)</label><input type="number" value={revForms[rev.id]?.time || ''} placeholder="0" onChange={(e) => updateRevQuickForm(rev.id, 'time', e.target.value)} className="w-full bg-white p-3 rounded-xl text-xs font-bold border border-slate-200 outline-none focus:ring-1 ring-blue-400 shadow-sm text-center h-12" /></div>
                            <div className="flex-1 min-w-[110px] space-y-1"><label className="text-[8px] font-black uppercase text-slate-400 tracking-widest ml-1">Próx. Rev</label><input type="date" value={revForms[rev.id]?.nextRev || ''} onChange={(e) => updateRevQuickForm(rev.id, 'nextRev', e.target.value)} className="w-full bg-white p-3 rounded-xl text-[10px] font-bold border border-slate-200 outline-none focus:ring-1 ring-blue-400 shadow-sm h-12" /></div>
                            <div className="flex-1 min-w-[90px] space-y-1"><label className="text-[8px] font-black uppercase text-slate-400 tracking-widest ml-1">Tipo</label>
                              <select value={revForms[rev.id]?.nextRevType || 'completa'} onChange={(e) => updateRevQuickForm(rev.id, 'nextRevType', e.target.value)} className="w-full bg-white p-3 rounded-xl text-[10px] font-bold border border-slate-200 outline-none focus:ring-1 ring-blue-400 shadow-sm h-12">
                                <option value="completa">Completa</option><option value="breve">Breve</option>
                              </select>
                            </div>
                          </div>

                          <div className="flex gap-4 xl:gap-2 w-full xl:w-auto shrink-0 mt-2 xl:mt-0">
                            <button onClick={() => handleQuickRevisionSave(rev)} disabled={!revForms[rev.id]?.nextRev} className={`flex-1 xl:flex-none xl:w-48 py-4 rounded-[24px] text-[10px] font-black uppercase tracking-widest flex items-center justify-center gap-2 transition-all ${revForms[rev.id]?.nextRev ? 'bg-blue-600 text-white shadow-lg hover:scale-105 active:scale-95' : 'bg-slate-100 text-slate-300 cursor-not-allowed'}`}>
                              <Icon name="save" size={14}/> Salvar
                            </button>
                            <button onClick={() => { setSelectedSubId(rev.subjectId); setActiveTab('materia'); setForm({...form, topic: rev.topic, isRevision: true}); }} className="px-6 py-4 xl:p-4 bg-slate-900 text-white rounded-[24px] hover:bg-slate-800 transition-all hover:scale-105 active:scale-95 cursor-pointer shadow-lg flex items-center justify-center">
                              <Icon name="arrow-right-circle" size={22}/>
                            </button>
                          </div>
                        </div>
                      ))}
                    </div>
                  </div>
                )}
              </main>
            </div>
          );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
